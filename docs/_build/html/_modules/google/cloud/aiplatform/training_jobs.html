

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>google.cloud.aiplatform.training_jobs &#8212; google-cloud-aiplatform  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>

  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
          	<div class="admonition" id="python2-eol"> 
          	 As of January 1, 2020 this library no longer supports Python 2 on the latest released version. 
          	 Library versions released prior to that date will continue to be available. For more information please
          	 visit <a href="https://cloud.google.com/python/docs/python2-sunset/">Python 2 support on Google Cloud</a>.
          	</div>
            
  <h1>Source code for google.cloud.aiplatform.training_jobs</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># Copyright 2020 Google LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">abc</span>

<span class="kn">from</span> <span class="nn">google.auth</span> <span class="kn">import</span> <span class="n">credentials</span> <span class="k">as</span> <span class="n">auth_credentials</span>
<span class="kn">from</span> <span class="nn">google.cloud.aiplatform</span> <span class="kn">import</span> <span class="n">base</span>
<span class="kn">from</span> <span class="nn">google.cloud.aiplatform</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">google.cloud.aiplatform</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">from</span> <span class="nn">google.cloud.aiplatform</span> <span class="kn">import</span> <span class="n">initializer</span>
<span class="kn">from</span> <span class="nn">google.cloud.aiplatform</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">google.cloud.aiplatform</span> <span class="kn">import</span> <span class="n">schema</span>
<span class="kn">from</span> <span class="nn">google.cloud.aiplatform</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">google.cloud.aiplatform.utils</span> <span class="kn">import</span> <span class="n">console_utils</span>

<span class="kn">from</span> <span class="nn">google.cloud.aiplatform.compat.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">env_var</span> <span class="k">as</span> <span class="n">gca_env_var</span><span class="p">,</span>
    <span class="n">io</span> <span class="k">as</span> <span class="n">gca_io</span><span class="p">,</span>
    <span class="n">model</span> <span class="k">as</span> <span class="n">gca_model</span><span class="p">,</span>
    <span class="n">pipeline_state</span> <span class="k">as</span> <span class="n">gca_pipeline_state</span><span class="p">,</span>
    <span class="n">training_pipeline</span> <span class="k">as</span> <span class="n">gca_training_pipeline</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">google.cloud.aiplatform.utils</span> <span class="kn">import</span> <span class="n">_timestamped_gcs_dir</span>
<span class="kn">from</span> <span class="nn">google.cloud.aiplatform.utils</span> <span class="kn">import</span> <span class="n">source_utils</span>
<span class="kn">from</span> <span class="nn">google.cloud.aiplatform.utils</span> <span class="kn">import</span> <span class="n">worker_spec_utils</span>

<span class="kn">from</span> <span class="nn">google.cloud.aiplatform.v1.schema.trainingjob</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">definition_v1</span> <span class="k">as</span> <span class="n">training_job_inputs</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">google.rpc</span> <span class="kn">import</span> <span class="n">code_pb2</span>

<span class="kn">import</span> <span class="nn">proto</span>


<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">_PIPELINE_COMPLETE_STATES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">gca_pipeline_state</span><span class="o">.</span><span class="n">PipelineState</span><span class="o">.</span><span class="n">PIPELINE_STATE_SUCCEEDED</span><span class="p">,</span>
        <span class="n">gca_pipeline_state</span><span class="o">.</span><span class="n">PipelineState</span><span class="o">.</span><span class="n">PIPELINE_STATE_FAILED</span><span class="p">,</span>
        <span class="n">gca_pipeline_state</span><span class="o">.</span><span class="n">PipelineState</span><span class="o">.</span><span class="n">PIPELINE_STATE_CANCELLED</span><span class="p">,</span>
        <span class="n">gca_pipeline_state</span><span class="o">.</span><span class="n">PipelineState</span><span class="o">.</span><span class="n">PIPELINE_STATE_PAUSED</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">_TrainingJob</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">VertexAiResourceNounWithFutureManager</span><span class="p">):</span>

    <span class="n">client_class</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">PipelineClientWithOverride</span>
    <span class="n">_is_client_prediction_client</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_resource_noun</span> <span class="o">=</span> <span class="s2">&quot;trainingPipelines&quot;</span>
    <span class="n">_getter_method</span> <span class="o">=</span> <span class="s2">&quot;get_training_pipeline&quot;</span>
    <span class="n">_list_method</span> <span class="o">=</span> <span class="s2">&quot;list_training_pipelines&quot;</span>
    <span class="n">_delete_method</span> <span class="o">=</span> <span class="s2">&quot;delete_training_pipeline&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">display_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">project</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">location</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">auth_credentials</span><span class="o">.</span><span class="n">Credentials</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs a Training Job.</span>

<span class="sd">        Args:</span>
<span class="sd">            display_name (str):</span>
<span class="sd">                Required. The user-defined name of this TrainingPipeline.</span>
<span class="sd">            project (str):</span>
<span class="sd">                Optional project to retrieve model from. If not set, project set in</span>
<span class="sd">                aiplatform.init will be used.</span>
<span class="sd">            location (str):</span>
<span class="sd">                Optional location to retrieve model from. If not set, location set in</span>
<span class="sd">                aiplatform.init will be used.</span>
<span class="sd">            credentials (auth_credentials.Credentials):</span>
<span class="sd">                Optional credentials to use to retrieve the model.</span>
<span class="sd">            training_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the training pipeline. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, this TrainingPipeline will be secured by this key.</span>

<span class="sd">                Note: Model trained by this TrainingPipeline is also secured</span>
<span class="sd">                by this key if ``model_to_upload`` is not set separately.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">            model_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the model. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, the trained Model will be secured by this key.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">validate_display_name</span><span class="p">(</span><span class="n">display_name</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_name</span> <span class="o">=</span> <span class="n">display_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_training_encryption_spec</span> <span class="o">=</span> <span class="n">initializer</span><span class="o">.</span><span class="n">global_config</span><span class="o">.</span><span class="n">get_encryption_spec</span><span class="p">(</span>
            <span class="n">encryption_spec_key_name</span><span class="o">=</span><span class="n">training_encryption_spec_key_name</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_encryption_spec</span> <span class="o">=</span> <span class="n">initializer</span><span class="o">.</span><span class="n">global_config</span><span class="o">.</span><span class="n">get_encryption_spec</span><span class="p">(</span>
            <span class="n">encryption_spec_key_name</span><span class="o">=</span><span class="n">model_encryption_spec_key_name</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="nd">@classmethod</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_supported_training_schemas</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;List of supported schemas for this training job.&quot;&quot;&quot;</span>

        <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">resource_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">project</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">location</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">auth_credentials</span><span class="o">.</span><span class="n">Credentials</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_TrainingJob&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get Training Job for the given resource_name.</span>

<span class="sd">        Args:</span>
<span class="sd">            resource_name (str):</span>
<span class="sd">                Required. A fully-qualified resource name or ID.</span>
<span class="sd">            project (str):</span>
<span class="sd">                Optional project to retrieve dataset from. If not set, project</span>
<span class="sd">                set in aiplatform.init will be used.</span>
<span class="sd">            location (str):</span>
<span class="sd">                Optional location to retrieve dataset from. If not set, location</span>
<span class="sd">                set in aiplatform.init will be used.</span>
<span class="sd">            credentials (auth_credentials.Credentials):</span>
<span class="sd">                Custom credentials to use to upload this model. Overrides</span>
<span class="sd">                credentials set in aiplatform.init.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the retrieved training job&#39;s training task definition</span>
<span class="sd">                doesn&#39;t match the custom training task definition.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An Vertex AI Training Job</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create job with dummy parameters</span>
        <span class="c1"># These parameters won&#39;t be used as user can not run the job again.</span>
        <span class="c1"># If they try, an exception will be raised.</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_empty_constructor</span><span class="p">(</span>
            <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span>
            <span class="n">resource_name</span><span class="o">=</span><span class="n">resource_name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gca_resource</span><span class="p">(</span><span class="n">resource_name</span><span class="o">=</span><span class="n">resource_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">training_task_definition</span>
            <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_supported_training_schemas</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The retrieved job&#39;s training task definition &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">training_task_definition</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;which is not compatible with </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_model_upload_fail_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Helper property for model upload failure.&quot;&quot;&quot;</span>

        <span class="k">pass</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Runs the training job.</span>

<span class="sd">        Should call _run_job internally</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_create_input_data_config</span><span class="p">(</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datasets</span><span class="o">.</span><span class="n">_Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">annotation_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">validation_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">test_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">predefined_split_column_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gcs_destination_uri_prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bigquery_destination</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">gca_training_pipeline</span><span class="o">.</span><span class="n">InputDataConfig</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Constructs a input data config to pass to the training pipeline.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (datasets._Dataset):</span>
<span class="sd">                The dataset within the same Project from which data will be used to train the Model. The</span>
<span class="sd">                Dataset must use schema compatible with Model being trained,</span>
<span class="sd">                and what is compatible should be described in the used</span>
<span class="sd">                TrainingPipeline&#39;s [training_task_definition]</span>
<span class="sd">                [google.cloud.aiplatform.v1beta1.TrainingPipeline.training_task_definition].</span>
<span class="sd">                For tabular Datasets, all their data is exported to</span>
<span class="sd">                training, to pick and choose from.</span>
<span class="sd">            annotation_schema_uri (str):</span>
<span class="sd">                Google Cloud Storage URI points to a YAML file describing</span>
<span class="sd">                annotation schema. The schema is defined as an OpenAPI 3.0.2</span>
<span class="sd">                [Schema Object](https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.2.md#schema-object) The schema files</span>
<span class="sd">                that can be used here are found in</span>
<span class="sd">                gs://google-cloud-aiplatform/schema/dataset/annotation/,</span>
<span class="sd">                note that the chosen schema must be consistent with</span>
<span class="sd">                ``metadata``</span>
<span class="sd">                of the Dataset specified by</span>
<span class="sd">                ``dataset_id``.</span>

<span class="sd">                Only Annotations that both match this schema and belong to</span>
<span class="sd">                DataItems not ignored by the split method are used in</span>
<span class="sd">                respectively training, validation or test role, depending on</span>
<span class="sd">                the role of the DataItem they are on.</span>

<span class="sd">                When used in conjunction with</span>
<span class="sd">                ``annotations_filter``,</span>
<span class="sd">                the Annotations used for training are filtered by both</span>
<span class="sd">                ``annotations_filter``</span>
<span class="sd">                and</span>
<span class="sd">                ``annotation_schema_uri``.</span>
<span class="sd">            training_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to train the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            training_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to train the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            validation_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to validate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            test_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to evaluate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            predefined_split_column_name (str):</span>
<span class="sd">                Optional. The key is a name of one of the Dataset&#39;s data</span>
<span class="sd">                columns. The value of the key (either the label&#39;s value or</span>
<span class="sd">                value in the column) must be one of {``training``,</span>
<span class="sd">                ``validation``, ``test``}, and it defines to which set the</span>
<span class="sd">                given piece of data is assigned. If for a piece of data the</span>
<span class="sd">                key is not present or has an invalid value, that piece is</span>
<span class="sd">                ignored by the pipeline.</span>

<span class="sd">                Supported only for tabular and time series Datasets.</span>
<span class="sd">            gcs_destination_uri_prefix (str):</span>
<span class="sd">                Optional. The Google Cloud Storage location.</span>

<span class="sd">                The Vertex AI environment variables representing Google</span>
<span class="sd">                Cloud Storage data URIs will always be represented in the</span>
<span class="sd">                Google Cloud Storage wildcard format to support sharded</span>
<span class="sd">                data.</span>

<span class="sd">                -  AIP_DATA_FORMAT = &quot;jsonl&quot;.</span>
<span class="sd">                -  AIP_TRAINING_DATA_URI = &quot;gcs_destination/training-*&quot;</span>
<span class="sd">                -  AIP_VALIDATION_DATA_URI = &quot;gcs_destination/validation-*&quot;</span>
<span class="sd">                -  AIP_TEST_DATA_URI = &quot;gcs_destination/test-*&quot;.</span>
<span class="sd">            bigquery_destination (str):</span>
<span class="sd">                The BigQuery project location where the training data is to</span>
<span class="sd">                be written to. In the given project a new dataset is created</span>
<span class="sd">                with name</span>
<span class="sd">                ``dataset_&lt;dataset-id&gt;_&lt;annotation-type&gt;_&lt;timestamp-of-training-call&gt;``</span>
<span class="sd">                where timestamp is in YYYY_MM_DDThh_mm_ss_sssZ format. All</span>
<span class="sd">                training input data will be written into that dataset. In</span>
<span class="sd">                the dataset three tables will be created, ``training``,</span>
<span class="sd">                ``validation`` and ``test``.</span>

<span class="sd">                -  AIP_DATA_FORMAT = &quot;bigquery&quot;.</span>
<span class="sd">                -  AIP_TRAINING_DATA_URI =&quot;bigquery_destination.dataset_*.training&quot;</span>
<span class="sd">                -  AIP_VALIDATION_DATA_URI = &quot;bigquery_destination.dataset_*.validation&quot;</span>
<span class="sd">                -  AIP_TEST_DATA_URI = &quot;bigquery_destination.dataset_*.test&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">input_data_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="c1"># Create fraction split spec</span>
            <span class="n">fraction_split</span> <span class="o">=</span> <span class="n">gca_training_pipeline</span><span class="o">.</span><span class="n">FractionSplit</span><span class="p">(</span>
                <span class="n">training_fraction</span><span class="o">=</span><span class="n">training_fraction_split</span><span class="p">,</span>
                <span class="n">validation_fraction</span><span class="o">=</span><span class="n">validation_fraction_split</span><span class="p">,</span>
                <span class="n">test_fraction</span><span class="o">=</span><span class="n">test_fraction_split</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Create predefined split spec</span>
            <span class="n">predefined_split</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">predefined_split_column_name</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">metadata_schema_uri</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="n">schema</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tabular</span><span class="p">,</span>
                    <span class="n">schema</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">time_series</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;A pre-defined split may only be used with a tabular or time series Dataset&quot;</span>
                    <span class="p">)</span>

                <span class="n">predefined_split</span> <span class="o">=</span> <span class="n">gca_training_pipeline</span><span class="o">.</span><span class="n">PredefinedSplit</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="n">predefined_split_column_name</span>
                <span class="p">)</span>

            <span class="c1"># Create GCS destination</span>
            <span class="n">gcs_destination</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">gcs_destination_uri_prefix</span><span class="p">:</span>
                <span class="n">gcs_destination</span> <span class="o">=</span> <span class="n">gca_io</span><span class="o">.</span><span class="n">GcsDestination</span><span class="p">(</span>
                    <span class="n">output_uri_prefix</span><span class="o">=</span><span class="n">gcs_destination_uri_prefix</span>
                <span class="p">)</span>

            <span class="c1"># TODO(b/177416223) validate managed BQ dataset is passed in</span>
            <span class="n">bigquery_destination_proto</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">bigquery_destination</span><span class="p">:</span>
                <span class="n">bigquery_destination_proto</span> <span class="o">=</span> <span class="n">gca_io</span><span class="o">.</span><span class="n">BigQueryDestination</span><span class="p">(</span>
                    <span class="n">output_uri</span><span class="o">=</span><span class="n">bigquery_destination</span>
                <span class="p">)</span>

            <span class="c1"># create input data config</span>
            <span class="n">input_data_config</span> <span class="o">=</span> <span class="n">gca_training_pipeline</span><span class="o">.</span><span class="n">InputDataConfig</span><span class="p">(</span>
                <span class="n">fraction_split</span><span class="o">=</span><span class="n">fraction_split</span><span class="p">,</span>
                <span class="n">predefined_split</span><span class="o">=</span><span class="n">predefined_split</span><span class="p">,</span>
                <span class="n">dataset_id</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">annotation_schema_uri</span><span class="o">=</span><span class="n">annotation_schema_uri</span><span class="p">,</span>
                <span class="n">gcs_destination</span><span class="o">=</span><span class="n">gcs_destination</span><span class="p">,</span>
                <span class="n">bigquery_destination</span><span class="o">=</span><span class="n">bigquery_destination_proto</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">input_data_config</span>

    <span class="k">def</span> <span class="nf">_run_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">training_task_definition</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">training_task_inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">proto</span><span class="o">.</span><span class="n">Message</span><span class="p">],</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datasets</span><span class="o">.</span><span class="n">_Dataset</span><span class="p">],</span>
        <span class="n">training_fraction_split</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">validation_fraction_split</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">test_fraction_split</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">annotation_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">predefined_split_column_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">gca_model</span><span class="o">.</span><span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gcs_destination_uri_prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bigquery_destination</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Runs the training job.</span>

<span class="sd">        Args:</span>
<span class="sd">            training_task_definition (str):</span>
<span class="sd">                Required. A Google Cloud Storage path to the</span>
<span class="sd">                YAML file that defines the training task which</span>
<span class="sd">                is responsible for producing the model artifact,</span>
<span class="sd">                and may also include additional auxiliary work.</span>
<span class="sd">                The definition files that can be used here are</span>
<span class="sd">                found in gs://google-cloud-</span>
<span class="sd">                aiplatform/schema/trainingjob/definition/. Note:</span>
<span class="sd">                The URI given on output will be immutable and</span>
<span class="sd">                probably different, including the URI scheme,</span>
<span class="sd">                than the one given on input. The output URI will</span>
<span class="sd">                point to a location where the user only has a</span>
<span class="sd">                read access.</span>
<span class="sd">            training_task_inputs (Union[dict, proto.Message]):</span>
<span class="sd">                Required. The training task&#39;s input that corresponds to the training_task_definition parameter.</span>
<span class="sd">            dataset (datasets._Dataset):</span>
<span class="sd">                The dataset within the same Project from which data will be used to train the Model. The</span>
<span class="sd">                Dataset must use schema compatible with Model being trained,</span>
<span class="sd">                and what is compatible should be described in the used</span>
<span class="sd">                TrainingPipeline&#39;s [training_task_definition]</span>
<span class="sd">                [google.cloud.aiplatform.v1beta1.TrainingPipeline.training_task_definition].</span>
<span class="sd">                For tabular Datasets, all their data is exported to</span>
<span class="sd">                training, to pick and choose from.</span>
<span class="sd">            training_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to train the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            validation_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to validate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            test_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to evaluate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            annotation_schema_uri (str):</span>
<span class="sd">                Google Cloud Storage URI points to a YAML file describing</span>
<span class="sd">                annotation schema. The schema is defined as an OpenAPI 3.0.2</span>
<span class="sd">                [Schema Object](https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.2.md#schema-object) The schema files</span>
<span class="sd">                that can be used here are found in</span>
<span class="sd">                gs://google-cloud-aiplatform/schema/dataset/annotation/,</span>
<span class="sd">                note that the chosen schema must be consistent with</span>
<span class="sd">                ``metadata``</span>
<span class="sd">                of the Dataset specified by</span>
<span class="sd">                ``dataset_id``.</span>

<span class="sd">                Only Annotations that both match this schema and belong to</span>
<span class="sd">                DataItems not ignored by the split method are used in</span>
<span class="sd">                respectively training, validation or test role, depending on</span>
<span class="sd">                the role of the DataItem they are on.</span>

<span class="sd">                When used in conjunction with</span>
<span class="sd">                ``annotations_filter``,</span>
<span class="sd">                the Annotations used for training are filtered by both</span>
<span class="sd">                ``annotations_filter``</span>
<span class="sd">                and</span>
<span class="sd">                ``annotation_schema_uri``.</span>
<span class="sd">            predefined_split_column_name (str):</span>
<span class="sd">                Optional. The key is a name of one of the Dataset&#39;s data</span>
<span class="sd">                columns. The value of the key (either the label&#39;s value or</span>
<span class="sd">                value in the column) must be one of {``training``,</span>
<span class="sd">                ``validation``, ``test``}, and it defines to which set the</span>
<span class="sd">                given piece of data is assigned. If for a piece of data the</span>
<span class="sd">                key is not present or has an invalid value, that piece is</span>
<span class="sd">                ignored by the pipeline.</span>

<span class="sd">                Supported only for tabular and time series Datasets.</span>
<span class="sd">            model (~.model.Model):</span>
<span class="sd">                Optional. Describes the Model that may be uploaded (via</span>
<span class="sd">                [ModelService.UploadMode][]) by this TrainingPipeline. The</span>
<span class="sd">                TrainingPipeline&#39;s</span>
<span class="sd">                ``training_task_definition``</span>
<span class="sd">                should make clear whether this Model description should be</span>
<span class="sd">                populated, and if there are any special requirements</span>
<span class="sd">                regarding how it should be filled. If nothing is mentioned</span>
<span class="sd">                in the</span>
<span class="sd">                ``training_task_definition``,</span>
<span class="sd">                then it should be assumed that this field should not be</span>
<span class="sd">                filled and the training task either uploads the Model</span>
<span class="sd">                without a need of this information, or that training task</span>
<span class="sd">                does not support uploading a Model as part of the pipeline.</span>
<span class="sd">                When the Pipeline&#39;s state becomes</span>
<span class="sd">                ``PIPELINE_STATE_SUCCEEDED`` and the trained Model had been</span>
<span class="sd">                uploaded into Vertex AI, then the model_to_upload&#39;s</span>
<span class="sd">                resource ``name``</span>
<span class="sd">                is populated. The Model is always uploaded into the Project</span>
<span class="sd">                and Location in which this pipeline is.</span>
<span class="sd">            gcs_destination_uri_prefix (str):</span>
<span class="sd">                Optional. The Google Cloud Storage location.</span>

<span class="sd">                The Vertex AI environment variables representing Google</span>
<span class="sd">                Cloud Storage data URIs will always be represented in the</span>
<span class="sd">                Google Cloud Storage wildcard format to support sharded</span>
<span class="sd">                data.</span>

<span class="sd">                -  AIP_DATA_FORMAT = &quot;jsonl&quot;.</span>
<span class="sd">                -  AIP_TRAINING_DATA_URI = &quot;gcs_destination/training-*&quot;</span>
<span class="sd">                -  AIP_VALIDATION_DATA_URI = &quot;gcs_destination/validation-*&quot;</span>
<span class="sd">                -  AIP_TEST_DATA_URI = &quot;gcs_destination/test-*&quot;.</span>
<span class="sd">            bigquery_destination (str):</span>
<span class="sd">                The BigQuery project location where the training data is to</span>
<span class="sd">                be written to. In the given project a new dataset is created</span>
<span class="sd">                with name</span>
<span class="sd">                ``dataset_&lt;dataset-id&gt;_&lt;annotation-type&gt;_&lt;timestamp-of-training-call&gt;``</span>
<span class="sd">                where timestamp is in YYYY_MM_DDThh_mm_ss_sssZ format. All</span>
<span class="sd">                training input data will be written into that dataset. In</span>
<span class="sd">                the dataset three tables will be created, ``training``,</span>
<span class="sd">                ``validation`` and ``test``.</span>

<span class="sd">                -  AIP_DATA_FORMAT = &quot;bigquery&quot;.</span>
<span class="sd">                -  AIP_TRAINING_DATA_URI =&quot;bigquery_destination.dataset_*.training&quot;</span>
<span class="sd">                -  AIP_VALIDATION_DATA_URI = &quot;bigquery_destination.dataset_*.validation&quot;</span>
<span class="sd">                -  AIP_TEST_DATA_URI = &quot;bigquery_destination.dataset_*.test&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">input_data_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_input_data_config</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">annotation_schema_uri</span><span class="o">=</span><span class="n">annotation_schema_uri</span><span class="p">,</span>
            <span class="n">training_fraction_split</span><span class="o">=</span><span class="n">training_fraction_split</span><span class="p">,</span>
            <span class="n">validation_fraction_split</span><span class="o">=</span><span class="n">validation_fraction_split</span><span class="p">,</span>
            <span class="n">test_fraction_split</span><span class="o">=</span><span class="n">test_fraction_split</span><span class="p">,</span>
            <span class="n">predefined_split_column_name</span><span class="o">=</span><span class="n">predefined_split_column_name</span><span class="p">,</span>
            <span class="n">gcs_destination_uri_prefix</span><span class="o">=</span><span class="n">gcs_destination_uri_prefix</span><span class="p">,</span>
            <span class="n">bigquery_destination</span><span class="o">=</span><span class="n">bigquery_destination</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># create training pipeline</span>
        <span class="n">training_pipeline</span> <span class="o">=</span> <span class="n">gca_training_pipeline</span><span class="o">.</span><span class="n">TrainingPipeline</span><span class="p">(</span>
            <span class="n">display_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_display_name</span><span class="p">,</span>
            <span class="n">training_task_definition</span><span class="o">=</span><span class="n">training_task_definition</span><span class="p">,</span>
            <span class="n">training_task_inputs</span><span class="o">=</span><span class="n">training_task_inputs</span><span class="p">,</span>
            <span class="n">model_to_upload</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">input_data_config</span><span class="o">=</span><span class="n">input_data_config</span><span class="p">,</span>
            <span class="n">encryption_spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_training_encryption_spec</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">training_pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">create_training_pipeline</span><span class="p">(</span>
            <span class="n">parent</span><span class="o">=</span><span class="n">initializer</span><span class="o">.</span><span class="n">global_config</span><span class="o">.</span><span class="n">common_location_path</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span>
            <span class="p">),</span>
            <span class="n">training_pipeline</span><span class="o">=</span><span class="n">training_pipeline</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span> <span class="o">=</span> <span class="n">training_pipeline</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;View Training:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dashboard_uri</span><span class="p">())</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_model</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Training did not produce a Managed Model returning None. &quot;</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_upload_fail_string</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">_is_waiting_to_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True if the Job is pending on upstream tasks False</span>
<span class="sd">        otherwise.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_future_exception</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_future</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Training Job is waiting for upstream SDK tasks to complete before&quot;</span>
                <span class="s2">&quot; launching.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">gca_pipeline_state</span><span class="o">.</span><span class="n">PipelineState</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Current training state.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assert_has_run</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_gca_resource</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">state</span>

    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Vertex AI Model produced by this training, if one was produced.</span>

<span class="sd">        Args:</span>
<span class="sd">            sync (bool):</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model: Vertex AI Model produced by this training</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If training failed or if a model was not produced by this training.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_has_run</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">model_to_upload</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_upload_fail_string</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force_get_model</span><span class="p">(</span><span class="n">sync</span><span class="o">=</span><span class="n">sync</span><span class="p">)</span>

    <span class="nd">@base</span><span class="o">.</span><span class="n">optional_sync</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_force_get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sync</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Vertex AI Model produced by this training, if one was produced.</span>

<span class="sd">        Args:</span>
<span class="sd">            sync (bool):</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model: Vertex AI Model produced by this training</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If training failed or if a model was not produced by this training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_model</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_upload_fail_string</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">_get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Helper method to get and instantiate the Model to Upload.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model: Vertex AI Model if training succeeded and produced an Vertex AI</span>
<span class="sd">                Model. None otherwise.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If Training failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_block_until_complete</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_failed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Training Pipeline </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_name</span><span class="si">}</span><span class="s2"> failed. No model available.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">model_to_upload</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">model_to_upload</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">extract_fields_from_resource_name</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">model_to_upload</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">fields</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">fields</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_wait_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback performs custom logging during _block_until_complete. Override in subclass.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_block_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to block and check on job until complete.&quot;&quot;&quot;</span>

        <span class="c1"># Used these numbers so failures surface fast</span>
        <span class="n">wait</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># start at five seconds</span>
        <span class="n">log_wait</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">max_wait</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">5</span>  <span class="c1"># 5 minute wait</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># scale wait by 2 every iteration</span>

        <span class="n">previous_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_PIPELINE_COMPLETE_STATES</span><span class="p">:</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">previous_time</span> <span class="o">&gt;=</span> <span class="n">log_wait</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> current state:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">log_wait</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">log_wait</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span> <span class="n">max_wait</span><span class="p">)</span>
                <span class="n">previous_time</span> <span class="o">=</span> <span class="n">current_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_callback</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_failure</span><span class="p">()</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">log_action_completed_against_resource</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">model_to_upload</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_failed</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Model available at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">model_to_upload</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_raise_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to raise failure if TrainingPipeline fails.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If training failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">code</span> <span class="o">!=</span> <span class="n">code_pb2</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Training failed with:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True if training has failed.</span>

<span class="sd">        False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_has_run</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">gca_pipeline_state</span><span class="o">.</span><span class="n">PipelineState</span><span class="o">.</span><span class="n">PIPELINE_STATE_FAILED</span>

    <span class="k">def</span> <span class="nf">_dashboard_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Helper method to compose the dashboard uri where training can be</span>
<span class="sd">        viewed.&quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">extract_fields_from_resource_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_name</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://console.cloud.google.com/ai/platform/locations/</span><span class="si">{</span><span class="n">fields</span><span class="o">.</span><span class="n">location</span><span class="si">}</span><span class="s2">/training/</span><span class="si">{</span><span class="n">fields</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">?project=</span><span class="si">{</span><span class="n">fields</span><span class="o">.</span><span class="n">project</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">url</span>

    <span class="k">def</span> <span class="nf">_sync_gca_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to sync the local gca_source against the service.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">get_training_pipeline</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_name</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_has_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Helper property to check if this training job has been run.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_assert_has_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Helper method to assert that this training has run.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_run</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_waiting_to_run</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;TrainingPipeline has not been launched. You must run this&quot;</span>
                <span class="s2">&quot; TrainingPipeline using TrainingPipeline.run. &quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">order_by</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">project</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">location</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">auth_credentials</span><span class="o">.</span><span class="n">Credentials</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;base.VertexAiResourceNoun&quot;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;List all instances of this TrainingJob resource.</span>

<span class="sd">        Example Usage:</span>

<span class="sd">        aiplatform.CustomTrainingJob.list(</span>
<span class="sd">            filter=&#39;display_name=&quot;experiment_a27&quot;&#39;,</span>
<span class="sd">            order_by=&#39;create_time desc&#39;</span>
<span class="sd">        )</span>

<span class="sd">        Args:</span>
<span class="sd">            filter (str):</span>
<span class="sd">                Optional. An expression for filtering the results of the request.</span>
<span class="sd">                For field names both snake_case and camelCase are supported.</span>
<span class="sd">            order_by (str):</span>
<span class="sd">                Optional. A comma-separated list of fields to order by, sorted in</span>
<span class="sd">                ascending order. Use &quot;desc&quot; after a field name for descending.</span>
<span class="sd">                Supported fields: `display_name`, `create_time`, `update_time`</span>
<span class="sd">            project (str):</span>
<span class="sd">                Optional. Project to retrieve list from. If not set, project</span>
<span class="sd">                set in aiplatform.init will be used.</span>
<span class="sd">            location (str):</span>
<span class="sd">                Optional. Location to retrieve list from. If not set, location</span>
<span class="sd">                set in aiplatform.init will be used.</span>
<span class="sd">            credentials (auth_credentials.Credentials):</span>
<span class="sd">                Optional. Custom credentials to use to retrieve list. Overrides</span>
<span class="sd">                credentials set in aiplatform.init.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[VertexAiResourceNoun] - A list of TrainingJob resource objects</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">training_job_subclass_filter</span> <span class="o">=</span> <span class="p">(</span>
            <span class="k">lambda</span> <span class="n">gapic_obj</span><span class="p">:</span> <span class="n">gapic_obj</span><span class="o">.</span><span class="n">training_task_definition</span>
            <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_supported_training_schemas</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_list_with_local_order</span><span class="p">(</span>
            <span class="n">cls_filter</span><span class="o">=</span><span class="n">training_job_subclass_filter</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="n">order_by</span><span class="o">=</span><span class="n">order_by</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Starts asynchronous cancellation on the TrainingJob. The server</span>
<span class="sd">        makes a best effort to cancel the job, but success is not guaranteed.</span>
<span class="sd">        On successful cancellation, the TrainingJob is not deleted; instead it</span>
<span class="sd">        becomes a job with state set to `CANCELLED`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If this TrainingJob has not started running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_run</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;This TrainingJob has not been launched, use the `run()` method &quot;</span>
                <span class="s2">&quot;to start. `cancel()` can only be called on a job that is running.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">cancel_training_pipeline</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_name</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_CustomTrainingJob</span><span class="p">(</span><span class="n">_TrainingJob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ABC for Custom Training Pipelines..&quot;&quot;&quot;</span>

    <span class="n">_supported_training_schemas</span> <span class="o">=</span> <span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">custom_task</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">display_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">container_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">model_serving_container_image_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_predict_route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_health_route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_environment_variables</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_ports</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_instance_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_parameters_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_prediction_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">project</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">location</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">auth_credentials</span><span class="o">.</span><span class="n">Credentials</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">staging_bucket</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            display_name (str):</span>
<span class="sd">                Required. The user-defined name of this TrainingPipeline.</span>
<span class="sd">            container_uri (str):</span>
<span class="sd">                Required: Uri of the training container image in the GCR.</span>
<span class="sd">            model_serving_container_image_uri (str):</span>
<span class="sd">                If the training produces a managed Vertex AI Model, the URI of the</span>
<span class="sd">                Model serving container suitable for serving the model produced by the</span>
<span class="sd">                training script.</span>
<span class="sd">            model_serving_container_predict_route (str):</span>
<span class="sd">                If the training produces a managed Vertex AI Model, An HTTP path to</span>
<span class="sd">                send prediction requests to the container, and which must be supported</span>
<span class="sd">                by it. If not specified a default HTTP path will be used by Vertex AI.</span>
<span class="sd">            model_serving_container_health_route (str):</span>
<span class="sd">                If the training produces a managed Vertex AI Model, an HTTP path to</span>
<span class="sd">                send health check requests to the container, and which must be supported</span>
<span class="sd">                by it. If not specified a standard HTTP path will be used by AI</span>
<span class="sd">                Platform.</span>
<span class="sd">            model_serving_container_command (Sequence[str]):</span>
<span class="sd">                The command with which the container is run. Not executed within a</span>
<span class="sd">                shell. The Docker image&#39;s ENTRYPOINT is used if this is not provided.</span>
<span class="sd">                Variable references $(VAR_NAME) are expanded using the container&#39;s</span>
<span class="sd">                environment. If a variable cannot be resolved, the reference in the</span>
<span class="sd">                input string will be unchanged. The $(VAR_NAME) syntax can be escaped</span>
<span class="sd">                with a double $$, ie: $$(VAR_NAME). Escaped references will never be</span>
<span class="sd">                expanded, regardless of whether the variable exists or not.</span>
<span class="sd">            model_serving_container_args (Sequence[str]):</span>
<span class="sd">                The arguments to the command. The Docker image&#39;s CMD is used if this is</span>
<span class="sd">                not provided. Variable references $(VAR_NAME) are expanded using the</span>
<span class="sd">                container&#39;s environment. If a variable cannot be resolved, the reference</span>
<span class="sd">                in the input string will be unchanged. The $(VAR_NAME) syntax can be</span>
<span class="sd">                escaped with a double $$, ie: $$(VAR_NAME). Escaped references will</span>
<span class="sd">                never be expanded, regardless of whether the variable exists or not.</span>
<span class="sd">            model_serving_container_environment_variables (Dict[str, str]):</span>
<span class="sd">                The environment variables that are to be present in the container.</span>
<span class="sd">                Should be a dictionary where keys are environment variable names</span>
<span class="sd">                and values are environment variable values for those names.</span>
<span class="sd">            model_serving_container_ports (Sequence[int]):</span>
<span class="sd">                Declaration of ports that are exposed by the container. This field is</span>
<span class="sd">                primarily informational, it gives Vertex AI information about the</span>
<span class="sd">                network connections the container uses. Listing or not a port here has</span>
<span class="sd">                no impact on whether the port is actually exposed, any port listening on</span>
<span class="sd">                the default &quot;0.0.0.0&quot; address inside a container will be accessible from</span>
<span class="sd">                the network.</span>
<span class="sd">            model_description (str):</span>
<span class="sd">                The description of the Model.</span>
<span class="sd">            model_instance_schema_uri (str):</span>
<span class="sd">                Optional. Points to a YAML file stored on Google Cloud</span>
<span class="sd">                Storage describing the format of a single instance, which</span>
<span class="sd">                are used in</span>
<span class="sd">                ``PredictRequest.instances``,</span>
<span class="sd">                ``ExplainRequest.instances``</span>
<span class="sd">                and</span>
<span class="sd">                ``BatchPredictionJob.input_config``.</span>
<span class="sd">                The schema is defined as an OpenAPI 3.0.2 `Schema</span>
<span class="sd">                Object &lt;https://tinyurl.com/y538mdwt#schema-object&gt;`__.</span>
<span class="sd">                AutoML Models always have this field populated by AI</span>
<span class="sd">                Platform. Note: The URI given on output will be immutable</span>
<span class="sd">                and probably different, including the URI scheme, than the</span>
<span class="sd">                one given on input. The output URI will point to a location</span>
<span class="sd">                where the user only has a read access.</span>
<span class="sd">            model_parameters_schema_uri (str):</span>
<span class="sd">                Optional. Points to a YAML file stored on Google Cloud</span>
<span class="sd">                Storage describing the parameters of prediction and</span>
<span class="sd">                explanation via</span>
<span class="sd">                ``PredictRequest.parameters``,</span>
<span class="sd">                ``ExplainRequest.parameters``</span>
<span class="sd">                and</span>
<span class="sd">                ``BatchPredictionJob.model_parameters``.</span>
<span class="sd">                The schema is defined as an OpenAPI 3.0.2 `Schema</span>
<span class="sd">                Object &lt;https://tinyurl.com/y538mdwt#schema-object&gt;`__.</span>
<span class="sd">                AutoML Models always have this field populated by AI</span>
<span class="sd">                Platform, if no parameters are supported it is set to an</span>
<span class="sd">                empty string. Note: The URI given on output will be</span>
<span class="sd">                immutable and probably different, including the URI scheme,</span>
<span class="sd">                than the one given on input. The output URI will point to a</span>
<span class="sd">                location where the user only has a read access.</span>
<span class="sd">            model_prediction_schema_uri (str):</span>
<span class="sd">                Optional. Points to a YAML file stored on Google Cloud</span>
<span class="sd">                Storage describing the format of a single prediction</span>
<span class="sd">                produced by this Model, which are returned via</span>
<span class="sd">                ``PredictResponse.predictions``,</span>
<span class="sd">                ``ExplainResponse.explanations``,</span>
<span class="sd">                and</span>
<span class="sd">                ``BatchPredictionJob.output_config``.</span>
<span class="sd">                The schema is defined as an OpenAPI 3.0.2 `Schema</span>
<span class="sd">                Object &lt;https://tinyurl.com/y538mdwt#schema-object&gt;`__.</span>
<span class="sd">                AutoML Models always have this field populated by AI</span>
<span class="sd">                Platform. Note: The URI given on output will be immutable</span>
<span class="sd">                and probably different, including the URI scheme, than the</span>
<span class="sd">                one given on input. The output URI will point to a location</span>
<span class="sd">                where the user only has a read access.</span>
<span class="sd">            project (str):</span>
<span class="sd">                Project to run training in. Overrides project set in aiplatform.init.</span>
<span class="sd">            location (str):</span>
<span class="sd">                Location to run training in. Overrides location set in aiplatform.init.</span>
<span class="sd">            credentials (auth_credentials.Credentials):</span>
<span class="sd">                Custom credentials to use to run call training service. Overrides</span>
<span class="sd">                credentials set in aiplatform.init.</span>
<span class="sd">            training_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the training pipeline. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, this TrainingPipeline will be secured by this key.</span>

<span class="sd">                Note: Model trained by this TrainingPipeline is also secured</span>
<span class="sd">                by this key if ``model_to_upload`` is not set separately.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">            model_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the model. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, the trained Model will be secured by this key.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">            staging_bucket (str):</span>
<span class="sd">                Bucket used to stage source and training artifacts. Overrides</span>
<span class="sd">                staging_bucket set in aiplatform.init.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span>
            <span class="n">training_encryption_spec_key_name</span><span class="o">=</span><span class="n">training_encryption_spec_key_name</span><span class="p">,</span>
            <span class="n">model_encryption_spec_key_name</span><span class="o">=</span><span class="n">model_encryption_spec_key_name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_container_uri</span> <span class="o">=</span> <span class="n">container_uri</span>

        <span class="n">model_predict_schemata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">model_instance_schema_uri</span><span class="p">,</span>
                <span class="n">model_parameters_schema_uri</span><span class="p">,</span>
                <span class="n">model_prediction_schema_uri</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">):</span>
            <span class="n">model_predict_schemata</span> <span class="o">=</span> <span class="n">gca_model</span><span class="o">.</span><span class="n">PredictSchemata</span><span class="p">(</span>
                <span class="n">instance_schema_uri</span><span class="o">=</span><span class="n">model_instance_schema_uri</span><span class="p">,</span>
                <span class="n">parameters_schema_uri</span><span class="o">=</span><span class="n">model_parameters_schema_uri</span><span class="p">,</span>
                <span class="n">prediction_schema_uri</span><span class="o">=</span><span class="n">model_prediction_schema_uri</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Create the container spec</span>
        <span class="n">env</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ports</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">model_serving_container_environment_variables</span><span class="p">:</span>
            <span class="n">env</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">gca_env_var</span><span class="o">.</span><span class="n">EnvVar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">model_serving_container_environment_variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="n">model_serving_container_ports</span><span class="p">:</span>
            <span class="n">ports</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">gca_model</span><span class="o">.</span><span class="n">Port</span><span class="p">(</span><span class="n">container_port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">model_serving_container_ports</span>
            <span class="p">]</span>

        <span class="n">container_spec</span> <span class="o">=</span> <span class="n">gca_model</span><span class="o">.</span><span class="n">ModelContainerSpec</span><span class="p">(</span>
            <span class="n">image_uri</span><span class="o">=</span><span class="n">model_serving_container_image_uri</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="n">model_serving_container_command</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">model_serving_container_args</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
            <span class="n">ports</span><span class="o">=</span><span class="n">ports</span><span class="p">,</span>
            <span class="n">predict_route</span><span class="o">=</span><span class="n">model_serving_container_predict_route</span><span class="p">,</span>
            <span class="n">health_route</span><span class="o">=</span><span class="n">model_serving_container_health_route</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># create model payload</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_managed_model</span> <span class="o">=</span> <span class="n">gca_model</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="n">model_description</span><span class="p">,</span>
            <span class="n">predict_schemata</span><span class="o">=</span><span class="n">model_predict_schemata</span><span class="p">,</span>
            <span class="n">container_spec</span><span class="o">=</span><span class="n">container_spec</span><span class="p">,</span>
            <span class="n">encryption_spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_encryption_spec</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_staging_bucket</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">staging_bucket</span> <span class="ow">or</span> <span class="n">initializer</span><span class="o">.</span><span class="n">global_config</span><span class="o">.</span><span class="n">staging_bucket</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staging_bucket</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;staging_bucket should be set in TrainingJob constructor or &quot;</span>
                <span class="s2">&quot;set using aiplatform.init(staging_bucket=&#39;gs://my-bucket&#39;)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Backing Custom Job resource is not known until after data preprocessing</span>
        <span class="c1"># once Custom Job is known we log the console uri and the tensorboard uri</span>
        <span class="c1"># this flags keeps that state so we don&#39;t log it multiple times</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_logged_custom_job</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_prepare_and_validate_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">replica_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">machine_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;n1-standard-4&quot;</span><span class="p">,</span>
        <span class="n">accelerator_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ACCELERATOR_TYPE_UNSPECIFIED&quot;</span><span class="p">,</span>
        <span class="n">accelerator_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">worker_spec_utils</span><span class="o">.</span><span class="n">_DistributedTrainingSpec</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">gca_model</span><span class="o">.</span><span class="n">Model</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Create worker pool specs and managed model as well validating the</span>
<span class="sd">        run.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_display_name (str):</span>
<span class="sd">                If the script produces a managed Vertex AI Model. The display name of</span>
<span class="sd">                the Model. The name can be up to 128 characters long and can be consist</span>
<span class="sd">                of any UTF-8 characters.</span>

<span class="sd">                If not provided upon creation, the job&#39;s display_name is used.</span>
<span class="sd">            replica_count (int):</span>
<span class="sd">                The number of worker replicas. If replica count = 1 then one chief</span>
<span class="sd">                replica will be provisioned. If replica_count &gt; 1 the remainder will be</span>
<span class="sd">                provisioned as a worker replica pool.</span>
<span class="sd">            machine_type (str):</span>
<span class="sd">                The type of machine to use for training.</span>
<span class="sd">            accelerator_type (str):</span>
<span class="sd">                Hardware accelerator type. One of ACCELERATOR_TYPE_UNSPECIFIED,</span>
<span class="sd">                NVIDIA_TESLA_K80, NVIDIA_TESLA_P100, NVIDIA_TESLA_V100, NVIDIA_TESLA_P4,</span>
<span class="sd">                NVIDIA_TESLA_T4</span>
<span class="sd">            accelerator_count (int):</span>
<span class="sd">                The number of accelerators to attach to a worker replica.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Worker pools specs and managed model for run.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If Training job has already been run or model_display_name was</span>
<span class="sd">                provided but required arguments were not provided in constructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_waiting_to_run</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Custom Training is already scheduled to run.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_run</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Custom Training has already run.&quot;</span><span class="p">)</span>

        <span class="c1"># if args needed for model is incomplete</span>
        <span class="k">if</span> <span class="n">model_display_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_managed_model</span><span class="o">.</span><span class="n">container_spec</span><span class="o">.</span><span class="n">image_uri</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;model_display_name was provided but</span>
<span class="sd">                model_serving_container_image_uri was not provided when this</span>
<span class="sd">                custom pipeline was constructed.</span>
<span class="sd">                &quot;&quot;&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_managed_model</span><span class="o">.</span><span class="n">container_spec</span><span class="o">.</span><span class="n">image_uri</span><span class="p">:</span>
            <span class="n">model_display_name</span> <span class="o">=</span> <span class="n">model_display_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_name</span> <span class="o">+</span> <span class="s2">&quot;-model&quot;</span>

        <span class="c1"># validates args and will raise</span>
        <span class="n">worker_pool_specs</span> <span class="o">=</span> <span class="n">worker_spec_utils</span><span class="o">.</span><span class="n">_DistributedTrainingSpec</span><span class="o">.</span><span class="n">chief_worker_pool</span><span class="p">(</span>
            <span class="n">replica_count</span><span class="o">=</span><span class="n">replica_count</span><span class="p">,</span>
            <span class="n">machine_type</span><span class="o">=</span><span class="n">machine_type</span><span class="p">,</span>
            <span class="n">accelerator_count</span><span class="o">=</span><span class="n">accelerator_count</span><span class="p">,</span>
            <span class="n">accelerator_type</span><span class="o">=</span><span class="n">accelerator_type</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">pool_specs</span>

        <span class="n">managed_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_managed_model</span>
        <span class="k">if</span> <span class="n">model_display_name</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">validate_display_name</span><span class="p">(</span><span class="n">model_display_name</span><span class="p">)</span>
            <span class="n">managed_model</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">model_display_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">managed_model</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">worker_pool_specs</span><span class="p">,</span> <span class="n">managed_model</span>

    <span class="k">def</span> <span class="nf">_prepare_training_task_inputs_and_output_dir</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">worker_pool_specs</span><span class="p">:</span> <span class="n">worker_spec_utils</span><span class="o">.</span><span class="n">_DistributedTrainingSpec</span><span class="p">,</span>
        <span class="n">base_output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">service_account</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tensorboard</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Prepares training task inputs and output directory for custom job.</span>

<span class="sd">        Args:</span>
<span class="sd">            worker_pools_spec (worker_spec_utils._DistributedTrainingSpec):</span>
<span class="sd">                Worker pools pecs required to run job.</span>
<span class="sd">            base_output_dir (str):</span>
<span class="sd">                GCS output directory of job. If not provided a</span>
<span class="sd">                timestamped directory in the staging directory will be used.</span>
<span class="sd">            service_account (str):</span>
<span class="sd">                Specifies the service account for workload run-as account.</span>
<span class="sd">                Users submitting jobs must have act-as permission on this run-as account.</span>
<span class="sd">            network (str):</span>
<span class="sd">                The full name of the Compute Engine network to which the job</span>
<span class="sd">                should be peered. For example, projects/12345/global/networks/myVPC.</span>
<span class="sd">                Private services access must already be configured for the network.</span>
<span class="sd">                If left unspecified, the job is not peered with any network.</span>
<span class="sd">            tensorboard (str):</span>
<span class="sd">                Optional. The name of an Vertex AI</span>
<span class="sd">                [Tensorboard][google.cloud.aiplatform.v1beta1.Tensorboard]</span>
<span class="sd">                resource to which this CustomJob will upload Tensorboard</span>
<span class="sd">                logs. Format:</span>
<span class="sd">                ``projects/{project}/locations/{location}/tensorboards/{tensorboard}``</span>

<span class="sd">                The training script should write Tensorboard to following Vertex AI environment</span>
<span class="sd">                variable:</span>

<span class="sd">                AIP_TENSORBOARD_LOG_DIR</span>

<span class="sd">                `service_account` is required with provided `tensorboard`.</span>
<span class="sd">                For more information on configuring your service account please visit:</span>
<span class="sd">                https://cloud.google.com/vertex-ai/docs/experiments/tensorboard-training</span>
<span class="sd">        Returns:</span>
<span class="sd">            Training task inputs and Output directory for custom job.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># default directory if not given</span>
        <span class="n">base_output_dir</span> <span class="o">=</span> <span class="n">base_output_dir</span> <span class="ow">or</span> <span class="n">_timestamped_gcs_dir</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_staging_bucket</span><span class="p">,</span> <span class="s2">&quot;aiplatform-custom-training&quot;</span>
        <span class="p">)</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Training Output directory:</span><span class="se">\n</span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">base_output_dir</span><span class="p">)</span>

        <span class="n">training_task_inputs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;worker_pool_specs&quot;</span><span class="p">:</span> <span class="n">worker_pool_specs</span><span class="p">,</span>
            <span class="s2">&quot;base_output_directory&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;output_uri_prefix&quot;</span><span class="p">:</span> <span class="n">base_output_dir</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">service_account</span><span class="p">:</span>
            <span class="n">training_task_inputs</span><span class="p">[</span><span class="s2">&quot;service_account&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">service_account</span>
        <span class="k">if</span> <span class="n">network</span><span class="p">:</span>
            <span class="n">training_task_inputs</span><span class="p">[</span><span class="s2">&quot;network&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">network</span>
        <span class="k">if</span> <span class="n">tensorboard</span><span class="p">:</span>
            <span class="n">training_task_inputs</span><span class="p">[</span><span class="s2">&quot;tensorboard&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensorboard</span>

        <span class="k">return</span> <span class="n">training_task_inputs</span><span class="p">,</span> <span class="n">base_output_dir</span>

    <span class="k">def</span> <span class="nf">_wait_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">training_task_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backingCustomJob&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_logged_custom_job</span>
        <span class="p">):</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;View backing custom job:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_custom_job_console_uri</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">training_task_inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tensorboard&quot;</span><span class="p">):</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;View tensorboard:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tensorboard_console_uri</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_has_logged_custom_job</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_custom_job_console_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Helper method to compose the dashboard uri where custom job can be viewed.&quot;&quot;&quot;</span>
        <span class="n">custom_job_resource_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">training_task_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;backingCustomJob&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">console_utils</span><span class="o">.</span><span class="n">custom_job_console_uri</span><span class="p">(</span><span class="n">custom_job_resource_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_tensorboard_console_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Helper method to compose dashboard uri where tensorboard can be viewed.&quot;&quot;&quot;</span>
        <span class="n">tensorboard_resource_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">training_task_inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;tensorboard&quot;</span>
        <span class="p">)</span>
        <span class="n">custom_job_resource_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gca_resource</span><span class="o">.</span><span class="n">training_task_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;backingCustomJob&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">console_utils</span><span class="o">.</span><span class="n">custom_job_tensorboard_console_uri</span><span class="p">(</span>
            <span class="n">tensorboard_resource_name</span><span class="p">,</span> <span class="n">custom_job_resource_name</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_model_upload_fail_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Helper property for model upload failure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Training Pipeline </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_name</span><span class="si">}</span><span class="s2"> is not configured to upload a &quot;</span>
            <span class="s2">&quot;Model. Create the Training Pipeline with &quot;</span>
            <span class="s2">&quot;model_serving_container_image_uri and model_display_name passed in. &quot;</span>
            <span class="s2">&quot;Ensure that your training script saves to model to &quot;</span>
            <span class="s2">&quot;os.environ[&#39;AIP_MODEL_DIR&#39;].&quot;</span>
        <span class="p">)</span>


<span class="c1"># TODO(b/172368325) add scheduling, custom_job.Scheduling</span>
<div class="viewcode-block" id="CustomTrainingJob"><a class="viewcode-back" href="../../../../aiplatform.html#google.cloud.aiplatform.CustomTrainingJob">[docs]</a><span class="k">class</span> <span class="nc">CustomTrainingJob</span><span class="p">(</span><span class="n">_CustomTrainingJob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to launch a Custom Training Job in Vertex AI using a script.</span>

<span class="sd">    Takes a training implementation as a python script and executes that</span>
<span class="sd">    script in Cloud Vertex AI Training.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">display_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">script_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">container_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">requirements</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_image_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_predict_route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_health_route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_environment_variables</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_ports</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_instance_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_parameters_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_prediction_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">project</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">location</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">auth_credentials</span><span class="o">.</span><span class="n">Credentials</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">staging_bucket</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs a Custom Training Job from a Python script.</span>

<span class="sd">        job = aiplatform.CustomTrainingJob(</span>
<span class="sd">            display_name=&#39;test-train&#39;,</span>
<span class="sd">            script_path=&#39;test_script.py&#39;,</span>
<span class="sd">            requirements=[&#39;pandas&#39;, &#39;numpy&#39;],</span>
<span class="sd">            container_uri=&#39;gcr.io/cloud-aiplatform/training/tf-cpu.2-2:latest&#39;,</span>
<span class="sd">            model_serving_container_image_uri=&#39;gcr.io/my-trainer/serving:1&#39;,</span>
<span class="sd">            model_serving_container_predict_route=&#39;predict&#39;,</span>
<span class="sd">            model_serving_container_health_route=&#39;metadata)</span>

<span class="sd">        Usage with Dataset:</span>

<span class="sd">        ds = aiplatform.TabularDataset(</span>
<span class="sd">            &#39;projects/my-project/locations/us-central1/datasets/12345&#39;)</span>

<span class="sd">        job.run(ds, replica_count=1, model_display_name=&#39;my-trained-model&#39;)</span>

<span class="sd">        Usage without Dataset:</span>

<span class="sd">        job.run(replica_count=1, model_display_name=&#39;my-trained-model)</span>


<span class="sd">        TODO(b/169782082) add documentation about traning utilities</span>
<span class="sd">        To ensure your model gets saved in Vertex AI, write your saved model to</span>
<span class="sd">        os.environ[&quot;AIP_MODEL_DIR&quot;] in your provided training script.</span>


<span class="sd">        Args:</span>
<span class="sd">            display_name (str):</span>
<span class="sd">                Required. The user-defined name of this TrainingPipeline.</span>
<span class="sd">            script_path (str): Required. Local path to training script.</span>
<span class="sd">            container_uri (str):</span>
<span class="sd">                Required: Uri of the training container image in the GCR.</span>
<span class="sd">            requirements (Sequence[str]):</span>
<span class="sd">                List of python packages dependencies of script.</span>
<span class="sd">            model_serving_container_image_uri (str):</span>
<span class="sd">                If the training produces a managed Vertex AI Model, the URI of the</span>
<span class="sd">                Model serving container suitable for serving the model produced by the</span>
<span class="sd">                training script.</span>
<span class="sd">            model_serving_container_predict_route (str):</span>
<span class="sd">                If the training produces a managed Vertex AI Model, An HTTP path to</span>
<span class="sd">                send prediction requests to the container, and which must be supported</span>
<span class="sd">                by it. If not specified a default HTTP path will be used by Vertex AI.</span>
<span class="sd">            model_serving_container_health_route (str):</span>
<span class="sd">                If the training produces a managed Vertex AI Model, an HTTP path to</span>
<span class="sd">                send health check requests to the container, and which must be supported</span>
<span class="sd">                by it. If not specified a standard HTTP path will be used by AI</span>
<span class="sd">                Platform.</span>
<span class="sd">            model_serving_container_command (Sequence[str]):</span>
<span class="sd">                The command with which the container is run. Not executed within a</span>
<span class="sd">                shell. The Docker image&#39;s ENTRYPOINT is used if this is not provided.</span>
<span class="sd">                Variable references $(VAR_NAME) are expanded using the container&#39;s</span>
<span class="sd">                environment. If a variable cannot be resolved, the reference in the</span>
<span class="sd">                input string will be unchanged. The $(VAR_NAME) syntax can be escaped</span>
<span class="sd">                with a double $$, ie: $$(VAR_NAME). Escaped references will never be</span>
<span class="sd">                expanded, regardless of whether the variable exists or not.</span>
<span class="sd">            model_serving_container_args (Sequence[str]):</span>
<span class="sd">                The arguments to the command. The Docker image&#39;s CMD is used if this is</span>
<span class="sd">                not provided. Variable references $(VAR_NAME) are expanded using the</span>
<span class="sd">                container&#39;s environment. If a variable cannot be resolved, the reference</span>
<span class="sd">                in the input string will be unchanged. The $(VAR_NAME) syntax can be</span>
<span class="sd">                escaped with a double $$, ie: $$(VAR_NAME). Escaped references will</span>
<span class="sd">                never be expanded, regardless of whether the variable exists or not.</span>
<span class="sd">            model_serving_container_environment_variables (Dict[str, str]):</span>
<span class="sd">                The environment variables that are to be present in the container.</span>
<span class="sd">                Should be a dictionary where keys are environment variable names</span>
<span class="sd">                and values are environment variable values for those names.</span>
<span class="sd">            model_serving_container_ports (Sequence[int]):</span>
<span class="sd">                Declaration of ports that are exposed by the container. This field is</span>
<span class="sd">                primarily informational, it gives Vertex AI information about the</span>
<span class="sd">                network connections the container uses. Listing or not a port here has</span>
<span class="sd">                no impact on whether the port is actually exposed, any port listening on</span>
<span class="sd">                the default &quot;0.0.0.0&quot; address inside a container will be accessible from</span>
<span class="sd">                the network.</span>
<span class="sd">            model_description (str):</span>
<span class="sd">                The description of the Model.</span>
<span class="sd">            model_instance_schema_uri (str):</span>
<span class="sd">                Optional. Points to a YAML file stored on Google Cloud</span>
<span class="sd">                Storage describing the format of a single instance, which</span>
<span class="sd">                are used in</span>
<span class="sd">                ``PredictRequest.instances``,</span>
<span class="sd">                ``ExplainRequest.instances``</span>
<span class="sd">                and</span>
<span class="sd">                ``BatchPredictionJob.input_config``.</span>
<span class="sd">                The schema is defined as an OpenAPI 3.0.2 `Schema</span>
<span class="sd">                Object &lt;https://tinyurl.com/y538mdwt#schema-object&gt;`__.</span>
<span class="sd">                AutoML Models always have this field populated by AI</span>
<span class="sd">                Platform. Note: The URI given on output will be immutable</span>
<span class="sd">                and probably different, including the URI scheme, than the</span>
<span class="sd">                one given on input. The output URI will point to a location</span>
<span class="sd">                where the user only has a read access.</span>
<span class="sd">            model_parameters_schema_uri (str):</span>
<span class="sd">                Optional. Points to a YAML file stored on Google Cloud</span>
<span class="sd">                Storage describing the parameters of prediction and</span>
<span class="sd">                explanation via</span>
<span class="sd">                ``PredictRequest.parameters``,</span>
<span class="sd">                ``ExplainRequest.parameters``</span>
<span class="sd">                and</span>
<span class="sd">                ``BatchPredictionJob.model_parameters``.</span>
<span class="sd">                The schema is defined as an OpenAPI 3.0.2 `Schema</span>
<span class="sd">                Object &lt;https://tinyurl.com/y538mdwt#schema-object&gt;`__.</span>
<span class="sd">                AutoML Models always have this field populated by AI</span>
<span class="sd">                Platform, if no parameters are supported it is set to an</span>
<span class="sd">                empty string. Note: The URI given on output will be</span>
<span class="sd">                immutable and probably different, including the URI scheme,</span>
<span class="sd">                than the one given on input. The output URI will point to a</span>
<span class="sd">                location where the user only has a read access.</span>
<span class="sd">            model_prediction_schema_uri (str):</span>
<span class="sd">                Optional. Points to a YAML file stored on Google Cloud</span>
<span class="sd">                Storage describing the format of a single prediction</span>
<span class="sd">                produced by this Model, which are returned via</span>
<span class="sd">                ``PredictResponse.predictions``,</span>
<span class="sd">                ``ExplainResponse.explanations``,</span>
<span class="sd">                and</span>
<span class="sd">                ``BatchPredictionJob.output_config``.</span>
<span class="sd">                The schema is defined as an OpenAPI 3.0.2 `Schema</span>
<span class="sd">                Object &lt;https://tinyurl.com/y538mdwt#schema-object&gt;`__.</span>
<span class="sd">                AutoML Models always have this field populated by AI</span>
<span class="sd">                Platform. Note: The URI given on output will be immutable</span>
<span class="sd">                and probably different, including the URI scheme, than the</span>
<span class="sd">                one given on input. The output URI will point to a location</span>
<span class="sd">                where the user only has a read access.</span>
<span class="sd">            project (str):</span>
<span class="sd">                Project to run training in. Overrides project set in aiplatform.init.</span>
<span class="sd">            location (str):</span>
<span class="sd">                Location to run training in. Overrides location set in aiplatform.init.</span>
<span class="sd">            credentials (auth_credentials.Credentials):</span>
<span class="sd">                Custom credentials to use to run call training service. Overrides</span>
<span class="sd">                credentials set in aiplatform.init.</span>
<span class="sd">            training_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the training pipeline. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, this TrainingPipeline will be secured by this key.</span>

<span class="sd">                Note: Model trained by this TrainingPipeline is also secured</span>
<span class="sd">                by this key if ``model_to_upload`` is not set separately.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">            model_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the model. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, the trained Model will be secured by this key.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">            staging_bucket (str):</span>
<span class="sd">                Bucket used to stage source and training artifacts. Overrides</span>
<span class="sd">                staging_bucket set in aiplatform.init.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span>
            <span class="n">training_encryption_spec_key_name</span><span class="o">=</span><span class="n">training_encryption_spec_key_name</span><span class="p">,</span>
            <span class="n">model_encryption_spec_key_name</span><span class="o">=</span><span class="n">model_encryption_spec_key_name</span><span class="p">,</span>
            <span class="n">container_uri</span><span class="o">=</span><span class="n">container_uri</span><span class="p">,</span>
            <span class="n">model_instance_schema_uri</span><span class="o">=</span><span class="n">model_instance_schema_uri</span><span class="p">,</span>
            <span class="n">model_parameters_schema_uri</span><span class="o">=</span><span class="n">model_parameters_schema_uri</span><span class="p">,</span>
            <span class="n">model_prediction_schema_uri</span><span class="o">=</span><span class="n">model_prediction_schema_uri</span><span class="p">,</span>
            <span class="n">model_serving_container_environment_variables</span><span class="o">=</span><span class="n">model_serving_container_environment_variables</span><span class="p">,</span>
            <span class="n">model_serving_container_ports</span><span class="o">=</span><span class="n">model_serving_container_ports</span><span class="p">,</span>
            <span class="n">model_serving_container_image_uri</span><span class="o">=</span><span class="n">model_serving_container_image_uri</span><span class="p">,</span>
            <span class="n">model_serving_container_command</span><span class="o">=</span><span class="n">model_serving_container_command</span><span class="p">,</span>
            <span class="n">model_serving_container_args</span><span class="o">=</span><span class="n">model_serving_container_args</span><span class="p">,</span>
            <span class="n">model_serving_container_predict_route</span><span class="o">=</span><span class="n">model_serving_container_predict_route</span><span class="p">,</span>
            <span class="n">model_serving_container_health_route</span><span class="o">=</span><span class="n">model_serving_container_health_route</span><span class="p">,</span>
            <span class="n">model_description</span><span class="o">=</span><span class="n">model_description</span><span class="p">,</span>
            <span class="n">staging_bucket</span><span class="o">=</span><span class="n">staging_bucket</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_requirements</span> <span class="o">=</span> <span class="n">requirements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_script_path</span> <span class="o">=</span> <span class="n">script_path</span>

    <span class="c1"># TODO(b/172365904) add filter split, training_pipeline.FilterSplit</span>
    <span class="c1"># TODO(b/172368070) add timestamp split, training_pipeline.TimestampSplit</span>
<div class="viewcode-block" id="CustomTrainingJob.run"><a class="viewcode-back" href="../../../../aiplatform.html#google.cloud.aiplatform.CustomTrainingJob.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Union</span><span class="p">[</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">ImageDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">TabularDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">TextDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">VideoDataset</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">annotation_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">service_account</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bigquery_destination</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">environment_variables</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">replica_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">machine_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;n1-standard-4&quot;</span><span class="p">,</span>
        <span class="n">accelerator_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ACCELERATOR_TYPE_UNSPECIFIED&quot;</span><span class="p">,</span>
        <span class="n">accelerator_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">training_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">validation_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">test_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">predefined_split_column_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tensorboard</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Runs the custom training job.</span>

<span class="sd">        Distributed Training Support:</span>
<span class="sd">        If replica count = 1 then one chief replica will be provisioned. If</span>
<span class="sd">        replica_count &gt; 1 the remainder will be provisioned as a worker replica pool.</span>
<span class="sd">        ie: replica_count = 10 will result in 1 chief and 9 workers</span>
<span class="sd">        All replicas have same machine_type, accelerator_type, and accelerator_count</span>

<span class="sd">        Data fraction splits:</span>
<span class="sd">        Any of ``training_fraction_split``, ``validation_fraction_split`` and</span>
<span class="sd">        ``test_fraction_split`` may optionally be provided, they must sum to up to 1. If</span>
<span class="sd">        the provided ones sum to less than 1, the remainder is assigned to sets as</span>
<span class="sd">        decided by Vertex AI.If none of the fractions are set, by default roughly 80%</span>
<span class="sd">        of data will be used for training, 10% for validation, and 10% for test.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (</span>
<span class="sd">                Union[</span>
<span class="sd">                    datasets.ImageDataset,</span>
<span class="sd">                    datasets.TabularDataset,</span>
<span class="sd">                    datasets.TextDataset,</span>
<span class="sd">                    datasets.VideoDataset,</span>
<span class="sd">                ]</span>
<span class="sd">            ):</span>
<span class="sd">                Vertex AI to fit this training against. Custom training script should</span>
<span class="sd">                retrieve datasets through passed in environment variables uris:</span>

<span class="sd">                os.environ[&quot;AIP_TRAINING_DATA_URI&quot;]</span>
<span class="sd">                os.environ[&quot;AIP_VALIDATION_DATA_URI&quot;]</span>
<span class="sd">                os.environ[&quot;AIP_TEST_DATA_URI&quot;]</span>

<span class="sd">                Additionally the dataset format is passed in as:</span>

<span class="sd">                os.environ[&quot;AIP_DATA_FORMAT&quot;]</span>
<span class="sd">            annotation_schema_uri (str):</span>
<span class="sd">                Google Cloud Storage URI points to a YAML file describing</span>
<span class="sd">                annotation schema. The schema is defined as an OpenAPI 3.0.2</span>
<span class="sd">                [Schema Object](https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.2.md#schema-object) The schema files</span>
<span class="sd">                that can be used here are found in</span>
<span class="sd">                gs://google-cloud-aiplatform/schema/dataset/annotation/,</span>
<span class="sd">                note that the chosen schema must be consistent with</span>
<span class="sd">                ``metadata``</span>
<span class="sd">                of the Dataset specified by</span>
<span class="sd">                ``dataset_id``.</span>

<span class="sd">                Only Annotations that both match this schema and belong to</span>
<span class="sd">                DataItems not ignored by the split method are used in</span>
<span class="sd">                respectively training, validation or test role, depending on</span>
<span class="sd">                the role of the DataItem they are on.</span>

<span class="sd">                When used in conjunction with</span>
<span class="sd">                ``annotations_filter``,</span>
<span class="sd">                the Annotations used for training are filtered by both</span>
<span class="sd">                ``annotations_filter``</span>
<span class="sd">                and</span>
<span class="sd">                ``annotation_schema_uri``.</span>
<span class="sd">            model_display_name (str):</span>
<span class="sd">                If the script produces a managed Vertex AI Model. The display name of</span>
<span class="sd">                the Model. The name can be up to 128 characters long and can be consist</span>
<span class="sd">                of any UTF-8 characters.</span>

<span class="sd">                If not provided upon creation, the job&#39;s display_name is used.</span>
<span class="sd">            base_output_dir (str):</span>
<span class="sd">                GCS output directory of job. If not provided a</span>
<span class="sd">                timestamped directory in the staging directory will be used.</span>

<span class="sd">                Vertex AI sets the following environment variables when it runs your training code:</span>

<span class="sd">                -  AIP_MODEL_DIR: a Cloud Storage URI of a directory intended for saving model artifacts, i.e. &lt;base_output_dir&gt;/model/</span>
<span class="sd">                -  AIP_CHECKPOINT_DIR: a Cloud Storage URI of a directory intended for saving checkpoints, i.e. &lt;base_output_dir&gt;/checkpoints/</span>
<span class="sd">                -  AIP_TENSORBOARD_LOG_DIR: a Cloud Storage URI of a directory intended for saving TensorBoard logs, i.e. &lt;base_output_dir&gt;/logs/</span>

<span class="sd">            service_account (str):</span>
<span class="sd">                Specifies the service account for workload run-as account.</span>
<span class="sd">                Users submitting jobs must have act-as permission on this run-as account.</span>
<span class="sd">            network (str):</span>
<span class="sd">                The full name of the Compute Engine network to which the job</span>
<span class="sd">                should be peered. For example, projects/12345/global/networks/myVPC.</span>
<span class="sd">                Private services access must already be configured for the network.</span>
<span class="sd">                If left unspecified, the job is not peered with any network.</span>
<span class="sd">            bigquery_destination (str):</span>
<span class="sd">                Provide this field if `dataset` is a BiqQuery dataset.</span>
<span class="sd">                The BigQuery project location where the training data is to</span>
<span class="sd">                be written to. In the given project a new dataset is created</span>
<span class="sd">                with name</span>
<span class="sd">                ``dataset_&lt;dataset-id&gt;_&lt;annotation-type&gt;_&lt;timestamp-of-training-call&gt;``</span>
<span class="sd">                where timestamp is in YYYY_MM_DDThh_mm_ss_sssZ format. All</span>
<span class="sd">                training input data will be written into that dataset. In</span>
<span class="sd">                the dataset three tables will be created, ``training``,</span>
<span class="sd">                ``validation`` and ``test``.</span>

<span class="sd">                -  AIP_DATA_FORMAT = &quot;bigquery&quot;.</span>
<span class="sd">                -  AIP_TRAINING_DATA_URI =&quot;bigquery_destination.dataset_*.training&quot;</span>
<span class="sd">                -  AIP_VALIDATION_DATA_URI = &quot;bigquery_destination.dataset_*.validation&quot;</span>
<span class="sd">                -  AIP_TEST_DATA_URI = &quot;bigquery_destination.dataset_*.test&quot;</span>
<span class="sd">            args (List[Unions[str, int, float]]):</span>
<span class="sd">                Command line arguments to be passed to the Python script.</span>
<span class="sd">            environment_variables (Dict[str, str]):</span>
<span class="sd">                Environment variables to be passed to the container.</span>
<span class="sd">                Should be a dictionary where keys are environment variable names</span>
<span class="sd">                and values are environment variable values for those names.</span>
<span class="sd">                At most 10 environment variables can be specified.</span>
<span class="sd">                The Name of the environment variable must be unique.</span>

<span class="sd">                environment_variables = {</span>
<span class="sd">                    &#39;MY_KEY&#39;: &#39;MY_VALUE&#39;</span>
<span class="sd">                }</span>
<span class="sd">            replica_count (int):</span>
<span class="sd">                The number of worker replicas. If replica count = 1 then one chief</span>
<span class="sd">                replica will be provisioned. If replica_count &gt; 1 the remainder will be</span>
<span class="sd">                provisioned as a worker replica pool.</span>
<span class="sd">            machine_type (str):</span>
<span class="sd">                The type of machine to use for training.</span>
<span class="sd">            accelerator_type (str):</span>
<span class="sd">                Hardware accelerator type. One of ACCELERATOR_TYPE_UNSPECIFIED,</span>
<span class="sd">                NVIDIA_TESLA_K80, NVIDIA_TESLA_P100, NVIDIA_TESLA_V100, NVIDIA_TESLA_P4,</span>
<span class="sd">                NVIDIA_TESLA_T4</span>
<span class="sd">            accelerator_count (int):</span>
<span class="sd">                The number of accelerators to attach to a worker replica.</span>
<span class="sd">            training_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to train the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            validation_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to validate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            test_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to evaluate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            predefined_split_column_name (str):</span>
<span class="sd">                Optional. The key is a name of one of the Dataset&#39;s data</span>
<span class="sd">                columns. The value of the key (either the label&#39;s value or</span>
<span class="sd">                value in the column) must be one of {``training``,</span>
<span class="sd">                ``validation``, ``test``}, and it defines to which set the</span>
<span class="sd">                given piece of data is assigned. If for a piece of data the</span>
<span class="sd">                key is not present or has an invalid value, that piece is</span>
<span class="sd">                ignored by the pipeline.</span>

<span class="sd">                Supported only for tabular and time series Datasets.</span>
<span class="sd">            tensorboard (str):</span>
<span class="sd">                Optional. The name of an Vertex AI</span>
<span class="sd">                [Tensorboard][google.cloud.aiplatform.v1beta1.Tensorboard]</span>
<span class="sd">                resource to which this CustomJob will upload Tensorboard</span>
<span class="sd">                logs. Format:</span>
<span class="sd">                ``projects/{project}/locations/{location}/tensorboards/{tensorboard}``</span>

<span class="sd">                The training script should write Tensorboard to following Vertex AI environment</span>
<span class="sd">                variable:</span>

<span class="sd">                AIP_TENSORBOARD_LOG_DIR</span>

<span class="sd">                `service_account` is required with provided `tensorboard`.</span>
<span class="sd">                For more information on configuring your service account please visit:</span>
<span class="sd">                https://cloud.google.com/vertex-ai/docs/experiments/tensorboard-training</span>
<span class="sd">            sync (bool):</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model: The trained Vertex AI Model resource or None if training did not</span>
<span class="sd">                produce an Vertex AI Model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">worker_pool_specs</span><span class="p">,</span> <span class="n">managed_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_and_validate_run</span><span class="p">(</span>
            <span class="n">model_display_name</span><span class="o">=</span><span class="n">model_display_name</span><span class="p">,</span>
            <span class="n">replica_count</span><span class="o">=</span><span class="n">replica_count</span><span class="p">,</span>
            <span class="n">machine_type</span><span class="o">=</span><span class="n">machine_type</span><span class="p">,</span>
            <span class="n">accelerator_count</span><span class="o">=</span><span class="n">accelerator_count</span><span class="p">,</span>
            <span class="n">accelerator_type</span><span class="o">=</span><span class="n">accelerator_type</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># make and copy package</span>
        <span class="n">python_packager</span> <span class="o">=</span> <span class="n">source_utils</span><span class="o">.</span><span class="n">_TrainingScriptPythonPackager</span><span class="p">(</span>
            <span class="n">script_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_script_path</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_requirements</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span>
            <span class="n">python_packager</span><span class="o">=</span><span class="n">python_packager</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">annotation_schema_uri</span><span class="o">=</span><span class="n">annotation_schema_uri</span><span class="p">,</span>
            <span class="n">worker_pool_specs</span><span class="o">=</span><span class="n">worker_pool_specs</span><span class="p">,</span>
            <span class="n">managed_model</span><span class="o">=</span><span class="n">managed_model</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
            <span class="n">environment_variables</span><span class="o">=</span><span class="n">environment_variables</span><span class="p">,</span>
            <span class="n">base_output_dir</span><span class="o">=</span><span class="n">base_output_dir</span><span class="p">,</span>
            <span class="n">service_account</span><span class="o">=</span><span class="n">service_account</span><span class="p">,</span>
            <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
            <span class="n">bigquery_destination</span><span class="o">=</span><span class="n">bigquery_destination</span><span class="p">,</span>
            <span class="n">training_fraction_split</span><span class="o">=</span><span class="n">training_fraction_split</span><span class="p">,</span>
            <span class="n">validation_fraction_split</span><span class="o">=</span><span class="n">validation_fraction_split</span><span class="p">,</span>
            <span class="n">test_fraction_split</span><span class="o">=</span><span class="n">test_fraction_split</span><span class="p">,</span>
            <span class="n">predefined_split_column_name</span><span class="o">=</span><span class="n">predefined_split_column_name</span><span class="p">,</span>
            <span class="n">tensorboard</span><span class="o">=</span><span class="n">tensorboard</span><span class="p">,</span>
            <span class="n">sync</span><span class="o">=</span><span class="n">sync</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@base</span><span class="o">.</span><span class="n">optional_sync</span><span class="p">(</span><span class="n">construct_object_on_arg</span><span class="o">=</span><span class="s2">&quot;managed_model&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">python_packager</span><span class="p">:</span> <span class="n">source_utils</span><span class="o">.</span><span class="n">_TrainingScriptPythonPackager</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Union</span><span class="p">[</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">ImageDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">TabularDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">TextDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">VideoDataset</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">],</span>
        <span class="n">annotation_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">worker_pool_specs</span><span class="p">:</span> <span class="n">worker_spec_utils</span><span class="o">.</span><span class="n">_DistributedTrainingSpec</span><span class="p">,</span>
        <span class="n">managed_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">gca_model</span><span class="o">.</span><span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">environment_variables</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">service_account</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bigquery_destination</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">validation_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">test_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">predefined_split_column_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tensorboard</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Packages local script and launches training_job.</span>

<span class="sd">        Args:</span>
<span class="sd">            python_packager (source_utils._TrainingScriptPythonPackager):</span>
<span class="sd">                Required. Python Packager pointing to training script locally.</span>
<span class="sd">            dataset (</span>
<span class="sd">                Union[</span>
<span class="sd">                    datasets.ImageDataset,</span>
<span class="sd">                    datasets.TabularDataset,</span>
<span class="sd">                    datasets.TextDataset,</span>
<span class="sd">                    datasets.VideoDataset,</span>
<span class="sd">                ]</span>
<span class="sd">            ):</span>
<span class="sd">                Vertex AI to fit this training against.</span>
<span class="sd">            annotation_schema_uri (str):</span>
<span class="sd">                Google Cloud Storage URI points to a YAML file describing</span>
<span class="sd">                annotation schema.</span>
<span class="sd">            worker_pools_spec (worker_spec_utils._DistributedTrainingSpec):</span>
<span class="sd">                Worker pools pecs required to run job.</span>
<span class="sd">            managed_model (gca_model.Model):</span>
<span class="sd">                Model proto if this script produces a Managed Model.</span>
<span class="sd">            args (List[Unions[str, int, float]]):</span>
<span class="sd">                Command line arguments to be passed to the Python script.</span>
<span class="sd">            environment_variables (Dict[str, str]):</span>
<span class="sd">                Environment variables to be passed to the container.</span>
<span class="sd">                Should be a dictionary where keys are environment variable names</span>
<span class="sd">                and values are environment variable values for those names.</span>
<span class="sd">                At most 10 environment variables can be specified.</span>
<span class="sd">                The Name of the environment variable must be unique.</span>

<span class="sd">                environment_variables = {</span>
<span class="sd">                    &#39;MY_KEY&#39;: &#39;MY_VALUE&#39;</span>
<span class="sd">                }</span>
<span class="sd">            base_output_dir (str):</span>
<span class="sd">                GCS output directory of job. If not provided a</span>
<span class="sd">                timestamped directory in the staging directory will be used.</span>

<span class="sd">                Vertex AI sets the following environment variables when it runs your training code:</span>

<span class="sd">                -  AIP_MODEL_DIR: a Cloud Storage URI of a directory intended for saving model artifacts, i.e. &lt;base_output_dir&gt;/model/</span>
<span class="sd">                -  AIP_CHECKPOINT_DIR: a Cloud Storage URI of a directory intended for saving checkpoints, i.e. &lt;base_output_dir&gt;/checkpoints/</span>
<span class="sd">                -  AIP_TENSORBOARD_LOG_DIR: a Cloud Storage URI of a directory intended for saving TensorBoard logs, i.e. &lt;base_output_dir&gt;/logs/</span>

<span class="sd">            service_account (str):</span>
<span class="sd">                Specifies the service account for workload run-as account.</span>
<span class="sd">                Users submitting jobs must have act-as permission on this run-as account.</span>
<span class="sd">            network (str):</span>
<span class="sd">                The full name of the Compute Engine network to which the job</span>
<span class="sd">                should be peered. For example, projects/12345/global/networks/myVPC.</span>
<span class="sd">                Private services access must already be configured for the network.</span>
<span class="sd">                If left unspecified, the job is not peered with any network.</span>
<span class="sd">            bigquery_destination (str):</span>
<span class="sd">                Provide this field if `dataset` is a BiqQuery dataset.</span>
<span class="sd">                The BigQuery project location where the training data is to</span>
<span class="sd">                be written to. In the given project a new dataset is created</span>
<span class="sd">                with name</span>
<span class="sd">                ``dataset_&lt;dataset-id&gt;_&lt;annotation-type&gt;_&lt;timestamp-of-training-call&gt;``</span>
<span class="sd">                where timestamp is in YYYY_MM_DDThh_mm_ss_sssZ format. All</span>
<span class="sd">                training input data will be written into that dataset. In</span>
<span class="sd">                the dataset three tables will be created, ``training``,</span>
<span class="sd">                ``validation`` and ``test``.</span>

<span class="sd">                -  AIP_DATA_FORMAT = &quot;bigquery&quot;.</span>
<span class="sd">                -  AIP_TRAINING_DATA_URI =&quot;bigquery_destination.dataset_*.training&quot;</span>
<span class="sd">                -  AIP_VALIDATION_DATA_URI = &quot;bigquery_destination.dataset_*.validation&quot;</span>
<span class="sd">                -  AIP_TEST_DATA_URI = &quot;bigquery_destination.dataset_*.test&quot;</span>
<span class="sd">            training_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to train the Model.</span>
<span class="sd">            validation_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to validate the Model.</span>
<span class="sd">            test_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to evaluate the Model.</span>
<span class="sd">            predefined_split_column_name (str):</span>
<span class="sd">                Optional. The key is a name of one of the Dataset&#39;s data</span>
<span class="sd">                columns. The value of the key (either the label&#39;s value or</span>
<span class="sd">                value in the column) must be one of {``training``,</span>
<span class="sd">                ``validation``, ``test``}, and it defines to which set the</span>
<span class="sd">                given piece of data is assigned. If for a piece of data the</span>
<span class="sd">                key is not present or has an invalid value, that piece is</span>
<span class="sd">                ignored by the pipeline.</span>

<span class="sd">                Supported only for tabular and time series Datasets.</span>
<span class="sd">            tensorboard (str):</span>
<span class="sd">                Optional. The name of an Vertex AI</span>
<span class="sd">                [Tensorboard][google.cloud.aiplatform.v1beta1.Tensorboard]</span>
<span class="sd">                resource to which this CustomJob will upload Tensorboard</span>
<span class="sd">                logs. Format:</span>
<span class="sd">                ``projects/{project}/locations/{location}/tensorboards/{tensorboard}``</span>

<span class="sd">                The training script should write Tensorboard to following Vertex AI environment</span>
<span class="sd">                variable:</span>

<span class="sd">                AIP_TENSORBOARD_LOG_DIR</span>

<span class="sd">                `service_account` is required with provided `tensorboard`.</span>
<span class="sd">                For more information on configuring your service account please visit:</span>
<span class="sd">                https://cloud.google.com/vertex-ai/docs/experiments/tensorboard-training</span>
<span class="sd">            sync (bool):</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model: The trained Vertex AI Model resource or None if training did not</span>
<span class="sd">                produce an Vertex AI Model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">package_gcs_uri</span> <span class="o">=</span> <span class="n">python_packager</span><span class="o">.</span><span class="n">package_and_copy_to_gcs</span><span class="p">(</span>
            <span class="n">gcs_staging_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_staging_bucket</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
            <span class="n">credentials</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">credentials</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">worker_pool_specs</span><span class="p">:</span>
            <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;python_package_spec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;executor_image_uri&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_container_uri</span><span class="p">,</span>
                <span class="s2">&quot;python_module&quot;</span><span class="p">:</span> <span class="n">python_packager</span><span class="o">.</span><span class="n">module_name</span><span class="p">,</span>
                <span class="s2">&quot;package_uris&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">package_gcs_uri</span><span class="p">],</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;python_package_spec&quot;</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>

            <span class="k">if</span> <span class="n">environment_variables</span><span class="p">:</span>
                <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;python_package_spec&quot;</span><span class="p">][</span><span class="s2">&quot;env&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">environment_variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">]</span>

        <span class="p">(</span>
            <span class="n">training_task_inputs</span><span class="p">,</span>
            <span class="n">base_output_dir</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_training_task_inputs_and_output_dir</span><span class="p">(</span>
            <span class="n">worker_pool_specs</span><span class="o">=</span><span class="n">worker_pool_specs</span><span class="p">,</span>
            <span class="n">base_output_dir</span><span class="o">=</span><span class="n">base_output_dir</span><span class="p">,</span>
            <span class="n">service_account</span><span class="o">=</span><span class="n">service_account</span><span class="p">,</span>
            <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
            <span class="n">tensorboard</span><span class="o">=</span><span class="n">tensorboard</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span>
            <span class="n">training_task_definition</span><span class="o">=</span><span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">custom_task</span><span class="p">,</span>
            <span class="n">training_task_inputs</span><span class="o">=</span><span class="n">training_task_inputs</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">annotation_schema_uri</span><span class="o">=</span><span class="n">annotation_schema_uri</span><span class="p">,</span>
            <span class="n">training_fraction_split</span><span class="o">=</span><span class="n">training_fraction_split</span><span class="p">,</span>
            <span class="n">validation_fraction_split</span><span class="o">=</span><span class="n">validation_fraction_split</span><span class="p">,</span>
            <span class="n">test_fraction_split</span><span class="o">=</span><span class="n">test_fraction_split</span><span class="p">,</span>
            <span class="n">predefined_split_column_name</span><span class="o">=</span><span class="n">predefined_split_column_name</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">managed_model</span><span class="p">,</span>
            <span class="n">gcs_destination_uri_prefix</span><span class="o">=</span><span class="n">base_output_dir</span><span class="p">,</span>
            <span class="n">bigquery_destination</span><span class="o">=</span><span class="n">bigquery_destination</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="CustomContainerTrainingJob"><a class="viewcode-back" href="../../../../aiplatform.html#google.cloud.aiplatform.CustomContainerTrainingJob">[docs]</a><span class="k">class</span> <span class="nc">CustomContainerTrainingJob</span><span class="p">(</span><span class="n">_CustomTrainingJob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to launch a Custom Training Job in Vertex AI using a</span>
<span class="sd">    Container.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">display_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">container_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_image_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_predict_route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_health_route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_environment_variables</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_ports</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_instance_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_parameters_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_prediction_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">project</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">location</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">auth_credentials</span><span class="o">.</span><span class="n">Credentials</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">staging_bucket</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs a Custom Container Training Job.</span>

<span class="sd">        job = aiplatform.CustomTrainingJob(</span>
<span class="sd">            display_name=&#39;test-train&#39;,</span>
<span class="sd">            container_uri=&#39;gcr.io/cloud-aiplatform/training/tf-cpu.2-2:latest&#39;,</span>
<span class="sd">            command=[&#39;python3&#39;, &#39;run_script.py&#39;]</span>
<span class="sd">            model_serving_container_image_uri=&#39;gcr.io/my-trainer/serving:1&#39;,</span>
<span class="sd">            model_serving_container_predict_route=&#39;predict&#39;,</span>
<span class="sd">            model_serving_container_health_route=&#39;metadata)</span>

<span class="sd">        Usage with Dataset:</span>

<span class="sd">        ds = aiplatform.TabularDataset(</span>
<span class="sd">            &#39;projects/my-project/locations/us-central1/datasets/12345&#39;)</span>

<span class="sd">        job.run(ds, replica_count=1, model_display_name=&#39;my-trained-model&#39;)</span>

<span class="sd">        Usage without Dataset:</span>

<span class="sd">        job.run(replica_count=1, model_display_name=&#39;my-trained-model)</span>


<span class="sd">        TODO(b/169782082) add documentation about traning utilities</span>
<span class="sd">        To ensure your model gets saved in Vertex AI, write your saved model to</span>
<span class="sd">        os.environ[&quot;AIP_MODEL_DIR&quot;] in your provided training script.</span>


<span class="sd">        Args:</span>
<span class="sd">            display_name (str):</span>
<span class="sd">                Required. The user-defined name of this TrainingPipeline.</span>
<span class="sd">            container_uri (str):</span>
<span class="sd">                Required: Uri of the training container image in the GCR.</span>
<span class="sd">            command (Sequence[str]):</span>
<span class="sd">                The command to be invoked when the container is started.</span>
<span class="sd">                It overrides the entrypoint instruction in Dockerfile when provided</span>
<span class="sd">            model_serving_container_image_uri (str):</span>
<span class="sd">                If the training produces a managed Vertex AI Model, the URI of the</span>
<span class="sd">                Model serving container suitable for serving the model produced by the</span>
<span class="sd">                training script.</span>
<span class="sd">            model_serving_container_predict_route (str):</span>
<span class="sd">                If the training produces a managed Vertex AI Model, An HTTP path to</span>
<span class="sd">                send prediction requests to the container, and which must be supported</span>
<span class="sd">                by it. If not specified a default HTTP path will be used by Vertex AI.</span>
<span class="sd">            model_serving_container_health_route (str):</span>
<span class="sd">                If the training produces a managed Vertex AI Model, an HTTP path to</span>
<span class="sd">                send health check requests to the container, and which must be supported</span>
<span class="sd">                by it. If not specified a standard HTTP path will be used by AI</span>
<span class="sd">                Platform.</span>
<span class="sd">            model_serving_container_command (Sequence[str]):</span>
<span class="sd">                The command with which the container is run. Not executed within a</span>
<span class="sd">                shell. The Docker image&#39;s ENTRYPOINT is used if this is not provided.</span>
<span class="sd">                Variable references $(VAR_NAME) are expanded using the container&#39;s</span>
<span class="sd">                environment. If a variable cannot be resolved, the reference in the</span>
<span class="sd">                input string will be unchanged. The $(VAR_NAME) syntax can be escaped</span>
<span class="sd">                with a double $$, ie: $$(VAR_NAME). Escaped references will never be</span>
<span class="sd">                expanded, regardless of whether the variable exists or not.</span>
<span class="sd">            model_serving_container_args (Sequence[str]):</span>
<span class="sd">                The arguments to the command. The Docker image&#39;s CMD is used if this is</span>
<span class="sd">                not provided. Variable references $(VAR_NAME) are expanded using the</span>
<span class="sd">                container&#39;s environment. If a variable cannot be resolved, the reference</span>
<span class="sd">                in the input string will be unchanged. The $(VAR_NAME) syntax can be</span>
<span class="sd">                escaped with a double $$, ie: $$(VAR_NAME). Escaped references will</span>
<span class="sd">                never be expanded, regardless of whether the variable exists or not.</span>
<span class="sd">            model_serving_container_environment_variables (Dict[str, str]):</span>
<span class="sd">                The environment variables that are to be present in the container.</span>
<span class="sd">                Should be a dictionary where keys are environment variable names</span>
<span class="sd">                and values are environment variable values for those names.</span>
<span class="sd">            model_serving_container_ports (Sequence[int]):</span>
<span class="sd">                Declaration of ports that are exposed by the container. This field is</span>
<span class="sd">                primarily informational, it gives Vertex AI information about the</span>
<span class="sd">                network connections the container uses. Listing or not a port here has</span>
<span class="sd">                no impact on whether the port is actually exposed, any port listening on</span>
<span class="sd">                the default &quot;0.0.0.0&quot; address inside a container will be accessible from</span>
<span class="sd">                the network.</span>
<span class="sd">            model_description (str):</span>
<span class="sd">                The description of the Model.</span>
<span class="sd">            model_instance_schema_uri (str):</span>
<span class="sd">                Optional. Points to a YAML file stored on Google Cloud</span>
<span class="sd">                Storage describing the format of a single instance, which</span>
<span class="sd">                are used in</span>
<span class="sd">                ``PredictRequest.instances``,</span>
<span class="sd">                ``ExplainRequest.instances``</span>
<span class="sd">                and</span>
<span class="sd">                ``BatchPredictionJob.input_config``.</span>
<span class="sd">                The schema is defined as an OpenAPI 3.0.2 `Schema</span>
<span class="sd">                Object &lt;https://tinyurl.com/y538mdwt#schema-object&gt;`__.</span>
<span class="sd">                AutoML Models always have this field populated by AI</span>
<span class="sd">                Platform. Note: The URI given on output will be immutable</span>
<span class="sd">                and probably different, including the URI scheme, than the</span>
<span class="sd">                one given on input. The output URI will point to a location</span>
<span class="sd">                where the user only has a read access.</span>
<span class="sd">            model_parameters_schema_uri (str):</span>
<span class="sd">                Optional. Points to a YAML file stored on Google Cloud</span>
<span class="sd">                Storage describing the parameters of prediction and</span>
<span class="sd">                explanation via</span>
<span class="sd">                ``PredictRequest.parameters``,</span>
<span class="sd">                ``ExplainRequest.parameters``</span>
<span class="sd">                and</span>
<span class="sd">                ``BatchPredictionJob.model_parameters``.</span>
<span class="sd">                The schema is defined as an OpenAPI 3.0.2 `Schema</span>
<span class="sd">                Object &lt;https://tinyurl.com/y538mdwt#schema-object&gt;`__.</span>
<span class="sd">                AutoML Models always have this field populated by AI</span>
<span class="sd">                Platform, if no parameters are supported it is set to an</span>
<span class="sd">                empty string. Note: The URI given on output will be</span>
<span class="sd">                immutable and probably different, including the URI scheme,</span>
<span class="sd">                than the one given on input. The output URI will point to a</span>
<span class="sd">                location where the user only has a read access.</span>
<span class="sd">            model_prediction_schema_uri (str):</span>
<span class="sd">                Optional. Points to a YAML file stored on Google Cloud</span>
<span class="sd">                Storage describing the format of a single prediction</span>
<span class="sd">                produced by this Model, which are returned via</span>
<span class="sd">                ``PredictResponse.predictions``,</span>
<span class="sd">                ``ExplainResponse.explanations``,</span>
<span class="sd">                and</span>
<span class="sd">                ``BatchPredictionJob.output_config``.</span>
<span class="sd">                The schema is defined as an OpenAPI 3.0.2 `Schema</span>
<span class="sd">                Object &lt;https://tinyurl.com/y538mdwt#schema-object&gt;`__.</span>
<span class="sd">                AutoML Models always have this field populated by AI</span>
<span class="sd">                Platform. Note: The URI given on output will be immutable</span>
<span class="sd">                and probably different, including the URI scheme, than the</span>
<span class="sd">                one given on input. The output URI will point to a location</span>
<span class="sd">                where the user only has a read access.</span>
<span class="sd">            project (str):</span>
<span class="sd">                Project to run training in. Overrides project set in aiplatform.init.</span>
<span class="sd">            location (str):</span>
<span class="sd">                Location to run training in. Overrides location set in aiplatform.init.</span>
<span class="sd">            credentials (auth_credentials.Credentials):</span>
<span class="sd">                Custom credentials to use to run call training service. Overrides</span>
<span class="sd">                credentials set in aiplatform.init.</span>
<span class="sd">            training_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the training pipeline. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, this TrainingPipeline will be secured by this key.</span>

<span class="sd">                Note: Model trained by this TrainingPipeline is also secured</span>
<span class="sd">                by this key if ``model_to_upload`` is not set separately.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">            model_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the model. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, the trained Model will be secured by this key.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">            staging_bucket (str):</span>
<span class="sd">                Bucket used to stage source and training artifacts. Overrides</span>
<span class="sd">                staging_bucket set in aiplatform.init.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span>
            <span class="n">training_encryption_spec_key_name</span><span class="o">=</span><span class="n">training_encryption_spec_key_name</span><span class="p">,</span>
            <span class="n">model_encryption_spec_key_name</span><span class="o">=</span><span class="n">model_encryption_spec_key_name</span><span class="p">,</span>
            <span class="n">container_uri</span><span class="o">=</span><span class="n">container_uri</span><span class="p">,</span>
            <span class="n">model_instance_schema_uri</span><span class="o">=</span><span class="n">model_instance_schema_uri</span><span class="p">,</span>
            <span class="n">model_parameters_schema_uri</span><span class="o">=</span><span class="n">model_parameters_schema_uri</span><span class="p">,</span>
            <span class="n">model_prediction_schema_uri</span><span class="o">=</span><span class="n">model_prediction_schema_uri</span><span class="p">,</span>
            <span class="n">model_serving_container_environment_variables</span><span class="o">=</span><span class="n">model_serving_container_environment_variables</span><span class="p">,</span>
            <span class="n">model_serving_container_ports</span><span class="o">=</span><span class="n">model_serving_container_ports</span><span class="p">,</span>
            <span class="n">model_serving_container_image_uri</span><span class="o">=</span><span class="n">model_serving_container_image_uri</span><span class="p">,</span>
            <span class="n">model_serving_container_command</span><span class="o">=</span><span class="n">model_serving_container_command</span><span class="p">,</span>
            <span class="n">model_serving_container_args</span><span class="o">=</span><span class="n">model_serving_container_args</span><span class="p">,</span>
            <span class="n">model_serving_container_predict_route</span><span class="o">=</span><span class="n">model_serving_container_predict_route</span><span class="p">,</span>
            <span class="n">model_serving_container_health_route</span><span class="o">=</span><span class="n">model_serving_container_health_route</span><span class="p">,</span>
            <span class="n">model_description</span><span class="o">=</span><span class="n">model_description</span><span class="p">,</span>
            <span class="n">staging_bucket</span><span class="o">=</span><span class="n">staging_bucket</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="n">command</span>

    <span class="c1"># TODO(b/172365904) add filter split, training_pipeline.FilterSplit</span>
    <span class="c1"># TODO(b/172368070) add timestamp split, training_pipeline.TimestampSplit</span>
<div class="viewcode-block" id="CustomContainerTrainingJob.run"><a class="viewcode-back" href="../../../../aiplatform.html#google.cloud.aiplatform.CustomContainerTrainingJob.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Union</span><span class="p">[</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">ImageDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">TabularDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">TextDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">VideoDataset</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">annotation_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">service_account</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bigquery_destination</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">environment_variables</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">replica_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">machine_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;n1-standard-4&quot;</span><span class="p">,</span>
        <span class="n">accelerator_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ACCELERATOR_TYPE_UNSPECIFIED&quot;</span><span class="p">,</span>
        <span class="n">accelerator_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">training_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">validation_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">test_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">predefined_split_column_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tensorboard</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Runs the custom training job.</span>

<span class="sd">        Distributed Training Support:</span>
<span class="sd">        If replica count = 1 then one chief replica will be provisioned. If</span>
<span class="sd">        replica_count &gt; 1 the remainder will be provisioned as a worker replica pool.</span>
<span class="sd">        ie: replica_count = 10 will result in 1 chief and 9 workers</span>
<span class="sd">        All replicas have same machine_type, accelerator_type, and accelerator_count</span>

<span class="sd">        Data fraction splits:</span>
<span class="sd">        Any of ``training_fraction_split``, ``validation_fraction_split`` and</span>
<span class="sd">        ``test_fraction_split`` may optionally be provided, they must sum to up to 1. If</span>
<span class="sd">        the provided ones sum to less than 1, the remainder is assigned to sets as</span>
<span class="sd">        decided by Vertex AI. If none of the fractions are set, by default roughly 80%</span>
<span class="sd">        of data will be used for training, 10% for validation, and 10% for test.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (Union[datasets.ImageDataset,datasets.TabularDataset,datasets.TextDataset,datasets.VideoDataset]):</span>
<span class="sd">                Vertex AI to fit this training against. Custom training script should</span>
<span class="sd">                retrieve datasets through passed in environment variables uris:</span>

<span class="sd">                os.environ[&quot;AIP_TRAINING_DATA_URI&quot;]</span>
<span class="sd">                os.environ[&quot;AIP_VALIDATION_DATA_URI&quot;]</span>
<span class="sd">                os.environ[&quot;AIP_TEST_DATA_URI&quot;]</span>

<span class="sd">                Additionally the dataset format is passed in as:</span>

<span class="sd">                os.environ[&quot;AIP_DATA_FORMAT&quot;]</span>
<span class="sd">            annotation_schema_uri (str):</span>
<span class="sd">                Google Cloud Storage URI points to a YAML file describing</span>
<span class="sd">                annotation schema. The schema is defined as an OpenAPI 3.0.2</span>
<span class="sd">                [Schema Object](https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.2.md#schema-object) The schema files</span>
<span class="sd">                that can be used here are found in</span>
<span class="sd">                gs://google-cloud-aiplatform/schema/dataset/annotation/,</span>
<span class="sd">                note that the chosen schema must be consistent with</span>
<span class="sd">                ``metadata``</span>
<span class="sd">                of the Dataset specified by</span>
<span class="sd">                ``dataset_id``.</span>

<span class="sd">                Only Annotations that both match this schema and belong to</span>
<span class="sd">                DataItems not ignored by the split method are used in</span>
<span class="sd">                respectively training, validation or test role, depending on</span>
<span class="sd">                the role of the DataItem they are on.</span>

<span class="sd">                When used in conjunction with</span>
<span class="sd">                ``annotations_filter``,</span>
<span class="sd">                the Annotations used for training are filtered by both</span>
<span class="sd">                ``annotations_filter``</span>
<span class="sd">                and</span>
<span class="sd">                ``annotation_schema_uri``.</span>
<span class="sd">            model_display_name (str):</span>
<span class="sd">                If the script produces a managed Vertex AI Model. The display name of</span>
<span class="sd">                the Model. The name can be up to 128 characters long and can be consist</span>
<span class="sd">                of any UTF-8 characters.</span>

<span class="sd">                If not provided upon creation, the job&#39;s display_name is used.</span>
<span class="sd">            base_output_dir (str):</span>
<span class="sd">                GCS output directory of job. If not provided a</span>
<span class="sd">                timestamped directory in the staging directory will be used.</span>

<span class="sd">                Vertex AI sets the following environment variables when it runs your training code:</span>

<span class="sd">                -  AIP_MODEL_DIR: a Cloud Storage URI of a directory intended for saving model artifacts, i.e. &lt;base_output_dir&gt;/model/</span>
<span class="sd">                -  AIP_CHECKPOINT_DIR: a Cloud Storage URI of a directory intended for saving checkpoints, i.e. &lt;base_output_dir&gt;/checkpoints/</span>
<span class="sd">                -  AIP_TENSORBOARD_LOG_DIR: a Cloud Storage URI of a directory intended for saving TensorBoard logs, i.e. &lt;base_output_dir&gt;/logs/</span>

<span class="sd">            service_account (str):</span>
<span class="sd">                Specifies the service account for workload run-as account.</span>
<span class="sd">                Users submitting jobs must have act-as permission on this run-as account.</span>
<span class="sd">            network (str):</span>
<span class="sd">                The full name of the Compute Engine network to which the job</span>
<span class="sd">                should be peered. For example, projects/12345/global/networks/myVPC.</span>
<span class="sd">                Private services access must already be configured for the network.</span>
<span class="sd">                If left unspecified, the job is not peered with any network.</span>
<span class="sd">            bigquery_destination (str):</span>
<span class="sd">                Provide this field if `dataset` is a BiqQuery dataset.</span>
<span class="sd">                The BigQuery project location where the training data is to</span>
<span class="sd">                be written to. In the given project a new dataset is created</span>
<span class="sd">                with name</span>
<span class="sd">                ``dataset_&lt;dataset-id&gt;_&lt;annotation-type&gt;_&lt;timestamp-of-training-call&gt;``</span>
<span class="sd">                where timestamp is in YYYY_MM_DDThh_mm_ss_sssZ format. All</span>
<span class="sd">                training input data will be written into that dataset. In</span>
<span class="sd">                the dataset three tables will be created, ``training``,</span>
<span class="sd">                ``validation`` and ``test``.</span>

<span class="sd">                -  AIP_DATA_FORMAT = &quot;bigquery&quot;.</span>
<span class="sd">                -  AIP_TRAINING_DATA_URI =&quot;bigquery_destination.dataset_*.training&quot;</span>
<span class="sd">                -  AIP_VALIDATION_DATA_URI = &quot;bigquery_destination.dataset_*.validation&quot;</span>
<span class="sd">                -  AIP_TEST_DATA_URI = &quot;bigquery_destination.dataset_*.test&quot;</span>
<span class="sd">            args (List[Unions[str, int, float]]):</span>
<span class="sd">                Command line arguments to be passed to the Python script.</span>
<span class="sd">            environment_variables (Dict[str, str]):</span>
<span class="sd">                Environment variables to be passed to the container.</span>
<span class="sd">                Should be a dictionary where keys are environment variable names</span>
<span class="sd">                and values are environment variable values for those names.</span>
<span class="sd">                At most 10 environment variables can be specified.</span>
<span class="sd">                The Name of the environment variable must be unique.</span>

<span class="sd">                environment_variables = {</span>
<span class="sd">                    &#39;MY_KEY&#39;: &#39;MY_VALUE&#39;</span>
<span class="sd">                }</span>
<span class="sd">            replica_count (int):</span>
<span class="sd">                The number of worker replicas. If replica count = 1 then one chief</span>
<span class="sd">                replica will be provisioned. If replica_count &gt; 1 the remainder will be</span>
<span class="sd">                provisioned as a worker replica pool.</span>
<span class="sd">            machine_type (str):</span>
<span class="sd">                The type of machine to use for training.</span>
<span class="sd">            accelerator_type (str):</span>
<span class="sd">                Hardware accelerator type. One of ACCELERATOR_TYPE_UNSPECIFIED,</span>
<span class="sd">                NVIDIA_TESLA_K80, NVIDIA_TESLA_P100, NVIDIA_TESLA_V100, NVIDIA_TESLA_P4,</span>
<span class="sd">                NVIDIA_TESLA_T4</span>
<span class="sd">            accelerator_count (int):</span>
<span class="sd">                The number of accelerators to attach to a worker replica.</span>
<span class="sd">            training_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to train the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            validation_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to validate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            test_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to evaluate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            predefined_split_column_name (str):</span>
<span class="sd">                Optional. The key is a name of one of the Dataset&#39;s data</span>
<span class="sd">                columns. The value of the key (either the label&#39;s value or</span>
<span class="sd">                value in the column) must be one of {``training``,</span>
<span class="sd">                ``validation``, ``test``}, and it defines to which set the</span>
<span class="sd">                given piece of data is assigned. If for a piece of data the</span>
<span class="sd">                key is not present or has an invalid value, that piece is</span>
<span class="sd">                ignored by the pipeline.</span>

<span class="sd">                Supported only for tabular and time series Datasets.</span>
<span class="sd">            tensorboard (str):</span>
<span class="sd">                Optional. The name of an Vertex AI</span>
<span class="sd">                [Tensorboard][google.cloud.aiplatform.v1beta1.Tensorboard]</span>
<span class="sd">                resource to which this CustomJob will upload Tensorboard</span>
<span class="sd">                logs. Format:</span>
<span class="sd">                ``projects/{project}/locations/{location}/tensorboards/{tensorboard}``</span>

<span class="sd">                The training script should write Tensorboard to following Vertex AI environment</span>
<span class="sd">                variable:</span>

<span class="sd">                AIP_TENSORBOARD_LOG_DIR</span>

<span class="sd">                `service_account` is required with provided `tensorboard`.</span>
<span class="sd">                For more information on configuring your service account please visit:</span>
<span class="sd">                https://cloud.google.com/vertex-ai/docs/experiments/tensorboard-training</span>
<span class="sd">            sync (bool):</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model: The trained Vertex AI Model resource or None if training did not</span>
<span class="sd">                produce an Vertex AI Model.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If Training job has already been run, staging_bucket has not</span>
<span class="sd">                been set, or model_display_name was provided but required arguments</span>
<span class="sd">                were not provided in constructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">worker_pool_specs</span><span class="p">,</span> <span class="n">managed_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_and_validate_run</span><span class="p">(</span>
            <span class="n">model_display_name</span><span class="o">=</span><span class="n">model_display_name</span><span class="p">,</span>
            <span class="n">replica_count</span><span class="o">=</span><span class="n">replica_count</span><span class="p">,</span>
            <span class="n">machine_type</span><span class="o">=</span><span class="n">machine_type</span><span class="p">,</span>
            <span class="n">accelerator_count</span><span class="o">=</span><span class="n">accelerator_count</span><span class="p">,</span>
            <span class="n">accelerator_type</span><span class="o">=</span><span class="n">accelerator_type</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">annotation_schema_uri</span><span class="o">=</span><span class="n">annotation_schema_uri</span><span class="p">,</span>
            <span class="n">worker_pool_specs</span><span class="o">=</span><span class="n">worker_pool_specs</span><span class="p">,</span>
            <span class="n">managed_model</span><span class="o">=</span><span class="n">managed_model</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
            <span class="n">environment_variables</span><span class="o">=</span><span class="n">environment_variables</span><span class="p">,</span>
            <span class="n">base_output_dir</span><span class="o">=</span><span class="n">base_output_dir</span><span class="p">,</span>
            <span class="n">service_account</span><span class="o">=</span><span class="n">service_account</span><span class="p">,</span>
            <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
            <span class="n">bigquery_destination</span><span class="o">=</span><span class="n">bigquery_destination</span><span class="p">,</span>
            <span class="n">training_fraction_split</span><span class="o">=</span><span class="n">training_fraction_split</span><span class="p">,</span>
            <span class="n">validation_fraction_split</span><span class="o">=</span><span class="n">validation_fraction_split</span><span class="p">,</span>
            <span class="n">test_fraction_split</span><span class="o">=</span><span class="n">test_fraction_split</span><span class="p">,</span>
            <span class="n">predefined_split_column_name</span><span class="o">=</span><span class="n">predefined_split_column_name</span><span class="p">,</span>
            <span class="n">tensorboard</span><span class="o">=</span><span class="n">tensorboard</span><span class="p">,</span>
            <span class="n">sync</span><span class="o">=</span><span class="n">sync</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@base</span><span class="o">.</span><span class="n">optional_sync</span><span class="p">(</span><span class="n">construct_object_on_arg</span><span class="o">=</span><span class="s2">&quot;managed_model&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Union</span><span class="p">[</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">ImageDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">TabularDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">TextDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">VideoDataset</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">],</span>
        <span class="n">annotation_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">worker_pool_specs</span><span class="p">:</span> <span class="n">worker_spec_utils</span><span class="o">.</span><span class="n">_DistributedTrainingSpec</span><span class="p">,</span>
        <span class="n">managed_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">gca_model</span><span class="o">.</span><span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">environment_variables</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">service_account</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bigquery_destination</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">validation_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">test_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">predefined_split_column_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tensorboard</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Packages local script and launches training_job.</span>
<span class="sd">        Args:</span>
<span class="sd">            dataset (</span>
<span class="sd">                Union[</span>
<span class="sd">                    datasets.ImageDataset,</span>
<span class="sd">                    datasets.TabularDataset,</span>
<span class="sd">                    datasets.TextDataset,</span>
<span class="sd">                    datasets.VideoDataset,</span>
<span class="sd">                ]</span>
<span class="sd">            ):</span>
<span class="sd">                Vertex AI to fit this training against.</span>
<span class="sd">            annotation_schema_uri (str):</span>
<span class="sd">                Google Cloud Storage URI points to a YAML file describing</span>
<span class="sd">                annotation schema.</span>
<span class="sd">            worker_pools_spec (worker_spec_utils._DistributedTrainingSpec):</span>
<span class="sd">                Worker pools pecs required to run job.</span>
<span class="sd">            managed_model (gca_model.Model):</span>
<span class="sd">                Model proto if this script produces a Managed Model.</span>
<span class="sd">            args (List[Unions[str, int, float]]):</span>
<span class="sd">                Command line arguments to be passed to the Python script.</span>
<span class="sd">            environment_variables (Dict[str, str]):</span>
<span class="sd">                Environment variables to be passed to the container.</span>
<span class="sd">                Should be a dictionary where keys are environment variable names</span>
<span class="sd">                and values are environment variable values for those names.</span>
<span class="sd">                At most 10 environment variables can be specified.</span>
<span class="sd">                The Name of the environment variable must be unique.</span>

<span class="sd">                environment_variables = {</span>
<span class="sd">                    &#39;MY_KEY&#39;: &#39;MY_VALUE&#39;</span>
<span class="sd">                }</span>
<span class="sd">            base_output_dir (str):</span>
<span class="sd">                GCS output directory of job. If not provided a</span>
<span class="sd">                timestamped directory in the staging directory will be used.</span>

<span class="sd">                Vertex AI sets the following environment variables when it runs your training code:</span>

<span class="sd">                -  AIP_MODEL_DIR: a Cloud Storage URI of a directory intended for saving model artifacts, i.e. &lt;base_output_dir&gt;/model/</span>
<span class="sd">                -  AIP_CHECKPOINT_DIR: a Cloud Storage URI of a directory intended for saving checkpoints, i.e. &lt;base_output_dir&gt;/checkpoints/</span>
<span class="sd">                -  AIP_TENSORBOARD_LOG_DIR: a Cloud Storage URI of a directory intended for saving TensorBoard logs, i.e. &lt;base_output_dir&gt;/logs/</span>

<span class="sd">            service_account (str):</span>
<span class="sd">                Specifies the service account for workload run-as account.</span>
<span class="sd">                Users submitting jobs must have act-as permission on this run-as account.</span>
<span class="sd">            network (str):</span>
<span class="sd">                The full name of the Compute Engine network to which the job</span>
<span class="sd">                should be peered. For example, projects/12345/global/networks/myVPC.</span>
<span class="sd">                Private services access must already be configured for the network.</span>
<span class="sd">                If left unspecified, the job is not peered with any network.</span>
<span class="sd">            bigquery_destination (str):</span>
<span class="sd">                The BigQuery project location where the training data is to</span>
<span class="sd">                be written to. In the given project a new dataset is created</span>
<span class="sd">                with name</span>
<span class="sd">                ``dataset_&lt;dataset-id&gt;_&lt;annotation-type&gt;_&lt;timestamp-of-training-call&gt;``</span>
<span class="sd">                where timestamp is in YYYY_MM_DDThh_mm_ss_sssZ format. All</span>
<span class="sd">                training input data will be written into that dataset. In</span>
<span class="sd">                the dataset three tables will be created, ``training``,</span>
<span class="sd">                ``validation`` and ``test``.</span>

<span class="sd">                -  AIP_DATA_FORMAT = &quot;bigquery&quot;.</span>
<span class="sd">                -  AIP_TRAINING_DATA_URI =&quot;bigquery_destination.dataset_*.training&quot;</span>
<span class="sd">                -  AIP_VALIDATION_DATA_URI = &quot;bigquery_destination.dataset_*.validation&quot;</span>
<span class="sd">                -  AIP_TEST_DATA_URI = &quot;bigquery_destination.dataset_*.test&quot;</span>
<span class="sd">            training_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to train the Model.</span>
<span class="sd">            validation_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to validate the Model.</span>
<span class="sd">            test_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to evaluate the Model.</span>
<span class="sd">            predefined_split_column_name (str):</span>
<span class="sd">                Optional. The key is a name of one of the Dataset&#39;s data</span>
<span class="sd">                columns. The value of the key (either the label&#39;s value or</span>
<span class="sd">                value in the column) must be one of {``training``,</span>
<span class="sd">                ``validation``, ``test``}, and it defines to which set the</span>
<span class="sd">                given piece of data is assigned. If for a piece of data the</span>
<span class="sd">                key is not present or has an invalid value, that piece is</span>
<span class="sd">                ignored by the pipeline.</span>

<span class="sd">                Supported only for tabular and time series Datasets.</span>
<span class="sd">            tensorboard (str):</span>
<span class="sd">                Optional. The name of an Vertex AI</span>
<span class="sd">                [Tensorboard][google.cloud.aiplatform.v1beta1.Tensorboard]</span>
<span class="sd">                resource to which this CustomJob will upload Tensorboard</span>
<span class="sd">                logs. Format:</span>
<span class="sd">                ``projects/{project}/locations/{location}/tensorboards/{tensorboard}``</span>

<span class="sd">                The training script should write Tensorboard to following Vertex AI environment</span>
<span class="sd">                variable:</span>

<span class="sd">                AIP_TENSORBOARD_LOG_DIR</span>

<span class="sd">                `service_account` is required with provided `tensorboard`.</span>
<span class="sd">                For more information on configuring your service account please visit:</span>
<span class="sd">                https://cloud.google.com/vertex-ai/docs/experiments/tensorboard-training</span>
<span class="sd">            sync (bool):</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model: The trained Vertex AI Model resource or None if training did not</span>
<span class="sd">                produce an Vertex AI Model.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">worker_pool_specs</span><span class="p">:</span>
            <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;containerSpec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;imageUri&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_container_uri</span><span class="p">}</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command</span><span class="p">:</span>
                <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;containerSpec&quot;</span><span class="p">][</span><span class="s2">&quot;command&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command</span>

            <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;containerSpec&quot;</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>

            <span class="k">if</span> <span class="n">environment_variables</span><span class="p">:</span>
                <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;containerSpec&quot;</span><span class="p">][</span><span class="s2">&quot;env&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">environment_variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">]</span>

        <span class="p">(</span>
            <span class="n">training_task_inputs</span><span class="p">,</span>
            <span class="n">base_output_dir</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_training_task_inputs_and_output_dir</span><span class="p">(</span>
            <span class="n">worker_pool_specs</span><span class="o">=</span><span class="n">worker_pool_specs</span><span class="p">,</span>
            <span class="n">base_output_dir</span><span class="o">=</span><span class="n">base_output_dir</span><span class="p">,</span>
            <span class="n">service_account</span><span class="o">=</span><span class="n">service_account</span><span class="p">,</span>
            <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
            <span class="n">tensorboard</span><span class="o">=</span><span class="n">tensorboard</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span>
            <span class="n">training_task_definition</span><span class="o">=</span><span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">custom_task</span><span class="p">,</span>
            <span class="n">training_task_inputs</span><span class="o">=</span><span class="n">training_task_inputs</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">annotation_schema_uri</span><span class="o">=</span><span class="n">annotation_schema_uri</span><span class="p">,</span>
            <span class="n">training_fraction_split</span><span class="o">=</span><span class="n">training_fraction_split</span><span class="p">,</span>
            <span class="n">validation_fraction_split</span><span class="o">=</span><span class="n">validation_fraction_split</span><span class="p">,</span>
            <span class="n">test_fraction_split</span><span class="o">=</span><span class="n">test_fraction_split</span><span class="p">,</span>
            <span class="n">predefined_split_column_name</span><span class="o">=</span><span class="n">predefined_split_column_name</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">managed_model</span><span class="p">,</span>
            <span class="n">gcs_destination_uri_prefix</span><span class="o">=</span><span class="n">base_output_dir</span><span class="p">,</span>
            <span class="n">bigquery_destination</span><span class="o">=</span><span class="n">bigquery_destination</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="AutoMLTabularTrainingJob"><a class="viewcode-back" href="../../../../aiplatform.html#google.cloud.aiplatform.AutoMLTabularTrainingJob">[docs]</a><span class="k">class</span> <span class="nc">AutoMLTabularTrainingJob</span><span class="p">(</span><span class="n">_TrainingJob</span><span class="p">):</span>
    <span class="n">_supported_training_schemas</span> <span class="o">=</span> <span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">automl_tabular</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">display_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">optimization_prediction_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">optimization_objective</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">column_transformations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">optimization_objective_recall_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">optimization_objective_precision_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">project</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">location</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">auth_credentials</span><span class="o">.</span><span class="n">Credentials</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs a AutoML Tabular Training Job.</span>

<span class="sd">        Args:</span>
<span class="sd">            display_name (str):</span>
<span class="sd">                Required. The user-defined name of this TrainingPipeline.</span>
<span class="sd">            optimization_prediction_type (str):</span>
<span class="sd">                The type of prediction the Model is to produce.</span>
<span class="sd">                &quot;classification&quot; - Predict one out of multiple target values is</span>
<span class="sd">                picked for each row.</span>
<span class="sd">                &quot;regression&quot; - Predict a value based on its relation to other values.</span>
<span class="sd">                This type is available only to columns that contain</span>
<span class="sd">                semantically numeric values, i.e. integers or floating</span>
<span class="sd">                point number, even if stored as e.g. strings.</span>

<span class="sd">            optimization_objective (str):</span>
<span class="sd">                Optional. Objective function the Model is to be optimized towards. The training</span>
<span class="sd">                task creates a Model that maximizes/minimizes the value of the objective</span>
<span class="sd">                function over the validation set.</span>

<span class="sd">                The supported optimization objectives depend on the prediction type, and</span>
<span class="sd">                in the case of classification also the number of distinct values in the</span>
<span class="sd">                target column (two distint values -&gt; binary, 3 or more distinct values</span>
<span class="sd">                -&gt; multi class).</span>
<span class="sd">                If the field is not set, the default objective function is used.</span>

<span class="sd">                Classification (binary):</span>
<span class="sd">                &quot;maximize-au-roc&quot; (default) - Maximize the area under the receiver</span>
<span class="sd">                                            operating characteristic (ROC) curve.</span>
<span class="sd">                &quot;minimize-log-loss&quot; - Minimize log loss.</span>
<span class="sd">                &quot;maximize-au-prc&quot; - Maximize the area under the precision-recall curve.</span>
<span class="sd">                &quot;maximize-precision-at-recall&quot; - Maximize precision for a specified</span>
<span class="sd">                                                recall value.</span>
<span class="sd">                &quot;maximize-recall-at-precision&quot; - Maximize recall for a specified</span>
<span class="sd">                                                precision value.</span>

<span class="sd">                Classification (multi class):</span>
<span class="sd">                &quot;minimize-log-loss&quot; (default) - Minimize log loss.</span>

<span class="sd">                Regression:</span>
<span class="sd">                &quot;minimize-rmse&quot; (default) - Minimize root-mean-squared error (RMSE).</span>
<span class="sd">                &quot;minimize-mae&quot; - Minimize mean-absolute error (MAE).</span>
<span class="sd">                &quot;minimize-rmsle&quot; - Minimize root-mean-squared log error (RMSLE).</span>
<span class="sd">            column_transformations (Optional[Union[Dict, List[Dict]]]):</span>
<span class="sd">                Optional. Transformations to apply to the input columns (i.e. columns other</span>
<span class="sd">                than the targetColumn). Each transformation may produce multiple</span>
<span class="sd">                result values from the column&#39;s value, and all are used for training.</span>
<span class="sd">                When creating transformation for BigQuery Struct column, the column</span>
<span class="sd">                should be flattened using &quot;.&quot; as the delimiter.</span>
<span class="sd">                If an input column has no transformations on it, such a column is</span>
<span class="sd">                ignored by the training, except for the targetColumn, which should have</span>
<span class="sd">                no transformations defined on.</span>
<span class="sd">            optimization_objective_recall_value (float):</span>
<span class="sd">                Optional. Required when maximize-precision-at-recall optimizationObjective was</span>
<span class="sd">                picked, represents the recall value at which the optimization is done.</span>

<span class="sd">                The minimum value is 0 and the maximum is 1.0.</span>
<span class="sd">            optimization_objective_precision_value (float):</span>
<span class="sd">                Optional. Required when maximize-recall-at-precision optimizationObjective was</span>
<span class="sd">                picked, represents the precision value at which the optimization is</span>
<span class="sd">                done.</span>

<span class="sd">                The minimum value is 0 and the maximum is 1.0.</span>
<span class="sd">            project (str):</span>
<span class="sd">                Optional. Project to run training in. Overrides project set in aiplatform.init.</span>
<span class="sd">            location (str):</span>
<span class="sd">                Optional. Location to run training in. Overrides location set in aiplatform.init.</span>
<span class="sd">            credentials (auth_credentials.Credentials):</span>
<span class="sd">                Optional. Custom credentials to use to run call training service. Overrides</span>
<span class="sd">                credentials set in aiplatform.init.</span>
<span class="sd">            training_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the training pipeline. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, this TrainingPipeline will be secured by this key.</span>

<span class="sd">                Note: Model trained by this TrainingPipeline is also secured</span>
<span class="sd">                by this key if ``model_to_upload`` is not set separately.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">            model_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the model. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, the trained Model will be secured by this key.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span>
            <span class="n">training_encryption_spec_key_name</span><span class="o">=</span><span class="n">training_encryption_spec_key_name</span><span class="p">,</span>
            <span class="n">model_encryption_spec_key_name</span><span class="o">=</span><span class="n">model_encryption_spec_key_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_column_transformations</span> <span class="o">=</span> <span class="n">column_transformations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_objective</span> <span class="o">=</span> <span class="n">optimization_objective</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_prediction_type</span> <span class="o">=</span> <span class="n">optimization_prediction_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_objective_recall_value</span> <span class="o">=</span> <span class="n">optimization_objective_recall_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_objective_precision_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">optimization_objective_precision_value</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_additional_experiments</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="AutoMLTabularTrainingJob.run"><a class="viewcode-back" href="../../../../aiplatform.html#google.cloud.aiplatform.AutoMLTabularTrainingJob.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">TabularDataset</span><span class="p">,</span>
        <span class="n">target_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">training_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">validation_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">test_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">predefined_split_column_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">weight_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">budget_milli_node_hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">model_display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">disable_early_stopping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">sync</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Runs the training job and returns a model.</span>

<span class="sd">        Data fraction splits:</span>
<span class="sd">        Any of ``training_fraction_split``, ``validation_fraction_split`` and</span>
<span class="sd">        ``test_fraction_split`` may optionally be provided, they must sum to up to 1. If</span>
<span class="sd">        the provided ones sum to less than 1, the remainder is assigned to sets as</span>
<span class="sd">        decided by Vertex AI. If none of the fractions are set, by default roughly 80%</span>
<span class="sd">        of data will be used for training, 10% for validation, and 10% for test.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (datasets.TabularDataset):</span>
<span class="sd">                Required. The dataset within the same Project from which data will be used to train the Model. The</span>
<span class="sd">                Dataset must use schema compatible with Model being trained,</span>
<span class="sd">                and what is compatible should be described in the used</span>
<span class="sd">                TrainingPipeline&#39;s [training_task_definition]</span>
<span class="sd">                [google.cloud.aiplatform.v1beta1.TrainingPipeline.training_task_definition].</span>
<span class="sd">                For tabular Datasets, all their data is exported to</span>
<span class="sd">                training, to pick and choose from.</span>
<span class="sd">            training_fraction_split (float):</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to train the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            validation_fraction_split (float):</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to validate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            test_fraction_split (float):</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to evaluate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            predefined_split_column_name (str):</span>
<span class="sd">                Optional. The key is a name of one of the Dataset&#39;s data</span>
<span class="sd">                columns. The value of the key (either the label&#39;s value or</span>
<span class="sd">                value in the column) must be one of {``training``,</span>
<span class="sd">                ``validation``, ``test``}, and it defines to which set the</span>
<span class="sd">                given piece of data is assigned. If for a piece of data the</span>
<span class="sd">                key is not present or has an invalid value, that piece is</span>
<span class="sd">                ignored by the pipeline.</span>

<span class="sd">                Supported only for tabular and time series Datasets.</span>
<span class="sd">            weight_column (str):</span>
<span class="sd">                Optional. Name of the column that should be used as the weight column.</span>
<span class="sd">                Higher values in this column give more importance to the row</span>
<span class="sd">                during Model training. The column must have numeric values between 0 and</span>
<span class="sd">                10000 inclusively, and 0 value means that the row is ignored.</span>
<span class="sd">                If the weight column field is not set, then all rows are assumed to have</span>
<span class="sd">                equal weight of 1.</span>
<span class="sd">            budget_milli_node_hours (int):</span>
<span class="sd">                Optional. The train budget of creating this Model, expressed in milli node</span>
<span class="sd">                hours i.e. 1,000 value in this field means 1 node hour.</span>
<span class="sd">                The training cost of the model will not exceed this budget. The final</span>
<span class="sd">                cost will be attempted to be close to the budget, though may end up</span>
<span class="sd">                being (even) noticeably smaller - at the backend&#39;s discretion. This</span>
<span class="sd">                especially may happen when further model training ceases to provide</span>
<span class="sd">                any improvements.</span>
<span class="sd">                If the budget is set to a value known to be insufficient to train a</span>
<span class="sd">                Model for the given training set, the training won&#39;t be attempted and</span>
<span class="sd">                will error.</span>
<span class="sd">                The minimum value is 1000 and the maximum is 72000.</span>
<span class="sd">            model_display_name (str):</span>
<span class="sd">                Optional. If the script produces a managed Vertex AI Model. The display name of</span>
<span class="sd">                the Model. The name can be up to 128 characters long and can be consist</span>
<span class="sd">                of any UTF-8 characters.</span>

<span class="sd">                If not provided upon creation, the job&#39;s display_name is used.</span>
<span class="sd">            disable_early_stopping (bool):</span>
<span class="sd">                Required. If true, the entire budget is used. This disables the early stopping</span>
<span class="sd">                feature. By default, the early stopping feature is enabled, which means</span>
<span class="sd">                that training might stop before the entire training budget has been</span>
<span class="sd">                used, if further training does no longer brings significant improvement</span>
<span class="sd">                to the model.</span>
<span class="sd">            sync (bool):</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>
<span class="sd">        Returns:</span>
<span class="sd">            model: The trained Vertex AI Model resource or None if training did not</span>
<span class="sd">                produce an Vertex AI Model.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If Training job has already been run or is waiting to run.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_waiting_to_run</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AutoML Tabular Training is already scheduled to run.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_run</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AutoML Tabular Training has already run.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">target_column</span><span class="o">=</span><span class="n">target_column</span><span class="p">,</span>
            <span class="n">training_fraction_split</span><span class="o">=</span><span class="n">training_fraction_split</span><span class="p">,</span>
            <span class="n">validation_fraction_split</span><span class="o">=</span><span class="n">validation_fraction_split</span><span class="p">,</span>
            <span class="n">test_fraction_split</span><span class="o">=</span><span class="n">test_fraction_split</span><span class="p">,</span>
            <span class="n">predefined_split_column_name</span><span class="o">=</span><span class="n">predefined_split_column_name</span><span class="p">,</span>
            <span class="n">weight_column</span><span class="o">=</span><span class="n">weight_column</span><span class="p">,</span>
            <span class="n">budget_milli_node_hours</span><span class="o">=</span><span class="n">budget_milli_node_hours</span><span class="p">,</span>
            <span class="n">model_display_name</span><span class="o">=</span><span class="n">model_display_name</span><span class="p">,</span>
            <span class="n">disable_early_stopping</span><span class="o">=</span><span class="n">disable_early_stopping</span><span class="p">,</span>
            <span class="n">sync</span><span class="o">=</span><span class="n">sync</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@base</span><span class="o">.</span><span class="n">optional_sync</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">TabularDataset</span><span class="p">,</span>
        <span class="n">target_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">training_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">validation_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">test_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">predefined_split_column_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">weight_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">budget_milli_node_hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">model_display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">disable_early_stopping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">sync</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Runs the training job and returns a model.</span>

<span class="sd">        Data fraction splits:</span>
<span class="sd">        Any of ``training_fraction_split``, ``validation_fraction_split`` and</span>
<span class="sd">        ``test_fraction_split`` may optionally be provided, they must sum to up to 1. If</span>
<span class="sd">        the provided ones sum to less than 1, the remainder is assigned to sets as</span>
<span class="sd">        decided by Vertex AI. If none of the fractions are set, by default roughly 80%</span>
<span class="sd">        of data will be used for training, 10% for validation, and 10% for test.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (datasets.TabularDataset):</span>
<span class="sd">                Required. The dataset within the same Project from which data will be used to train the Model. The</span>
<span class="sd">                Dataset must use schema compatible with Model being trained,</span>
<span class="sd">                and what is compatible should be described in the used</span>
<span class="sd">                TrainingPipeline&#39;s [training_task_definition]</span>
<span class="sd">                [google.cloud.aiplatform.v1beta1.TrainingPipeline.training_task_definition].</span>
<span class="sd">                For tabular Datasets, all their data is exported to</span>
<span class="sd">                training, to pick and choose from.</span>
<span class="sd">            training_fraction_split (float):</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to train the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            validation_fraction_split (float):</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to validate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            test_fraction_split (float):</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to evaluate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            predefined_split_column_name (str):</span>
<span class="sd">                Optional. The key is a name of one of the Dataset&#39;s data</span>
<span class="sd">                columns. The value of the key (either the label&#39;s value or</span>
<span class="sd">                value in the column) must be one of {``training``,</span>
<span class="sd">                ``validation``, ``test``}, and it defines to which set the</span>
<span class="sd">                given piece of data is assigned. If for a piece of data the</span>
<span class="sd">                key is not present or has an invalid value, that piece is</span>
<span class="sd">                ignored by the pipeline.</span>

<span class="sd">                Supported only for tabular and time series Datasets.</span>
<span class="sd">            weight_column (str):</span>
<span class="sd">                Optional. Name of the column that should be used as the weight column.</span>
<span class="sd">                Higher values in this column give more importance to the row</span>
<span class="sd">                during Model training. The column must have numeric values between 0 and</span>
<span class="sd">                10000 inclusively, and 0 value means that the row is ignored.</span>
<span class="sd">                If the weight column field is not set, then all rows are assumed to have</span>
<span class="sd">                equal weight of 1.</span>
<span class="sd">            budget_milli_node_hours (int):</span>
<span class="sd">                Optional. The train budget of creating this Model, expressed in milli node</span>
<span class="sd">                hours i.e. 1,000 value in this field means 1 node hour.</span>
<span class="sd">                The training cost of the model will not exceed this budget. The final</span>
<span class="sd">                cost will be attempted to be close to the budget, though may end up</span>
<span class="sd">                being (even) noticeably smaller - at the backend&#39;s discretion. This</span>
<span class="sd">                especially may happen when further model training ceases to provide</span>
<span class="sd">                any improvements.</span>
<span class="sd">                If the budget is set to a value known to be insufficient to train a</span>
<span class="sd">                Model for the given training set, the training won&#39;t be attempted and</span>
<span class="sd">                will error.</span>
<span class="sd">                The minimum value is 1000 and the maximum is 72000.</span>
<span class="sd">            model_display_name (str):</span>
<span class="sd">                Optional. If the script produces a managed Vertex AI Model. The display name of</span>
<span class="sd">                the Model. The name can be up to 128 characters long and can be consist</span>
<span class="sd">                of any UTF-8 characters.</span>

<span class="sd">                If not provided upon creation, the job&#39;s display_name is used.</span>
<span class="sd">            disable_early_stopping (bool):</span>
<span class="sd">                Required. If true, the entire budget is used. This disables the early stopping</span>
<span class="sd">                feature. By default, the early stopping feature is enabled, which means</span>
<span class="sd">                that training might stop before the entire training budget has been</span>
<span class="sd">                used, if further training does no longer brings significant improvement</span>
<span class="sd">                to the model.</span>
<span class="sd">            sync (bool):</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model: The trained Vertex AI Model resource or None if training did not</span>
<span class="sd">                produce an Vertex AI Model.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">training_task_definition</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">automl_tabular</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_transformations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;No column transformations provided, so now retrieving columns from dataset in order to set default column transformations.&quot;</span>
            <span class="p">)</span>

            <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">column_name</span>
                <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">column_names</span>
                <span class="k">if</span> <span class="n">column_name</span> <span class="o">!=</span> <span class="n">target_column</span>
            <span class="p">]</span>
            <span class="n">column_transformations</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;auto&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;column_name&quot;</span><span class="p">:</span> <span class="n">column_name</span><span class="p">}}</span> <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">column_names</span>
            <span class="p">]</span>

            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;The column transformation of type &#39;auto&#39; was set for the following columns: </span><span class="si">%s</span><span class="s2">.&quot;</span>
                <span class="o">%</span> <span class="n">column_names</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">column_transformations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_transformations</span>

        <span class="n">training_task_inputs_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># required inputs</span>
            <span class="s2">&quot;targetColumn&quot;</span><span class="p">:</span> <span class="n">target_column</span><span class="p">,</span>
            <span class="s2">&quot;transformations&quot;</span><span class="p">:</span> <span class="n">column_transformations</span><span class="p">,</span>
            <span class="s2">&quot;trainBudgetMilliNodeHours&quot;</span><span class="p">:</span> <span class="n">budget_milli_node_hours</span><span class="p">,</span>
            <span class="c1"># optional inputs</span>
            <span class="s2">&quot;weightColumnName&quot;</span><span class="p">:</span> <span class="n">weight_column</span><span class="p">,</span>
            <span class="s2">&quot;disableEarlyStopping&quot;</span><span class="p">:</span> <span class="n">disable_early_stopping</span><span class="p">,</span>
            <span class="s2">&quot;optimizationObjective&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_objective</span><span class="p">,</span>
            <span class="s2">&quot;predictionType&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_prediction_type</span><span class="p">,</span>
            <span class="s2">&quot;optimizationObjectiveRecallValue&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_objective_recall_value</span><span class="p">,</span>
            <span class="s2">&quot;optimizationObjectivePrecisionValue&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_objective_precision_value</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_additional_experiments</span><span class="p">:</span>
            <span class="n">training_task_inputs_dict</span><span class="p">[</span>
                <span class="s2">&quot;additionalExperiments&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_additional_experiments</span>

        <span class="k">if</span> <span class="n">model_display_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_display_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_name</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">gca_model</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
            <span class="n">display_name</span><span class="o">=</span><span class="n">model_display_name</span><span class="p">,</span>
            <span class="n">encryption_spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_encryption_spec</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span>
            <span class="n">training_task_definition</span><span class="o">=</span><span class="n">training_task_definition</span><span class="p">,</span>
            <span class="n">training_task_inputs</span><span class="o">=</span><span class="n">training_task_inputs_dict</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">training_fraction_split</span><span class="o">=</span><span class="n">training_fraction_split</span><span class="p">,</span>
            <span class="n">validation_fraction_split</span><span class="o">=</span><span class="n">validation_fraction_split</span><span class="p">,</span>
            <span class="n">test_fraction_split</span><span class="o">=</span><span class="n">test_fraction_split</span><span class="p">,</span>
            <span class="n">predefined_split_column_name</span><span class="o">=</span><span class="n">predefined_split_column_name</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_model_upload_fail_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Helper property for model upload failure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Training Pipeline </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_name</span><span class="si">}</span><span class="s2"> is not configured to upload a &quot;</span>
            <span class="s2">&quot;Model.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_additional_experiments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">additional_experiments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Add experiment flags to the training job.</span>
<span class="sd">        Args:</span>
<span class="sd">            additional_experiments (List[str]):</span>
<span class="sd">                Experiment flags that can enable some experimental training features.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_additional_experiments</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">additional_experiments</span><span class="p">)</span></div>


<div class="viewcode-block" id="AutoMLForecastingTrainingJob"><a class="viewcode-back" href="../../../../aiplatform.html#google.cloud.aiplatform.AutoMLForecastingTrainingJob">[docs]</a><span class="k">class</span> <span class="nc">AutoMLForecastingTrainingJob</span><span class="p">(</span><span class="n">_TrainingJob</span><span class="p">):</span>
    <span class="n">_supported_training_schemas</span> <span class="o">=</span> <span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">automl_forecasting</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">display_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">optimization_objective</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">column_transformations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">project</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">location</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">auth_credentials</span><span class="o">.</span><span class="n">Credentials</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs a AutoML Forecasting Training Job.</span>

<span class="sd">        Args:</span>
<span class="sd">            display_name (str):</span>
<span class="sd">                Required. The user-defined name of this TrainingPipeline.</span>
<span class="sd">            optimization_objective (str):</span>
<span class="sd">                Optional. Objective function the model is to be optimized towards.</span>
<span class="sd">                The training process creates a Model that optimizes the value of the objective</span>
<span class="sd">                function over the validation set. The supported optimization objectives:</span>
<span class="sd">                &quot;minimize-rmse&quot; (default) - Minimize root-mean-squared error (RMSE).</span>
<span class="sd">                &quot;minimize-mae&quot; - Minimize mean-absolute error (MAE).</span>
<span class="sd">                &quot;minimize-rmsle&quot; - Minimize root-mean-squared log error (RMSLE).</span>
<span class="sd">                &quot;minimize-rmspe&quot; - Minimize root-mean-squared percentage error (RMSPE).</span>
<span class="sd">                &quot;minimize-wape-mae&quot; - Minimize the combination of weighted absolute percentage error (WAPE)</span>
<span class="sd">                                      and mean-absolute-error (MAE).</span>
<span class="sd">                &quot;minimize-quantile-loss&quot; - Minimize the quantile loss at the defined quantiles.</span>
<span class="sd">                                           (Set this objective to build quantile forecasts.)</span>
<span class="sd">            column_transformations (Optional[Union[Dict, List[Dict]]]):</span>
<span class="sd">                Optional. Transformations to apply to the input columns (i.e. columns other</span>
<span class="sd">                than the targetColumn). Each transformation may produce multiple</span>
<span class="sd">                result values from the column&#39;s value, and all are used for training.</span>
<span class="sd">                When creating transformation for BigQuery Struct column, the column</span>
<span class="sd">                should be flattened using &quot;.&quot; as the delimiter.</span>
<span class="sd">                If an input column has no transformations on it, such a column is</span>
<span class="sd">                ignored by the training, except for the targetColumn, which should have</span>
<span class="sd">                no transformations defined on.</span>
<span class="sd">            project (str):</span>
<span class="sd">                Optional. Project to run training in. Overrides project set in aiplatform.init.</span>
<span class="sd">            location (str):</span>
<span class="sd">                Optional. Location to run training in. Overrides location set in aiplatform.init.</span>
<span class="sd">            credentials (auth_credentials.Credentials):</span>
<span class="sd">                Optional. Custom credentials to use to run call training service. Overrides</span>
<span class="sd">                credentials set in aiplatform.init.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_column_transformations</span> <span class="o">=</span> <span class="n">column_transformations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_objective</span> <span class="o">=</span> <span class="n">optimization_objective</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_additional_experiments</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="AutoMLForecastingTrainingJob.run"><a class="viewcode-back" href="../../../../aiplatform.html#google.cloud.aiplatform.AutoMLForecastingTrainingJob.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">TimeSeriesDataset</span><span class="p">,</span>
        <span class="n">target_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">time_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">time_series_identifier_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">unavailable_at_forecast_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">available_at_forecast_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">forecast_horizon</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">data_granularity_unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">data_granularity_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">predefined_split_column_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">weight_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">time_series_attribute_columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">context_window</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">export_evaluated_data_items</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">export_evaluated_data_items_bigquery_destination_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">export_evaluated_data_items_override_destination</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">quantiles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">validation_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">budget_milli_node_hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">model_display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sync</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Runs the training job and returns a model.</span>

<span class="sd">        The training data splits are set by default: Roughly 80% will be used for training,</span>
<span class="sd">        10% for validation, and 10% for test.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (datasets.Dataset):</span>
<span class="sd">                Required. The dataset within the same Project from which data will be used to train the Model. The</span>
<span class="sd">                Dataset must use schema compatible with Model being trained,</span>
<span class="sd">                and what is compatible should be described in the used</span>
<span class="sd">                TrainingPipeline&#39;s [training_task_definition]</span>
<span class="sd">                [google.cloud.aiplatform.v1beta1.TrainingPipeline.training_task_definition].</span>
<span class="sd">                For time series Datasets, all their data is exported to</span>
<span class="sd">                training, to pick and choose from.</span>
<span class="sd">            target_column (str):</span>
<span class="sd">                Required. Name of the column that the Model is to predict values for.</span>
<span class="sd">            time_column (str):</span>
<span class="sd">                Required. Name of the column that identifies time order in the time series.</span>
<span class="sd">            time_series_identifier_column (str):</span>
<span class="sd">                Required. Name of the column that identifies the time series.</span>
<span class="sd">            unavailable_at_forecast_columns (List[str]):</span>
<span class="sd">                Required. Column names of columns that are unavailable at forecast.</span>
<span class="sd">                Each column contains information for the given entity (identified by the</span>
<span class="sd">                [time_series_identifier_column]) that is unknown before the forecast</span>
<span class="sd">                (e.g. population of a city in a given year, or weather on a given day).</span>
<span class="sd">            available_at_forecast_columns (List[str]):</span>
<span class="sd">                Required. Column names of columns that are available at forecast.</span>
<span class="sd">                Each column contains information for the given entity (identified by the</span>
<span class="sd">                [time_series_identifier_column]) that is known at forecast.</span>
<span class="sd">            forecast_horizon: (int):</span>
<span class="sd">                Required. The amount of time into the future for which forecasted values for the target are</span>
<span class="sd">                returned. Expressed in number of units defined by the [data_granularity_unit] and</span>
<span class="sd">                [data_granularity_count] field. Inclusive.</span>
<span class="sd">            data_granularity_unit (str):</span>
<span class="sd">                Required. The data granularity unit. Accepted values are ``minute``,</span>
<span class="sd">                ``hour``, ``day``, ``week``, ``month``, ``year``.</span>
<span class="sd">            data_granularity_count (int):</span>
<span class="sd">                Required. The number of data granularity units between data points in the training</span>
<span class="sd">                data. If [data_granularity_unit] is `minute`, can be 1, 5, 10, 15, or 30. For all other</span>
<span class="sd">                values of [data_granularity_unit], must be 1.</span>
<span class="sd">            predefined_split_column_name (str):</span>
<span class="sd">                Optional. The key is a name of one of the Dataset&#39;s data</span>
<span class="sd">                columns. The value of the key (either the label&#39;s value or</span>
<span class="sd">                value in the column) must be one of {``TRAIN``,</span>
<span class="sd">                ``VALIDATE``, ``TEST``}, and it defines to which set the</span>
<span class="sd">                given piece of data is assigned. If for a piece of data the</span>
<span class="sd">                key is not present or has an invalid value, that piece is</span>
<span class="sd">                ignored by the pipeline.</span>

<span class="sd">                Supported only for tabular and time series Datasets.</span>
<span class="sd">            weight_column (str):</span>
<span class="sd">                Optional. Name of the column that should be used as the weight column.</span>
<span class="sd">                Higher values in this column give more importance to the row</span>
<span class="sd">                during Model training. The column must have numeric values between 0 and</span>
<span class="sd">                10000 inclusively, and 0 value means that the row is ignored.</span>
<span class="sd">                If the weight column field is not set, then all rows are assumed to have</span>
<span class="sd">                equal weight of 1.</span>
<span class="sd">            time_series_attribute_columns (List[str]):</span>
<span class="sd">                Optional. Column names that should be used as attribute columns.</span>
<span class="sd">                Each column is constant within a time series.</span>
<span class="sd">            context_window (int):</span>
<span class="sd">                Optional. The amount of time into the past training and prediction data is used for</span>
<span class="sd">                model training and prediction respectively. Expressed in number of units defined by the</span>
<span class="sd">                [data_granularity_unit] and [data_granularity_count] fields. When not provided uses the</span>
<span class="sd">                default value of 0 which means the model sets each series context window to be 0 (also</span>
<span class="sd">                known as &quot;cold start&quot;). Inclusive.</span>
<span class="sd">            export_evaluated_data_items (bool):</span>
<span class="sd">                Whether to export the test set predictions to a BigQuery table.</span>
<span class="sd">                If False, then the export is not performed.</span>
<span class="sd">            export_evaluated_data_items_bigquery_destination_uri (string):</span>
<span class="sd">                Optional. URI of desired destination BigQuery table for exported test set predictions.</span>

<span class="sd">                Expected format:</span>
<span class="sd">                ``bq://&lt;project_id&gt;:&lt;dataset_id&gt;:&lt;table&gt;``</span>

<span class="sd">                If not specified, then results are exported to the following auto-created BigQuery</span>
<span class="sd">                table:</span>
<span class="sd">                ``&lt;project_id&gt;:export_evaluated_examples_&lt;model_name&gt;_&lt;yyyy_MM_dd&#39;T&#39;HH_mm_ss_SSS&#39;Z&#39;&gt;.evaluated_examples``</span>

<span class="sd">                Applies only if [export_evaluated_data_items] is True.</span>
<span class="sd">            export_evaluated_data_items_override_destination (bool):</span>
<span class="sd">                Whether to override the contents of [export_evaluated_data_items_bigquery_destination_uri],</span>
<span class="sd">                if the table exists, for exported test set predictions. If False, and the</span>
<span class="sd">                table exists, then the training job will fail.</span>

<span class="sd">                Applies only if [export_evaluated_data_items] is True and</span>
<span class="sd">                [export_evaluated_data_items_bigquery_destination_uri] is specified.</span>
<span class="sd">            quantiles (List[float]):</span>
<span class="sd">                Quantiles to use for the `minizmize-quantile-loss`</span>
<span class="sd">                [AutoMLForecastingTrainingJob.optimization_objective]. This argument is required in</span>
<span class="sd">                this case.</span>

<span class="sd">                Accepts up to 5 quantiles in the form of a double from 0 to 1, exclusive.</span>
<span class="sd">                Each quantile must be unique.</span>
<span class="sd">            validation_options (str):</span>
<span class="sd">                Validation options for the data validation component. The available options are:</span>
<span class="sd">                &quot;fail-pipeline&quot; - (default), will validate against the validation and fail the pipeline</span>
<span class="sd">                                  if it fails.</span>
<span class="sd">                &quot;ignore-validation&quot; - ignore the results of the validation and continue the pipeline</span>
<span class="sd">            budget_milli_node_hours (int):</span>
<span class="sd">                Optional. The train budget of creating this Model, expressed in milli node</span>
<span class="sd">                hours i.e. 1,000 value in this field means 1 node hour.</span>
<span class="sd">                The training cost of the model will not exceed this budget. The final</span>
<span class="sd">                cost will be attempted to be close to the budget, though may end up</span>
<span class="sd">                being (even) noticeably smaller - at the backend&#39;s discretion. This</span>
<span class="sd">                especially may happen when further model training ceases to provide</span>
<span class="sd">                any improvements.</span>
<span class="sd">                If the budget is set to a value known to be insufficient to train a</span>
<span class="sd">                Model for the given training set, the training won&#39;t be attempted and</span>
<span class="sd">                will error.</span>
<span class="sd">                The minimum value is 1000 and the maximum is 72000.</span>
<span class="sd">            model_display_name (str):</span>
<span class="sd">                Optional. If the script produces a managed Vertex AI Model. The display name of</span>
<span class="sd">                the Model. The name can be up to 128 characters long and can be consist</span>
<span class="sd">                of any UTF-8 characters.</span>

<span class="sd">                If not provided upon creation, the job&#39;s display_name is used.</span>
<span class="sd">            sync (bool):</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>
<span class="sd">        Returns:</span>
<span class="sd">            model: The trained Vertex AI Model resource or None if training did not</span>
<span class="sd">                produce an Vertex AI Model.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError if Training job has already been run or is waiting to run.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_waiting_to_run</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;AutoML Forecasting Training is already scheduled to run.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_run</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AutoML Forecasting Training has already run.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">target_column</span><span class="o">=</span><span class="n">target_column</span><span class="p">,</span>
            <span class="n">time_column</span><span class="o">=</span><span class="n">time_column</span><span class="p">,</span>
            <span class="n">time_series_identifier_column</span><span class="o">=</span><span class="n">time_series_identifier_column</span><span class="p">,</span>
            <span class="n">unavailable_at_forecast_columns</span><span class="o">=</span><span class="n">unavailable_at_forecast_columns</span><span class="p">,</span>
            <span class="n">available_at_forecast_columns</span><span class="o">=</span><span class="n">available_at_forecast_columns</span><span class="p">,</span>
            <span class="n">forecast_horizon</span><span class="o">=</span><span class="n">forecast_horizon</span><span class="p">,</span>
            <span class="n">data_granularity_unit</span><span class="o">=</span><span class="n">data_granularity_unit</span><span class="p">,</span>
            <span class="n">data_granularity_count</span><span class="o">=</span><span class="n">data_granularity_count</span><span class="p">,</span>
            <span class="n">predefined_split_column_name</span><span class="o">=</span><span class="n">predefined_split_column_name</span><span class="p">,</span>
            <span class="n">weight_column</span><span class="o">=</span><span class="n">weight_column</span><span class="p">,</span>
            <span class="n">time_series_attribute_columns</span><span class="o">=</span><span class="n">time_series_attribute_columns</span><span class="p">,</span>
            <span class="n">context_window</span><span class="o">=</span><span class="n">context_window</span><span class="p">,</span>
            <span class="n">budget_milli_node_hours</span><span class="o">=</span><span class="n">budget_milli_node_hours</span><span class="p">,</span>
            <span class="n">export_evaluated_data_items</span><span class="o">=</span><span class="n">export_evaluated_data_items</span><span class="p">,</span>
            <span class="n">export_evaluated_data_items_bigquery_destination_uri</span><span class="o">=</span><span class="n">export_evaluated_data_items_bigquery_destination_uri</span><span class="p">,</span>
            <span class="n">export_evaluated_data_items_override_destination</span><span class="o">=</span><span class="n">export_evaluated_data_items_override_destination</span><span class="p">,</span>
            <span class="n">quantiles</span><span class="o">=</span><span class="n">quantiles</span><span class="p">,</span>
            <span class="n">validation_options</span><span class="o">=</span><span class="n">validation_options</span><span class="p">,</span>
            <span class="n">model_display_name</span><span class="o">=</span><span class="n">model_display_name</span><span class="p">,</span>
            <span class="n">sync</span><span class="o">=</span><span class="n">sync</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@base</span><span class="o">.</span><span class="n">optional_sync</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">TimeSeriesDataset</span><span class="p">,</span>
        <span class="n">target_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">time_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">time_series_identifier_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">unavailable_at_forecast_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">available_at_forecast_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">forecast_horizon</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">data_granularity_unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">data_granularity_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">predefined_split_column_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">weight_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">time_series_attribute_columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">context_window</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">export_evaluated_data_items</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">export_evaluated_data_items_bigquery_destination_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">export_evaluated_data_items_override_destination</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">quantiles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">validation_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">budget_milli_node_hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">model_display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sync</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Runs the training job and returns a model.</span>

<span class="sd">        The training data splits are set by default: Roughly 80% will be used for training,</span>
<span class="sd">        10% for validation, and 10% for test.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (datasets.Dataset):</span>
<span class="sd">                Required. The dataset within the same Project from which data will be used to train the Model. The</span>
<span class="sd">                Dataset must use schema compatible with Model being trained,</span>
<span class="sd">                and what is compatible should be described in the used</span>
<span class="sd">                TrainingPipeline&#39;s [training_task_definition]</span>
<span class="sd">                [google.cloud.aiplatform.v1beta1.TrainingPipeline.training_task_definition].</span>
<span class="sd">                For time series Datasets, all their data is exported to</span>
<span class="sd">                training, to pick and choose from.</span>
<span class="sd">            target_column (str):</span>
<span class="sd">                Required. Name of the column that the Model is to predict values for.</span>
<span class="sd">            time_column (str):</span>
<span class="sd">                Required. Name of the column that identifies time order in the time series.</span>
<span class="sd">            time_series_identifier_column (str):</span>
<span class="sd">                Required. Name of the column that identifies the time series.</span>
<span class="sd">            unavailable_at_forecast_columns (List[str]):</span>
<span class="sd">                Required. Column names of columns that are unavailable at forecast.</span>
<span class="sd">                Each column contains information for the given entity (identified by the</span>
<span class="sd">                [time_series_identifier_column]) that is unknown before the forecast</span>
<span class="sd">                (e.g. population of a city in a given year, or weather on a given day).</span>
<span class="sd">            available_at_forecast_columns (List[str]):</span>
<span class="sd">                Required. Column names of columns that are available at forecast.</span>
<span class="sd">                Each column contains information for the given entity (identified by the</span>
<span class="sd">                [time_series_identifier_column]) that is known at forecast.</span>
<span class="sd">            forecast_horizon: (int):</span>
<span class="sd">                Required. The amount of time into the future for which forecasted values for the target are</span>
<span class="sd">                returned. Expressed in number of units defined by the [data_granularity_unit] and</span>
<span class="sd">                [data_granularity_count] field. Inclusive.</span>
<span class="sd">            data_granularity_unit (str):</span>
<span class="sd">                Required. The data granularity unit. Accepted values are ``minute``,</span>
<span class="sd">                ``hour``, ``day``, ``week``, ``month``, ``year``.</span>
<span class="sd">            data_granularity_count (int):</span>
<span class="sd">                Required. The number of data granularity units between data points in the training</span>
<span class="sd">                data. If [data_granularity_unit] is `minute`, can be 1, 5, 10, 15, or 30. For all other</span>
<span class="sd">                values of [data_granularity_unit], must be 1.</span>
<span class="sd">            predefined_split_column_name (str):</span>
<span class="sd">                Optional. The key is a name of one of the Dataset&#39;s data</span>
<span class="sd">                columns. The value of the key (either the label&#39;s value or</span>
<span class="sd">                value in the column) must be one of {``TRAIN``,</span>
<span class="sd">                ``VALIDATE``, ``TEST``}, and it defines to which set the</span>
<span class="sd">                given piece of data is assigned. If for a piece of data the</span>
<span class="sd">                key is not present or has an invalid value, that piece is</span>
<span class="sd">                ignored by the pipeline.</span>

<span class="sd">                Supported only for tabular and time series Datasets.</span>
<span class="sd">            weight_column (str):</span>
<span class="sd">                Optional. Name of the column that should be used as the weight column.</span>
<span class="sd">                Higher values in this column give more importance to the row</span>
<span class="sd">                during Model training. The column must have numeric values between 0 and</span>
<span class="sd">                10000 inclusively, and 0 value means that the row is ignored.</span>
<span class="sd">                If the weight column field is not set, then all rows are assumed to have</span>
<span class="sd">                equal weight of 1.</span>
<span class="sd">            time_series_attribute_columns (List[str]):</span>
<span class="sd">                Optional. Column names that should be used as attribute columns.</span>
<span class="sd">                Each column is constant within a time series.</span>
<span class="sd">            context_window (int):</span>
<span class="sd">                Optional. The number of periods offset into the past to restrict past sequence, where each</span>
<span class="sd">                period is one unit of granularity as defined by [period]. When not provided uses the</span>
<span class="sd">                default value of 0 which means the model sets each series historical window to be 0 (also</span>
<span class="sd">                known as &quot;cold start&quot;). Inclusive.</span>
<span class="sd">            export_evaluated_data_items (bool):</span>
<span class="sd">                Whether to export the test set predictions to a BigQuery table.</span>
<span class="sd">                If False, then the export is not performed.</span>
<span class="sd">            export_evaluated_data_items_bigquery_destination_uri (string):</span>
<span class="sd">                Optional. URI of desired destination BigQuery table for exported test set predictions.</span>

<span class="sd">                Expected format:</span>
<span class="sd">                ``bq://&lt;project_id&gt;:&lt;dataset_id&gt;:&lt;table&gt;``</span>

<span class="sd">                If not specified, then results are exported to the following auto-created BigQuery</span>
<span class="sd">                table:</span>
<span class="sd">                ``&lt;project_id&gt;:export_evaluated_examples_&lt;model_name&gt;_&lt;yyyy_MM_dd&#39;T&#39;HH_mm_ss_SSS&#39;Z&#39;&gt;.evaluated_examples``</span>

<span class="sd">                Applies only if [export_evaluated_data_items] is True.</span>
<span class="sd">            export_evaluated_data_items_override_destination (bool):</span>
<span class="sd">                Whether to override the contents of [export_evaluated_data_items_bigquery_destination_uri],</span>
<span class="sd">                if the table exists, for exported test set predictions. If False, and the</span>
<span class="sd">                table exists, then the training job will fail.</span>

<span class="sd">                Applies only if [export_evaluated_data_items] is True and</span>
<span class="sd">                [export_evaluated_data_items_bigquery_destination_uri] is specified.</span>
<span class="sd">            quantiles (List[float]):</span>
<span class="sd">                Quantiles to use for the `minizmize-quantile-loss`</span>
<span class="sd">                [AutoMLForecastingTrainingJob.optimization_objective]. This argument is required in</span>
<span class="sd">                this case.</span>

<span class="sd">                Accepts up to 5 quantiles in the form of a double from 0 to 1, exclusive.</span>
<span class="sd">                Each quantile must be unique.</span>
<span class="sd">            validation_options (str):</span>
<span class="sd">                Validation options for the data validation component. The available options are:</span>
<span class="sd">                &quot;fail-pipeline&quot; - (default), will validate against the validation and fail the pipeline</span>
<span class="sd">                                  if it fails.</span>
<span class="sd">                &quot;ignore-validation&quot; - ignore the results of the validation and continue the pipeline</span>
<span class="sd">            budget_milli_node_hours (int):</span>
<span class="sd">                Optional. The train budget of creating this Model, expressed in milli node</span>
<span class="sd">                hours i.e. 1,000 value in this field means 1 node hour.</span>
<span class="sd">                The training cost of the model will not exceed this budget. The final</span>
<span class="sd">                cost will be attempted to be close to the budget, though may end up</span>
<span class="sd">                being (even) noticeably smaller - at the backend&#39;s discretion. This</span>
<span class="sd">                especially may happen when further model training ceases to provide</span>
<span class="sd">                any improvements.</span>
<span class="sd">                If the budget is set to a value known to be insufficient to train a</span>
<span class="sd">                Model for the given training set, the training won&#39;t be attempted and</span>
<span class="sd">                will error.</span>
<span class="sd">                The minimum value is 1000 and the maximum is 72000.</span>
<span class="sd">            model_display_name (str):</span>
<span class="sd">                Optional. If the script produces a managed Vertex AI Model. The display name of</span>
<span class="sd">                the Model. The name can be up to 128 characters long and can be consist</span>
<span class="sd">                of any UTF-8 characters.</span>

<span class="sd">                If not provided upon creation, the job&#39;s display_name is used.</span>
<span class="sd">            sync (bool):</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>
<span class="sd">        Returns:</span>
<span class="sd">            model: The trained Vertex AI Model resource or None if training did not</span>
<span class="sd">                produce an Vertex AI Model.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">training_task_definition</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">automl_forecasting</span>

        <span class="n">training_task_inputs_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># required inputs</span>
            <span class="s2">&quot;targetColumn&quot;</span><span class="p">:</span> <span class="n">target_column</span><span class="p">,</span>
            <span class="s2">&quot;timeColumn&quot;</span><span class="p">:</span> <span class="n">time_column</span><span class="p">,</span>
            <span class="s2">&quot;timeSeriesIdentifierColumn&quot;</span><span class="p">:</span> <span class="n">time_series_identifier_column</span><span class="p">,</span>
            <span class="s2">&quot;timeSeriesAttributeColumns&quot;</span><span class="p">:</span> <span class="n">time_series_attribute_columns</span><span class="p">,</span>
            <span class="s2">&quot;unavailableAtForecastColumns&quot;</span><span class="p">:</span> <span class="n">unavailable_at_forecast_columns</span><span class="p">,</span>
            <span class="s2">&quot;availableAtForecastColumns&quot;</span><span class="p">:</span> <span class="n">available_at_forecast_columns</span><span class="p">,</span>
            <span class="s2">&quot;forecastHorizon&quot;</span><span class="p">:</span> <span class="n">forecast_horizon</span><span class="p">,</span>
            <span class="s2">&quot;dataGranularity&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="n">data_granularity_unit</span><span class="p">,</span>
                <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="n">data_granularity_count</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;transformations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_transformations</span><span class="p">,</span>
            <span class="s2">&quot;trainBudgetMilliNodeHours&quot;</span><span class="p">:</span> <span class="n">budget_milli_node_hours</span><span class="p">,</span>
            <span class="c1"># optional inputs</span>
            <span class="s2">&quot;weightColumn&quot;</span><span class="p">:</span> <span class="n">weight_column</span><span class="p">,</span>
            <span class="s2">&quot;contextWindow&quot;</span><span class="p">:</span> <span class="n">context_window</span><span class="p">,</span>
            <span class="s2">&quot;quantiles&quot;</span><span class="p">:</span> <span class="n">quantiles</span><span class="p">,</span>
            <span class="s2">&quot;validationOptions&quot;</span><span class="p">:</span> <span class="n">validation_options</span><span class="p">,</span>
            <span class="s2">&quot;optimizationObjective&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_objective</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">final_export_eval_bq_uri</span> <span class="o">=</span> <span class="n">export_evaluated_data_items_bigquery_destination_uri</span>
        <span class="k">if</span> <span class="n">final_export_eval_bq_uri</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">final_export_eval_bq_uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
            <span class="s2">&quot;bq://&quot;</span>
        <span class="p">):</span>
            <span class="n">final_export_eval_bq_uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;bq://</span><span class="si">{</span><span class="n">final_export_eval_bq_uri</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">export_evaluated_data_items</span><span class="p">:</span>
            <span class="n">training_task_inputs_dict</span><span class="p">[</span><span class="s2">&quot;exportEvaluatedDataItemsConfig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;destinationBigqueryUri&quot;</span><span class="p">:</span> <span class="n">final_export_eval_bq_uri</span><span class="p">,</span>
                <span class="s2">&quot;overrideExistingTable&quot;</span><span class="p">:</span> <span class="n">export_evaluated_data_items_override_destination</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_additional_experiments</span><span class="p">:</span>
            <span class="n">training_task_inputs_dict</span><span class="p">[</span>
                <span class="s2">&quot;additionalExperiments&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_additional_experiments</span>

        <span class="k">if</span> <span class="n">model_display_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_display_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_name</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">gca_model</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">display_name</span><span class="o">=</span><span class="n">model_display_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span>
            <span class="n">training_task_definition</span><span class="o">=</span><span class="n">training_task_definition</span><span class="p">,</span>
            <span class="n">training_task_inputs</span><span class="o">=</span><span class="n">training_task_inputs_dict</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">training_fraction_split</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">validation_fraction_split</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">test_fraction_split</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">predefined_split_column_name</span><span class="o">=</span><span class="n">predefined_split_column_name</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_model_upload_fail_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Helper property for model upload failure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Training Pipeline </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_name</span><span class="si">}</span><span class="s2"> is not configured to upload a &quot;</span>
            <span class="s2">&quot;Model.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_additional_experiments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">additional_experiments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Add experiment flags to the training job.</span>
<span class="sd">        Args:</span>
<span class="sd">            additional_experiments (List[str]):</span>
<span class="sd">                Experiment flags that can enable some experimental training features.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_additional_experiments</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">additional_experiments</span><span class="p">)</span></div>


<div class="viewcode-block" id="AutoMLImageTrainingJob"><a class="viewcode-back" href="../../../../aiplatform.html#google.cloud.aiplatform.AutoMLImageTrainingJob">[docs]</a><span class="k">class</span> <span class="nc">AutoMLImageTrainingJob</span><span class="p">(</span><span class="n">_TrainingJob</span><span class="p">):</span>
    <span class="n">_supported_training_schemas</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">automl_image_classification</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">automl_image_object_detection</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">display_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">prediction_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;classification&quot;</span><span class="p">,</span>
        <span class="n">multi_label</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">model_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CLOUD&quot;</span><span class="p">,</span>
        <span class="n">base_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">project</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">location</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">auth_credentials</span><span class="o">.</span><span class="n">Credentials</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs a AutoML Image Training Job.</span>

<span class="sd">        Args:</span>
<span class="sd">            display_name (str):</span>
<span class="sd">                Required. The user-defined name of this TrainingPipeline.</span>
<span class="sd">            prediction_type (str):</span>
<span class="sd">                The type of prediction the Model is to produce, one of:</span>
<span class="sd">                    &quot;classification&quot; - Predict one out of multiple target values is</span>
<span class="sd">                        picked for each row.</span>
<span class="sd">                    &quot;object_detection&quot; - Predict a value based on its relation to other values.</span>
<span class="sd">                        This type is available only to columns that contain</span>
<span class="sd">                        semantically numeric values, i.e. integers or floating</span>
<span class="sd">                        point number, even if stored as e.g. strings.</span>
<span class="sd">            multi_label: bool = False</span>
<span class="sd">                Required. Default is False.</span>
<span class="sd">                If false, a single-label (multi-class) Model will be trained</span>
<span class="sd">                (i.e. assuming that for each image just up to one annotation may be</span>
<span class="sd">                applicable). If true, a multi-label Model will be trained (i.e.</span>
<span class="sd">                assuming that for each image multiple annotations may be applicable).</span>

<span class="sd">                This is only applicable for the &quot;classification&quot; prediction_type and</span>
<span class="sd">                will be ignored otherwise.</span>
<span class="sd">            model_type: str = &quot;CLOUD&quot;</span>
<span class="sd">                Required. One of the following:</span>
<span class="sd">                    &quot;CLOUD&quot; - Default for Image Classification.</span>
<span class="sd">                        A Model best tailored to be used within Google Cloud, and</span>
<span class="sd">                        which cannot be exported.</span>
<span class="sd">                    &quot;CLOUD_HIGH_ACCURACY_1&quot; - Default for Image Object Detection.</span>
<span class="sd">                        A model best tailored to be used within Google Cloud, and</span>
<span class="sd">                        which cannot be exported. Expected to have a higher latency,</span>
<span class="sd">                        but should also have a higher prediction quality than other</span>
<span class="sd">                        cloud models.</span>
<span class="sd">                    &quot;CLOUD_LOW_LATENCY_1&quot; - A model best tailored to be used within</span>
<span class="sd">                        Google Cloud, and which cannot be exported. Expected to have a</span>
<span class="sd">                        low latency, but may have lower prediction quality than other</span>
<span class="sd">                        cloud models.</span>
<span class="sd">                    &quot;MOBILE_TF_LOW_LATENCY_1&quot; - A model that, in addition to being</span>
<span class="sd">                        available within Google Cloud, can also be exported as TensorFlow</span>
<span class="sd">                        or Core ML model and used on a mobile or edge device afterwards.</span>
<span class="sd">                        Expected to have low latency, but may have lower prediction</span>
<span class="sd">                        quality than other mobile models.</span>
<span class="sd">                    &quot;MOBILE_TF_VERSATILE_1&quot; - A model that, in addition to being</span>
<span class="sd">                        available within Google Cloud, can also be exported as TensorFlow</span>
<span class="sd">                        or Core ML model and used on a mobile or edge device with afterwards.</span>
<span class="sd">                    &quot;MOBILE_TF_HIGH_ACCURACY_1&quot; - A model that, in addition to being</span>
<span class="sd">                        available within Google Cloud, can also be exported as TensorFlow</span>
<span class="sd">                        or Core ML model and used on a mobile or edge device afterwards.</span>
<span class="sd">                        Expected to have a higher latency, but should also have a higher</span>
<span class="sd">                        prediction quality than other mobile models.</span>
<span class="sd">            base_model: Optional[models.Model] = None</span>
<span class="sd">                Optional. Only permitted for Image Classification models.</span>
<span class="sd">                If it is specified, the new model will be trained based on the `base` model.</span>
<span class="sd">                Otherwise, the new model will be trained from scratch. The `base` model</span>
<span class="sd">                must be in the same Project and Location as the new Model to train,</span>
<span class="sd">                and have the same model_type.</span>
<span class="sd">            project (str):</span>
<span class="sd">                Optional. Project to run training in. Overrides project set in aiplatform.init.</span>
<span class="sd">            location (str):</span>
<span class="sd">                Optional. Location to run training in. Overrides location set in aiplatform.init.</span>
<span class="sd">            credentials (auth_credentials.Credentials):</span>
<span class="sd">                Optional. Custom credentials to use to run call training service. Overrides</span>
<span class="sd">                credentials set in aiplatform.init.</span>
<span class="sd">            training_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the training pipeline. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, this TrainingPipeline will be secured by this key.</span>

<span class="sd">                Note: Model trained by this TrainingPipeline is also secured</span>
<span class="sd">                by this key if ``model_to_upload`` is not set separately.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">            model_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the model. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, the trained Model will be secured by this key.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: When an invalid prediction_type or model_type is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">valid_model_types</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">AUTOML_IMAGE_PREDICTION_MODEL_TYPES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">prediction_type</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_model_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">prediction_type</span><span class="si">}</span><span class="s2">&#39; is not a supported prediction type for AutoML Image Training. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please choose one of: </span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">AUTOML_IMAGE_PREDICTION_MODEL_TYPES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Override default model_type for object_detection</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;CLOUD&quot;</span> <span class="ow">and</span> <span class="n">prediction_type</span> <span class="o">==</span> <span class="s2">&quot;object_detection&quot;</span><span class="p">:</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;CLOUD_HIGH_ACCURACY_1&quot;</span>

        <span class="k">if</span> <span class="n">model_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_model_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&#39; is not a supported model_type for prediction_type of &#39;</span><span class="si">{</span><span class="n">prediction_type</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please choose one of: </span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">valid_model_types</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">base_model</span> <span class="ow">and</span> <span class="n">prediction_type</span> <span class="o">!=</span> <span class="s2">&quot;classification&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Training with a `base_model` is only supported in AutoML Image Classification. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;However &#39;</span><span class="si">{</span><span class="n">prediction_type</span><span class="si">}</span><span class="s2">&#39; was provided as `prediction_type`.&quot;</span>
            <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span>
            <span class="n">training_encryption_spec_key_name</span><span class="o">=</span><span class="n">training_encryption_spec_key_name</span><span class="p">,</span>
            <span class="n">model_encryption_spec_key_name</span><span class="o">=</span><span class="n">model_encryption_spec_key_name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span> <span class="o">=</span> <span class="n">model_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prediction_type</span> <span class="o">=</span> <span class="n">prediction_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_multi_label</span> <span class="o">=</span> <span class="n">multi_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_model</span> <span class="o">=</span> <span class="n">base_model</span>

<div class="viewcode-block" id="AutoMLImageTrainingJob.run"><a class="viewcode-back" href="../../../../aiplatform.html#google.cloud.aiplatform.AutoMLImageTrainingJob.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">ImageDataset</span><span class="p">,</span>
        <span class="n">training_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">validation_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">test_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">budget_milli_node_hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">model_display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">disable_early_stopping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">sync</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Runs the AutoML Image training job and returns a model.</span>

<span class="sd">        Data fraction splits:</span>
<span class="sd">        Any of ``training_fraction_split``, ``validation_fraction_split`` and</span>
<span class="sd">        ``test_fraction_split`` may optionally be provided, they must sum to up to 1. If</span>
<span class="sd">        the provided ones sum to less than 1, the remainder is assigned to sets as</span>
<span class="sd">        decided by Vertex AI. If none of the fractions are set, by default roughly 80%</span>
<span class="sd">        of data will be used for training, 10% for validation, and 10% for test.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (datasets.ImageDataset):</span>
<span class="sd">                Required. The dataset within the same Project from which data will be used to train the Model. The</span>
<span class="sd">                Dataset must use schema compatible with Model being trained,</span>
<span class="sd">                and what is compatible should be described in the used</span>
<span class="sd">                TrainingPipeline&#39;s [training_task_definition]</span>
<span class="sd">                [google.cloud.aiplatform.v1beta1.TrainingPipeline.training_task_definition].</span>
<span class="sd">                For tabular Datasets, all their data is exported to</span>
<span class="sd">                training, to pick and choose from.</span>
<span class="sd">            training_fraction_split: float = 0.8</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to train the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            validation_fraction_split: float = 0.1</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to validate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            test_fraction_split: float = 0.1</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to evaluate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            budget_milli_node_hours: int = 1000</span>
<span class="sd">                Optional. The train budget of creating this Model, expressed in milli node</span>
<span class="sd">                hours i.e. 1,000 value in this field means 1 node hour.</span>
<span class="sd">                The training cost of the model will not exceed this budget. The final</span>
<span class="sd">                cost will be attempted to be close to the budget, though may end up</span>
<span class="sd">                being (even) noticeably smaller - at the backend&#39;s discretion. This</span>
<span class="sd">                especially may happen when further model training ceases to provide</span>
<span class="sd">                any improvements.</span>
<span class="sd">                If the budget is set to a value known to be insufficient to train a</span>
<span class="sd">                Model for the given training set, the training won&#39;t be attempted and</span>
<span class="sd">                will error.</span>
<span class="sd">                The minimum value is 1000 and the maximum is 72000.</span>
<span class="sd">            model_display_name (str):</span>
<span class="sd">                Optional. The display name of the managed Vertex AI Model. The name</span>
<span class="sd">                can be up to 128 characters long and can be consist of any UTF-8</span>
<span class="sd">                characters. If not provided upon creation, the job&#39;s display_name is used.</span>
<span class="sd">            disable_early_stopping: bool = False</span>
<span class="sd">                Required. If true, the entire budget is used. This disables the early stopping</span>
<span class="sd">                feature. By default, the early stopping feature is enabled, which means</span>
<span class="sd">                that training might stop before the entire training budget has been</span>
<span class="sd">                used, if further training does no longer brings significant improvement</span>
<span class="sd">                to the model.</span>
<span class="sd">            sync: bool = True</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>
<span class="sd">        Returns:</span>
<span class="sd">            model: The trained Vertex AI Model resource or None if training did not</span>
<span class="sd">                produce an Vertex AI Model.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If Training job has already been run or is waiting to run.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_waiting_to_run</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AutoML Image Training is already scheduled to run.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_run</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AutoML Image Training has already run.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">base_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_model</span><span class="p">,</span>
            <span class="n">training_fraction_split</span><span class="o">=</span><span class="n">training_fraction_split</span><span class="p">,</span>
            <span class="n">validation_fraction_split</span><span class="o">=</span><span class="n">validation_fraction_split</span><span class="p">,</span>
            <span class="n">test_fraction_split</span><span class="o">=</span><span class="n">test_fraction_split</span><span class="p">,</span>
            <span class="n">budget_milli_node_hours</span><span class="o">=</span><span class="n">budget_milli_node_hours</span><span class="p">,</span>
            <span class="n">model_display_name</span><span class="o">=</span><span class="n">model_display_name</span><span class="p">,</span>
            <span class="n">disable_early_stopping</span><span class="o">=</span><span class="n">disable_early_stopping</span><span class="p">,</span>
            <span class="n">sync</span><span class="o">=</span><span class="n">sync</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@base</span><span class="o">.</span><span class="n">optional_sync</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">ImageDataset</span><span class="p">,</span>
        <span class="n">base_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">validation_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">test_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">budget_milli_node_hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">model_display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">disable_early_stopping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">sync</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Runs the training job and returns a model.</span>

<span class="sd">        Data fraction splits:</span>
<span class="sd">        Any of ``training_fraction_split``, ``validation_fraction_split`` and</span>
<span class="sd">        ``test_fraction_split`` may optionally be provided, they must sum to up to 1. If</span>
<span class="sd">        the provided ones sum to less than 1, the remainder is assigned to sets as</span>
<span class="sd">        decided by Vertex AI. If none of the fractions are set, by default roughly 80%</span>
<span class="sd">        of data will be used for training, 10% for validation, and 10% for test.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (datasets.ImageDataset):</span>
<span class="sd">                Required. The dataset within the same Project from which data will be used to train the Model. The</span>
<span class="sd">                Dataset must use schema compatible with Model being trained,</span>
<span class="sd">                and what is compatible should be described in the used</span>
<span class="sd">                TrainingPipeline&#39;s [training_task_definition]</span>
<span class="sd">                [google.cloud.aiplatform.v1beta1.TrainingPipeline.training_task_definition].</span>
<span class="sd">                For tabular Datasets, all their data is exported to</span>
<span class="sd">                training, to pick and choose from.</span>
<span class="sd">            base_model: Optional[models.Model] = None</span>
<span class="sd">                Optional. Only permitted for Image Classification models.</span>
<span class="sd">                If it is specified, the new model will be trained based on the `base` model.</span>
<span class="sd">                Otherwise, the new model will be trained from scratch. The `base` model</span>
<span class="sd">                must be in the same Project and Location as the new Model to train,</span>
<span class="sd">                and have the same model_type.</span>
<span class="sd">            training_fraction_split (float):</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to train the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            validation_fraction_split (float):</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to validate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            test_fraction_split (float):</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to evaluate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            budget_milli_node_hours (int):</span>
<span class="sd">                Optional. The train budget of creating this Model, expressed in milli node</span>
<span class="sd">                hours i.e. 1,000 value in this field means 1 node hour.</span>
<span class="sd">                The training cost of the model will not exceed this budget. The final</span>
<span class="sd">                cost will be attempted to be close to the budget, though may end up</span>
<span class="sd">                being (even) noticeably smaller - at the backend&#39;s discretion. This</span>
<span class="sd">                especially may happen when further model training ceases to provide</span>
<span class="sd">                any improvements.</span>
<span class="sd">                If the budget is set to a value known to be insufficient to train a</span>
<span class="sd">                Model for the given training set, the training won&#39;t be attempted and</span>
<span class="sd">                will error.</span>
<span class="sd">                The minimum value is 1000 and the maximum is 72000.</span>
<span class="sd">            model_display_name (str):</span>
<span class="sd">                Optional. The display name of the managed Vertex AI Model. The name</span>
<span class="sd">                can be up to 128 characters long and can be consist of any UTF-8</span>
<span class="sd">                characters. If a `base_model` was provided, the display_name in the</span>
<span class="sd">                base_model will be overritten with this value. If not provided upon</span>
<span class="sd">                creation, the job&#39;s display_name is used.</span>
<span class="sd">            disable_early_stopping (bool):</span>
<span class="sd">                Required. If true, the entire budget is used. This disables the early stopping</span>
<span class="sd">                feature. By default, the early stopping feature is enabled, which means</span>
<span class="sd">                that training might stop before the entire training budget has been</span>
<span class="sd">                used, if further training does no longer brings significant improvement</span>
<span class="sd">                to the model.</span>
<span class="sd">            sync (bool):</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model: The trained Vertex AI Model resource or None if training did not</span>
<span class="sd">                produce an Vertex AI Model.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Retrieve the objective-specific training task schema based on prediction_type</span>
        <span class="n">training_task_definition</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;automl_image_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_prediction_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">training_task_inputs_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># required inputs</span>
            <span class="s2">&quot;modelType&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span><span class="p">,</span>
            <span class="s2">&quot;budgetMilliNodeHours&quot;</span><span class="p">:</span> <span class="n">budget_milli_node_hours</span><span class="p">,</span>
            <span class="c1"># optional inputs</span>
            <span class="s2">&quot;disableEarlyStopping&quot;</span><span class="p">:</span> <span class="n">disable_early_stopping</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prediction_type</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span><span class="p">:</span>
            <span class="n">training_task_inputs_dict</span><span class="p">[</span><span class="s2">&quot;multiLabel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multi_label</span>

        <span class="c1"># gca Model to be trained</span>
        <span class="n">model_tbt</span> <span class="o">=</span> <span class="n">gca_model</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">encryption_spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_encryption_spec</span><span class="p">)</span>

        <span class="n">model_tbt</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">model_display_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_name</span>

        <span class="k">if</span> <span class="n">base_model</span><span class="p">:</span>
            <span class="c1"># Use provided base_model to pass to model_to_upload causing the</span>
            <span class="c1"># description and labels from base_model to be passed onto the new model</span>
            <span class="n">model_tbt</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base_model</span><span class="o">.</span><span class="n">_gca_resource</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">)</span>
            <span class="n">model_tbt</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base_model</span><span class="o">.</span><span class="n">_gca_resource</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">)</span>

            <span class="c1"># Set ID of Vertex AI Model to base this training job off of</span>
            <span class="n">training_task_inputs_dict</span><span class="p">[</span><span class="s2">&quot;baseModelId&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_model</span><span class="o">.</span><span class="n">name</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span>
            <span class="n">training_task_definition</span><span class="o">=</span><span class="n">training_task_definition</span><span class="p">,</span>
            <span class="n">training_task_inputs</span><span class="o">=</span><span class="n">training_task_inputs_dict</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">training_fraction_split</span><span class="o">=</span><span class="n">training_fraction_split</span><span class="p">,</span>
            <span class="n">validation_fraction_split</span><span class="o">=</span><span class="n">validation_fraction_split</span><span class="p">,</span>
            <span class="n">test_fraction_split</span><span class="o">=</span><span class="n">test_fraction_split</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model_tbt</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_model_upload_fail_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Helper property for model upload failure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;AutoML Image Training Pipeline </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_name</span><span class="si">}</span><span class="s2"> is not &quot;</span>
            <span class="s2">&quot;configured to upload a Model.&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="CustomPythonPackageTrainingJob"><a class="viewcode-back" href="../../../../aiplatform.html#google.cloud.aiplatform.CustomPythonPackageTrainingJob">[docs]</a><span class="k">class</span> <span class="nc">CustomPythonPackageTrainingJob</span><span class="p">(</span><span class="n">_CustomTrainingJob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to launch a Custom Training Job in Vertex AI using a Python</span>
<span class="sd">    Package.</span>

<span class="sd">    Takes a training implementation as a python package and executes</span>
<span class="sd">    that package in Cloud Vertex AI Training.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">display_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">python_package_gcs_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">python_module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">container_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">model_serving_container_image_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_predict_route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_health_route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_environment_variables</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_serving_container_ports</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_instance_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_parameters_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_prediction_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">project</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">location</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">auth_credentials</span><span class="o">.</span><span class="n">Credentials</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">staging_bucket</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs a Custom Training Job from a Python Package.</span>

<span class="sd">        job = aiplatform.CustomPythonPackageTrainingJob(</span>
<span class="sd">            display_name=&#39;test-train&#39;,</span>
<span class="sd">            python_package_gcs_uri=&#39;gs://my-bucket/my-python-package.tar.gz&#39;,</span>
<span class="sd">            python_module_name=&#39;my-training-python-package.task&#39;,</span>
<span class="sd">            container_uri=&#39;gcr.io/cloud-aiplatform/training/tf-cpu.2-2:latest&#39;,</span>
<span class="sd">            model_serving_container_image_uri=&#39;gcr.io/my-trainer/serving:1&#39;,</span>
<span class="sd">            model_serving_container_predict_route=&#39;predict&#39;,</span>
<span class="sd">            model_serving_container_health_route=&#39;metadata</span>
<span class="sd">        )</span>

<span class="sd">        Usage with Dataset:</span>

<span class="sd">            ds = aiplatform.TabularDataset(</span>
<span class="sd">                &#39;projects/my-project/locations/us-central1/datasets/12345&#39;</span>
<span class="sd">            )</span>

<span class="sd">            job.run(</span>
<span class="sd">                ds,</span>
<span class="sd">                replica_count=1,</span>
<span class="sd">                model_display_name=&#39;my-trained-model&#39;</span>
<span class="sd">            )</span>

<span class="sd">        Usage without Dataset:</span>

<span class="sd">            job.run(</span>
<span class="sd">                replica_count=1,</span>
<span class="sd">                model_display_name=&#39;my-trained-model&#39;</span>
<span class="sd">            )</span>

<span class="sd">        To ensure your model gets saved in Vertex AI, write your saved model to</span>
<span class="sd">        os.environ[&quot;AIP_MODEL_DIR&quot;] in your provided training script.</span>

<span class="sd">        Args:</span>
<span class="sd">            display_name (str):</span>
<span class="sd">                Required. The user-defined name of this TrainingPipeline.</span>
<span class="sd">            python_package_gcs_uri (str):</span>
<span class="sd">                Required: GCS location of the training python package.</span>
<span class="sd">            python_module_name (str):</span>
<span class="sd">                Required: The module name of the training python package.</span>
<span class="sd">            container_uri (str):</span>
<span class="sd">                Required: Uri of the training container image in the GCR.</span>
<span class="sd">            model_serving_container_image_uri (str):</span>
<span class="sd">                If the training produces a managed Vertex AI Model, the URI of the</span>
<span class="sd">                Model serving container suitable for serving the model produced by the</span>
<span class="sd">                training script.</span>
<span class="sd">            model_serving_container_predict_route (str):</span>
<span class="sd">                If the training produces a managed Vertex AI Model, An HTTP path to</span>
<span class="sd">                send prediction requests to the container, and which must be supported</span>
<span class="sd">                by it. If not specified a default HTTP path will be used by Vertex AI.</span>
<span class="sd">            model_serving_container_health_route (str):</span>
<span class="sd">                If the training produces a managed Vertex AI Model, an HTTP path to</span>
<span class="sd">                send health check requests to the container, and which must be supported</span>
<span class="sd">                by it. If not specified a standard HTTP path will be used by AI</span>
<span class="sd">                Platform.</span>
<span class="sd">            model_serving_container_command (Sequence[str]):</span>
<span class="sd">                The command with which the container is run. Not executed within a</span>
<span class="sd">                shell. The Docker image&#39;s ENTRYPOINT is used if this is not provided.</span>
<span class="sd">                Variable references $(VAR_NAME) are expanded using the container&#39;s</span>
<span class="sd">                environment. If a variable cannot be resolved, the reference in the</span>
<span class="sd">                input string will be unchanged. The $(VAR_NAME) syntax can be escaped</span>
<span class="sd">                with a double $$, ie: $$(VAR_NAME). Escaped references will never be</span>
<span class="sd">                expanded, regardless of whether the variable exists or not.</span>
<span class="sd">            model_serving_container_args (Sequence[str]):</span>
<span class="sd">                The arguments to the command. The Docker image&#39;s CMD is used if this is</span>
<span class="sd">                not provided. Variable references $(VAR_NAME) are expanded using the</span>
<span class="sd">                container&#39;s environment. If a variable cannot be resolved, the reference</span>
<span class="sd">                in the input string will be unchanged. The $(VAR_NAME) syntax can be</span>
<span class="sd">                escaped with a double $$, ie: $$(VAR_NAME). Escaped references will</span>
<span class="sd">                never be expanded, regardless of whether the variable exists or not.</span>
<span class="sd">            model_serving_container_environment_variables (Dict[str, str]):</span>
<span class="sd">                The environment variables that are to be present in the container.</span>
<span class="sd">                Should be a dictionary where keys are environment variable names</span>
<span class="sd">                and values are environment variable values for those names.</span>
<span class="sd">            model_serving_container_ports (Sequence[int]):</span>
<span class="sd">                Declaration of ports that are exposed by the container. This field is</span>
<span class="sd">                primarily informational, it gives Vertex AI information about the</span>
<span class="sd">                network connections the container uses. Listing or not a port here has</span>
<span class="sd">                no impact on whether the port is actually exposed, any port listening on</span>
<span class="sd">                the default &quot;0.0.0.0&quot; address inside a container will be accessible from</span>
<span class="sd">                the network.</span>
<span class="sd">            model_description (str):</span>
<span class="sd">                The description of the Model.</span>
<span class="sd">            model_instance_schema_uri (str):</span>
<span class="sd">                Optional. Points to a YAML file stored on Google Cloud</span>
<span class="sd">                Storage describing the format of a single instance, which</span>
<span class="sd">                are used in</span>
<span class="sd">                ``PredictRequest.instances``,</span>
<span class="sd">                ``ExplainRequest.instances``</span>
<span class="sd">                and</span>
<span class="sd">                ``BatchPredictionJob.input_config``.</span>
<span class="sd">                The schema is defined as an OpenAPI 3.0.2 `Schema</span>
<span class="sd">                Object &lt;https://tinyurl.com/y538mdwt#schema-object&gt;`__.</span>
<span class="sd">                AutoML Models always have this field populated by AI</span>
<span class="sd">                Platform. Note: The URI given on output will be immutable</span>
<span class="sd">                and probably different, including the URI scheme, than the</span>
<span class="sd">                one given on input. The output URI will point to a location</span>
<span class="sd">                where the user only has a read access.</span>
<span class="sd">            model_parameters_schema_uri (str):</span>
<span class="sd">                Optional. Points to a YAML file stored on Google Cloud</span>
<span class="sd">                Storage describing the parameters of prediction and</span>
<span class="sd">                explanation via</span>
<span class="sd">                ``PredictRequest.parameters``,</span>
<span class="sd">                ``ExplainRequest.parameters``</span>
<span class="sd">                and</span>
<span class="sd">                ``BatchPredictionJob.model_parameters``.</span>
<span class="sd">                The schema is defined as an OpenAPI 3.0.2 `Schema</span>
<span class="sd">                Object &lt;https://tinyurl.com/y538mdwt#schema-object&gt;`__.</span>
<span class="sd">                AutoML Models always have this field populated by AI</span>
<span class="sd">                Platform, if no parameters are supported it is set to an</span>
<span class="sd">                empty string. Note: The URI given on output will be</span>
<span class="sd">                immutable and probably different, including the URI scheme,</span>
<span class="sd">                than the one given on input. The output URI will point to a</span>
<span class="sd">                location where the user only has a read access.</span>
<span class="sd">            model_prediction_schema_uri (str):</span>
<span class="sd">                Optional. Points to a YAML file stored on Google Cloud</span>
<span class="sd">                Storage describing the format of a single prediction</span>
<span class="sd">                produced by this Model, which are returned via</span>
<span class="sd">                ``PredictResponse.predictions``,</span>
<span class="sd">                ``ExplainResponse.explanations``,</span>
<span class="sd">                and</span>
<span class="sd">                ``BatchPredictionJob.output_config``.</span>
<span class="sd">                The schema is defined as an OpenAPI 3.0.2 `Schema</span>
<span class="sd">                Object &lt;https://tinyurl.com/y538mdwt#schema-object&gt;`__.</span>
<span class="sd">                AutoML Models always have this field populated by AI</span>
<span class="sd">                Platform. Note: The URI given on output will be immutable</span>
<span class="sd">                and probably different, including the URI scheme, than the</span>
<span class="sd">                one given on input. The output URI will point to a location</span>
<span class="sd">                where the user only has a read access.</span>
<span class="sd">            project (str):</span>
<span class="sd">                Project to run training in. Overrides project set in aiplatform.init.</span>
<span class="sd">            location (str):</span>
<span class="sd">                Location to run training in. Overrides location set in aiplatform.init.</span>
<span class="sd">            credentials (auth_credentials.Credentials):</span>
<span class="sd">                Custom credentials to use to run call training service. Overrides</span>
<span class="sd">                credentials set in aiplatform.init.</span>
<span class="sd">            training_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the training pipeline. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, this TrainingPipeline will be secured by this key.</span>

<span class="sd">                Note: Model trained by this TrainingPipeline is also secured</span>
<span class="sd">                by this key if ``model_to_upload`` is not set separately.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">            model_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the model. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, the trained Model will be secured by this key.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">            staging_bucket (str):</span>
<span class="sd">                Bucket used to stage source and training artifacts. Overrides</span>
<span class="sd">                staging_bucket set in aiplatform.init.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span>
            <span class="n">training_encryption_spec_key_name</span><span class="o">=</span><span class="n">training_encryption_spec_key_name</span><span class="p">,</span>
            <span class="n">model_encryption_spec_key_name</span><span class="o">=</span><span class="n">model_encryption_spec_key_name</span><span class="p">,</span>
            <span class="n">container_uri</span><span class="o">=</span><span class="n">container_uri</span><span class="p">,</span>
            <span class="n">model_instance_schema_uri</span><span class="o">=</span><span class="n">model_instance_schema_uri</span><span class="p">,</span>
            <span class="n">model_parameters_schema_uri</span><span class="o">=</span><span class="n">model_parameters_schema_uri</span><span class="p">,</span>
            <span class="n">model_prediction_schema_uri</span><span class="o">=</span><span class="n">model_prediction_schema_uri</span><span class="p">,</span>
            <span class="n">model_serving_container_environment_variables</span><span class="o">=</span><span class="n">model_serving_container_environment_variables</span><span class="p">,</span>
            <span class="n">model_serving_container_ports</span><span class="o">=</span><span class="n">model_serving_container_ports</span><span class="p">,</span>
            <span class="n">model_serving_container_image_uri</span><span class="o">=</span><span class="n">model_serving_container_image_uri</span><span class="p">,</span>
            <span class="n">model_serving_container_command</span><span class="o">=</span><span class="n">model_serving_container_command</span><span class="p">,</span>
            <span class="n">model_serving_container_args</span><span class="o">=</span><span class="n">model_serving_container_args</span><span class="p">,</span>
            <span class="n">model_serving_container_predict_route</span><span class="o">=</span><span class="n">model_serving_container_predict_route</span><span class="p">,</span>
            <span class="n">model_serving_container_health_route</span><span class="o">=</span><span class="n">model_serving_container_health_route</span><span class="p">,</span>
            <span class="n">model_description</span><span class="o">=</span><span class="n">model_description</span><span class="p">,</span>
            <span class="n">staging_bucket</span><span class="o">=</span><span class="n">staging_bucket</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_package_gcs_uri</span> <span class="o">=</span> <span class="n">python_package_gcs_uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_python_module</span> <span class="o">=</span> <span class="n">python_module_name</span>

<div class="viewcode-block" id="CustomPythonPackageTrainingJob.run"><a class="viewcode-back" href="../../../../aiplatform.html#google.cloud.aiplatform.CustomPythonPackageTrainingJob.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Union</span><span class="p">[</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">ImageDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">TabularDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">TextDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">VideoDataset</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">annotation_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">service_account</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bigquery_destination</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">environment_variables</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">replica_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">machine_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;n1-standard-4&quot;</span><span class="p">,</span>
        <span class="n">accelerator_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ACCELERATOR_TYPE_UNSPECIFIED&quot;</span><span class="p">,</span>
        <span class="n">accelerator_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">training_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">validation_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">test_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">predefined_split_column_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tensorboard</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Runs the custom training job.</span>

<span class="sd">        Distributed Training Support:</span>
<span class="sd">        If replica count = 1 then one chief replica will be provisioned. If</span>
<span class="sd">        replica_count &gt; 1 the remainder will be provisioned as a worker replica pool.</span>
<span class="sd">        ie: replica_count = 10 will result in 1 chief and 9 workers</span>
<span class="sd">        All replicas have same machine_type, accelerator_type, and accelerator_count</span>

<span class="sd">        Data fraction splits:</span>
<span class="sd">        Any of ``training_fraction_split``, ``validation_fraction_split`` and</span>
<span class="sd">        ``test_fraction_split`` may optionally be provided, they must sum to up to 1. If</span>
<span class="sd">        the provided ones sum to less than 1, the remainder is assigned to sets as</span>
<span class="sd">        decided by Vertex AI.If none of the fractions are set, by default roughly 80%</span>
<span class="sd">        of data will be used for training, 10% for validation, and 10% for test.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (Union[datasets.ImageDataset,datasets.TabularDataset,datasets.TextDataset,datasets.VideoDataset,]):</span>
<span class="sd">                Vertex AI to fit this training against. Custom training script should</span>
<span class="sd">                retrieve datasets through passed in environment variables uris:</span>

<span class="sd">                os.environ[&quot;AIP_TRAINING_DATA_URI&quot;]</span>
<span class="sd">                os.environ[&quot;AIP_VALIDATION_DATA_URI&quot;]</span>
<span class="sd">                os.environ[&quot;AIP_TEST_DATA_URI&quot;]</span>

<span class="sd">                Additionally the dataset format is passed in as:</span>

<span class="sd">                os.environ[&quot;AIP_DATA_FORMAT&quot;]</span>
<span class="sd">            annotation_schema_uri (str):</span>
<span class="sd">                Google Cloud Storage URI points to a YAML file describing</span>
<span class="sd">                annotation schema. The schema is defined as an OpenAPI 3.0.2</span>
<span class="sd">                [Schema Object](https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.2.md#schema-object) The schema files</span>
<span class="sd">                that can be used here are found in</span>
<span class="sd">                gs://google-cloud-aiplatform/schema/dataset/annotation/,</span>
<span class="sd">                note that the chosen schema must be consistent with</span>
<span class="sd">                ``metadata``</span>
<span class="sd">                of the Dataset specified by</span>
<span class="sd">                ``dataset_id``.</span>

<span class="sd">                Only Annotations that both match this schema and belong to</span>
<span class="sd">                DataItems not ignored by the split method are used in</span>
<span class="sd">                respectively training, validation or test role, depending on</span>
<span class="sd">                the role of the DataItem they are on.</span>

<span class="sd">                When used in conjunction with</span>
<span class="sd">                ``annotations_filter``,</span>
<span class="sd">                the Annotations used for training are filtered by both</span>
<span class="sd">                ``annotations_filter``</span>
<span class="sd">                and</span>
<span class="sd">                ``annotation_schema_uri``.</span>
<span class="sd">            model_display_name (str):</span>
<span class="sd">                If the script produces a managed Vertex AI Model. The display name of</span>
<span class="sd">                the Model. The name can be up to 128 characters long and can be consist</span>
<span class="sd">                of any UTF-8 characters.</span>

<span class="sd">                If not provided upon creation, the job&#39;s display_name is used.</span>
<span class="sd">            base_output_dir (str):</span>
<span class="sd">                GCS output directory of job. If not provided a</span>
<span class="sd">                timestamped directory in the staging directory will be used.</span>

<span class="sd">                Vertex AI sets the following environment variables when it runs your training code:</span>

<span class="sd">                -  AIP_MODEL_DIR: a Cloud Storage URI of a directory intended for saving model artifacts, i.e. &lt;base_output_dir&gt;/model/</span>
<span class="sd">                -  AIP_CHECKPOINT_DIR: a Cloud Storage URI of a directory intended for saving checkpoints, i.e. &lt;base_output_dir&gt;/checkpoints/</span>
<span class="sd">                -  AIP_TENSORBOARD_LOG_DIR: a Cloud Storage URI of a directory intended for saving TensorBoard logs, i.e. &lt;base_output_dir&gt;/logs/</span>

<span class="sd">            service_account (str):</span>
<span class="sd">                Specifies the service account for workload run-as account.</span>
<span class="sd">                Users submitting jobs must have act-as permission on this run-as account.</span>
<span class="sd">            network (str):</span>
<span class="sd">                The full name of the Compute Engine network to which the job</span>
<span class="sd">                should be peered. For example, projects/12345/global/networks/myVPC.</span>
<span class="sd">                Private services access must already be configured for the network.</span>
<span class="sd">                If left unspecified, the job is not peered with any network.</span>
<span class="sd">            bigquery_destination (str):</span>
<span class="sd">                Provide this field if `dataset` is a BiqQuery dataset.</span>
<span class="sd">                The BigQuery project location where the training data is to</span>
<span class="sd">                be written to. In the given project a new dataset is created</span>
<span class="sd">                with name</span>
<span class="sd">                ``dataset_&lt;dataset-id&gt;_&lt;annotation-type&gt;_&lt;timestamp-of-training-call&gt;``</span>
<span class="sd">                where timestamp is in YYYY_MM_DDThh_mm_ss_sssZ format. All</span>
<span class="sd">                training input data will be written into that dataset. In</span>
<span class="sd">                the dataset three tables will be created, ``training``,</span>
<span class="sd">                ``validation`` and ``test``.</span>

<span class="sd">                -  AIP_DATA_FORMAT = &quot;bigquery&quot;.</span>
<span class="sd">                -  AIP_TRAINING_DATA_URI =&quot;bigquery_destination.dataset_*.training&quot;</span>
<span class="sd">                -  AIP_VALIDATION_DATA_URI = &quot;bigquery_destination.dataset_*.validation&quot;</span>
<span class="sd">                -  AIP_TEST_DATA_URI = &quot;bigquery_destination.dataset_*.test&quot;</span>
<span class="sd">            args (List[Unions[str, int, float]]):</span>
<span class="sd">                Command line arguments to be passed to the Python script.</span>
<span class="sd">            environment_variables (Dict[str, str]):</span>
<span class="sd">                Environment variables to be passed to the container.</span>
<span class="sd">                Should be a dictionary where keys are environment variable names</span>
<span class="sd">                and values are environment variable values for those names.</span>
<span class="sd">                At most 10 environment variables can be specified.</span>
<span class="sd">                The Name of the environment variable must be unique.</span>

<span class="sd">                environment_variables = {</span>
<span class="sd">                    &#39;MY_KEY&#39;: &#39;MY_VALUE&#39;</span>
<span class="sd">                }</span>
<span class="sd">            replica_count (int):</span>
<span class="sd">                The number of worker replicas. If replica count = 1 then one chief</span>
<span class="sd">                replica will be provisioned. If replica_count &gt; 1 the remainder will be</span>
<span class="sd">                provisioned as a worker replica pool.</span>
<span class="sd">            machine_type (str):</span>
<span class="sd">                The type of machine to use for training.</span>
<span class="sd">            accelerator_type (str):</span>
<span class="sd">                Hardware accelerator type. One of ACCELERATOR_TYPE_UNSPECIFIED,</span>
<span class="sd">                NVIDIA_TESLA_K80, NVIDIA_TESLA_P100, NVIDIA_TESLA_V100, NVIDIA_TESLA_P4,</span>
<span class="sd">                NVIDIA_TESLA_T4</span>
<span class="sd">            accelerator_count (int):</span>
<span class="sd">                The number of accelerators to attach to a worker replica.</span>
<span class="sd">            training_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to train the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            validation_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to validate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            test_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to evaluate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            predefined_split_column_name (str):</span>
<span class="sd">                Optional. The key is a name of one of the Dataset&#39;s data</span>
<span class="sd">                columns. The value of the key (either the label&#39;s value or</span>
<span class="sd">                value in the column) must be one of {``training``,</span>
<span class="sd">                ``validation``, ``test``}, and it defines to which set the</span>
<span class="sd">                given piece of data is assigned. If for a piece of data the</span>
<span class="sd">                key is not present or has an invalid value, that piece is</span>
<span class="sd">                ignored by the pipeline.</span>

<span class="sd">                Supported only for tabular and time series Datasets.</span>
<span class="sd">            tensorboard (str):</span>
<span class="sd">                Optional. The name of an Vertex AI</span>
<span class="sd">                [Tensorboard][google.cloud.aiplatform.v1beta1.Tensorboard]</span>
<span class="sd">                resource to which this CustomJob will upload Tensorboard</span>
<span class="sd">                logs. Format:</span>
<span class="sd">                ``projects/{project}/locations/{location}/tensorboards/{tensorboard}``</span>

<span class="sd">                The training script should write Tensorboard to following Vertex AI environment</span>
<span class="sd">                variable:</span>

<span class="sd">                AIP_TENSORBOARD_LOG_DIR</span>

<span class="sd">                `service_account` is required with provided `tensorboard`.</span>
<span class="sd">                For more information on configuring your service account please visit:</span>
<span class="sd">                https://cloud.google.com/vertex-ai/docs/experiments/tensorboard-training</span>
<span class="sd">            sync (bool):</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model: The trained Vertex AI Model resource or None if training did not</span>
<span class="sd">                produce an Vertex AI Model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">worker_pool_specs</span><span class="p">,</span> <span class="n">managed_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_and_validate_run</span><span class="p">(</span>
            <span class="n">model_display_name</span><span class="o">=</span><span class="n">model_display_name</span><span class="p">,</span>
            <span class="n">replica_count</span><span class="o">=</span><span class="n">replica_count</span><span class="p">,</span>
            <span class="n">machine_type</span><span class="o">=</span><span class="n">machine_type</span><span class="p">,</span>
            <span class="n">accelerator_count</span><span class="o">=</span><span class="n">accelerator_count</span><span class="p">,</span>
            <span class="n">accelerator_type</span><span class="o">=</span><span class="n">accelerator_type</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">annotation_schema_uri</span><span class="o">=</span><span class="n">annotation_schema_uri</span><span class="p">,</span>
            <span class="n">worker_pool_specs</span><span class="o">=</span><span class="n">worker_pool_specs</span><span class="p">,</span>
            <span class="n">managed_model</span><span class="o">=</span><span class="n">managed_model</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
            <span class="n">environment_variables</span><span class="o">=</span><span class="n">environment_variables</span><span class="p">,</span>
            <span class="n">base_output_dir</span><span class="o">=</span><span class="n">base_output_dir</span><span class="p">,</span>
            <span class="n">service_account</span><span class="o">=</span><span class="n">service_account</span><span class="p">,</span>
            <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
            <span class="n">training_fraction_split</span><span class="o">=</span><span class="n">training_fraction_split</span><span class="p">,</span>
            <span class="n">validation_fraction_split</span><span class="o">=</span><span class="n">validation_fraction_split</span><span class="p">,</span>
            <span class="n">test_fraction_split</span><span class="o">=</span><span class="n">test_fraction_split</span><span class="p">,</span>
            <span class="n">predefined_split_column_name</span><span class="o">=</span><span class="n">predefined_split_column_name</span><span class="p">,</span>
            <span class="n">bigquery_destination</span><span class="o">=</span><span class="n">bigquery_destination</span><span class="p">,</span>
            <span class="n">tensorboard</span><span class="o">=</span><span class="n">tensorboard</span><span class="p">,</span>
            <span class="n">sync</span><span class="o">=</span><span class="n">sync</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@base</span><span class="o">.</span><span class="n">optional_sync</span><span class="p">(</span><span class="n">construct_object_on_arg</span><span class="o">=</span><span class="s2">&quot;managed_model&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Union</span><span class="p">[</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">ImageDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">TabularDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">TextDataset</span><span class="p">,</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">VideoDataset</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">],</span>
        <span class="n">annotation_schema_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">worker_pool_specs</span><span class="p">:</span> <span class="n">worker_spec_utils</span><span class="o">.</span><span class="n">_DistributedTrainingSpec</span><span class="p">,</span>
        <span class="n">managed_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">gca_model</span><span class="o">.</span><span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">environment_variables</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">service_account</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">validation_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">test_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">predefined_split_column_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bigquery_destination</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tensorboard</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Packages local script and launches training_job.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (</span>
<span class="sd">                Union[</span>
<span class="sd">                    datasets.ImageDataset,</span>
<span class="sd">                    datasets.TabularDataset,</span>
<span class="sd">                    datasets.TextDataset,</span>
<span class="sd">                    datasets.VideoDataset,</span>
<span class="sd">                ]</span>
<span class="sd">            ):</span>
<span class="sd">                Vertex AI to fit this training against.</span>
<span class="sd">            annotation_schema_uri (str):</span>
<span class="sd">                Google Cloud Storage URI points to a YAML file describing</span>
<span class="sd">                annotation schema.</span>
<span class="sd">            worker_pools_spec (worker_spec_utils._DistributedTrainingSpec):</span>
<span class="sd">                Worker pools pecs required to run job.</span>
<span class="sd">            managed_model (gca_model.Model):</span>
<span class="sd">                Model proto if this script produces a Managed Model.</span>
<span class="sd">            args (List[Unions[str, int, float]]):</span>
<span class="sd">                Command line arguments to be passed to the Python script.</span>
<span class="sd">            environment_variables (Dict[str, str]):</span>
<span class="sd">                Environment variables to be passed to the container.</span>
<span class="sd">                Should be a dictionary where keys are environment variable names</span>
<span class="sd">                and values are environment variable values for those names.</span>
<span class="sd">                At most 10 environment variables can be specified.</span>
<span class="sd">                The Name of the environment variable must be unique.</span>

<span class="sd">                environment_variables = {</span>
<span class="sd">                    &#39;MY_KEY&#39;: &#39;MY_VALUE&#39;</span>
<span class="sd">                }</span>
<span class="sd">            base_output_dir (str):</span>
<span class="sd">                GCS output directory of job. If not provided a</span>
<span class="sd">                timestamped directory in the staging directory will be used.</span>

<span class="sd">                Vertex AI sets the following environment variables when it runs your training code:</span>

<span class="sd">                -  AIP_MODEL_DIR: a Cloud Storage URI of a directory intended for saving model artifacts, i.e. &lt;base_output_dir&gt;/model/</span>
<span class="sd">                -  AIP_CHECKPOINT_DIR: a Cloud Storage URI of a directory intended for saving checkpoints, i.e. &lt;base_output_dir&gt;/checkpoints/</span>
<span class="sd">                -  AIP_TENSORBOARD_LOG_DIR: a Cloud Storage URI of a directory intended for saving TensorBoard logs, i.e. &lt;base_output_dir&gt;/logs/</span>

<span class="sd">            service_account (str):</span>
<span class="sd">                Specifies the service account for workload run-as account.</span>
<span class="sd">                Users submitting jobs must have act-as permission on this run-as account.</span>
<span class="sd">            network (str):</span>
<span class="sd">                The full name of the Compute Engine network to which the job</span>
<span class="sd">                should be peered. For example, projects/12345/global/networks/myVPC.</span>
<span class="sd">                Private services access must already be configured for the network.</span>
<span class="sd">                If left unspecified, the job is not peered with any network.</span>
<span class="sd">            training_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to train the Model.</span>
<span class="sd">            validation_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to validate the Model.</span>
<span class="sd">            test_fraction_split (float):</span>
<span class="sd">                The fraction of the input data that is to be</span>
<span class="sd">                used to evaluate the Model.</span>
<span class="sd">            predefined_split_column_name (str):</span>
<span class="sd">                Optional. The key is a name of one of the Dataset&#39;s data</span>
<span class="sd">                columns. The value of the key (either the label&#39;s value or</span>
<span class="sd">                value in the column) must be one of {``training``,</span>
<span class="sd">                ``validation``, ``test``}, and it defines to which set the</span>
<span class="sd">                given piece of data is assigned. If for a piece of data the</span>
<span class="sd">                key is not present or has an invalid value, that piece is</span>
<span class="sd">                ignored by the pipeline.</span>

<span class="sd">                Supported only for tabular and time series Datasets.</span>
<span class="sd">            tensorboard (str):</span>
<span class="sd">                Optional. The name of an Vertex AI</span>
<span class="sd">                [Tensorboard][google.cloud.aiplatform.v1beta1.Tensorboard]</span>
<span class="sd">                resource to which this CustomJob will upload Tensorboard</span>
<span class="sd">                logs. Format:</span>
<span class="sd">                ``projects/{project}/locations/{location}/tensorboards/{tensorboard}``</span>

<span class="sd">                The training script should write Tensorboard to following Vertex AI environment</span>
<span class="sd">                variable:</span>

<span class="sd">                AIP_TENSORBOARD_LOG_DIR</span>

<span class="sd">                `service_account` is required with provided `tensorboard`.</span>
<span class="sd">                For more information on configuring your service account please visit:</span>
<span class="sd">                https://cloud.google.com/vertex-ai/docs/experiments/tensorboard-training</span>
<span class="sd">            sync (bool):</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model: The trained Vertex AI Model resource or None if training did not</span>
<span class="sd">                produce an Vertex AI Model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">worker_pool_specs</span><span class="p">:</span>
            <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;python_package_spec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;executor_image_uri&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_container_uri</span><span class="p">,</span>
                <span class="s2">&quot;python_module&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_python_module</span><span class="p">,</span>
                <span class="s2">&quot;package_uris&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_package_gcs_uri</span><span class="p">],</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;python_package_spec&quot;</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>

            <span class="k">if</span> <span class="n">environment_variables</span><span class="p">:</span>
                <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;python_package_spec&quot;</span><span class="p">][</span><span class="s2">&quot;env&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">environment_variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">]</span>

        <span class="p">(</span>
            <span class="n">training_task_inputs</span><span class="p">,</span>
            <span class="n">base_output_dir</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_training_task_inputs_and_output_dir</span><span class="p">(</span>
            <span class="n">worker_pool_specs</span><span class="o">=</span><span class="n">worker_pool_specs</span><span class="p">,</span>
            <span class="n">base_output_dir</span><span class="o">=</span><span class="n">base_output_dir</span><span class="p">,</span>
            <span class="n">service_account</span><span class="o">=</span><span class="n">service_account</span><span class="p">,</span>
            <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
            <span class="n">tensorboard</span><span class="o">=</span><span class="n">tensorboard</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span>
            <span class="n">training_task_definition</span><span class="o">=</span><span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">custom_task</span><span class="p">,</span>
            <span class="n">training_task_inputs</span><span class="o">=</span><span class="n">training_task_inputs</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">annotation_schema_uri</span><span class="o">=</span><span class="n">annotation_schema_uri</span><span class="p">,</span>
            <span class="n">training_fraction_split</span><span class="o">=</span><span class="n">training_fraction_split</span><span class="p">,</span>
            <span class="n">validation_fraction_split</span><span class="o">=</span><span class="n">validation_fraction_split</span><span class="p">,</span>
            <span class="n">test_fraction_split</span><span class="o">=</span><span class="n">test_fraction_split</span><span class="p">,</span>
            <span class="n">predefined_split_column_name</span><span class="o">=</span><span class="n">predefined_split_column_name</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">managed_model</span><span class="p">,</span>
            <span class="n">gcs_destination_uri_prefix</span><span class="o">=</span><span class="n">base_output_dir</span><span class="p">,</span>
            <span class="n">bigquery_destination</span><span class="o">=</span><span class="n">bigquery_destination</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="AutoMLVideoTrainingJob"><a class="viewcode-back" href="../../../../aiplatform.html#google.cloud.aiplatform.AutoMLVideoTrainingJob">[docs]</a><span class="k">class</span> <span class="nc">AutoMLVideoTrainingJob</span><span class="p">(</span><span class="n">_TrainingJob</span><span class="p">):</span>

    <span class="n">_supported_training_schemas</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">automl_video_classification</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">automl_video_object_tracking</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">automl_video_action_recognition</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">display_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">prediction_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;classification&quot;</span><span class="p">,</span>
        <span class="n">model_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CLOUD&quot;</span><span class="p">,</span>
        <span class="n">project</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">location</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">auth_credentials</span><span class="o">.</span><span class="n">Credentials</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs a AutoML Video Training Job.</span>

<span class="sd">        Args:</span>
<span class="sd">            display_name (str):</span>
<span class="sd">                Required. The user-defined name of this TrainingPipeline.</span>
<span class="sd">            prediction_type (str):</span>
<span class="sd">                The type of prediction the Model is to produce, one of:</span>
<span class="sd">                    &quot;classification&quot; - A video classification model classifies shots</span>
<span class="sd">                        and segments in your videos according to your own defined labels.</span>
<span class="sd">                    &quot;object_tracking&quot; - A video object tracking model detects and tracks</span>
<span class="sd">                        multiple objects in shots and segments. You can use these</span>
<span class="sd">                        models to track objects in your videos according to your</span>
<span class="sd">                        own pre-defined, custom labels.</span>
<span class="sd">                    &quot;action_recognition&quot; - A video action reconition model pinpoints</span>
<span class="sd">                        the location of actions with short temporal durations (~1 second).</span>
<span class="sd">            model_type: str = &quot;CLOUD&quot;</span>
<span class="sd">                Required. One of the following:</span>
<span class="sd">                    &quot;CLOUD&quot; - available for &quot;classification&quot;, &quot;object_tracking&quot; and &quot;action_recognition&quot;</span>
<span class="sd">                        A Model best tailored to be used within Google Cloud,</span>
<span class="sd">                        and which cannot be exported.</span>
<span class="sd">                    &quot;MOBILE_VERSATILE_1&quot; - available for &quot;classification&quot;, &quot;object_tracking&quot; and &quot;action_recognition&quot;</span>
<span class="sd">                        A model that, in addition to being available within Google</span>
<span class="sd">                        Cloud, can also be exported (see ModelService.ExportModel)</span>
<span class="sd">                        as a TensorFlow or TensorFlow Lite model and used on a</span>
<span class="sd">                        mobile or edge device with afterwards.</span>
<span class="sd">                    &quot;MOBILE_CORAL_VERSATILE_1&quot; - available only for &quot;object_tracking&quot;</span>
<span class="sd">                        A versatile model that is meant to be exported (see</span>
<span class="sd">                        ModelService.ExportModel) and used on a Google Coral device.</span>
<span class="sd">                    &quot;MOBILE_CORAL_LOW_LATENCY_1&quot; - available only for &quot;object_tracking&quot;</span>
<span class="sd">                        A model that trades off quality for low latency, to be</span>
<span class="sd">                        exported (see ModelService.ExportModel) and used on a</span>
<span class="sd">                        Google Coral device.</span>
<span class="sd">                    &quot;MOBILE_JETSON_VERSATILE_1&quot; - available only for &quot;object_tracking&quot;</span>
<span class="sd">                        A versatile model that is meant to be exported (see</span>
<span class="sd">                        ModelService.ExportModel) and used on an NVIDIA Jetson device.</span>
<span class="sd">                    &quot;MOBILE_JETSON_LOW_LATENCY_1&quot; - available only for &quot;object_tracking&quot;</span>
<span class="sd">                        A model that trades off quality for low latency, to be</span>
<span class="sd">                        exported (see ModelService.ExportModel) and used on an</span>
<span class="sd">                        NVIDIA Jetson device.</span>
<span class="sd">            project (str):</span>
<span class="sd">                Optional. Project to run training in. Overrides project set in aiplatform.init.</span>
<span class="sd">            location (str):</span>
<span class="sd">                Optional. Location to run training in. Overrides location set in aiplatform.init.</span>
<span class="sd">            credentials (auth_credentials.Credentials):</span>
<span class="sd">                Optional. Custom credentials to use to run call training service. Overrides</span>
<span class="sd">                credentials set in aiplatform.init.</span>
<span class="sd">            training_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the training pipeline. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, this TrainingPipeline will be secured by this key.</span>

<span class="sd">                Note: Model trained by this TrainingPipeline is also secured</span>
<span class="sd">                by this key if ``model_to_upload`` is not set separately.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">            model_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the model. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, the trained Model will be secured by this key.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: When an invalid prediction_type and/or model_type is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_model_types</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">AUTOML_VIDEO_PREDICTION_MODEL_TYPES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">prediction_type</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_model_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">prediction_type</span><span class="si">}</span><span class="s2">&#39; is not a supported prediction type for AutoML Video Training. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please choose one of: </span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">AUTOML_VIDEO_PREDICTION_MODEL_TYPES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">model_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_model_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&#39; is not a supported model_type for prediction_type of &#39;</span><span class="si">{</span><span class="n">prediction_type</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please choose one of: </span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">valid_model_types</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span>
            <span class="n">training_encryption_spec_key_name</span><span class="o">=</span><span class="n">training_encryption_spec_key_name</span><span class="p">,</span>
            <span class="n">model_encryption_spec_key_name</span><span class="o">=</span><span class="n">model_encryption_spec_key_name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span> <span class="o">=</span> <span class="n">model_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prediction_type</span> <span class="o">=</span> <span class="n">prediction_type</span>

<div class="viewcode-block" id="AutoMLVideoTrainingJob.run"><a class="viewcode-back" href="../../../../aiplatform.html#google.cloud.aiplatform.AutoMLVideoTrainingJob.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">VideoDataset</span><span class="p">,</span>
        <span class="n">training_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">test_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">model_display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sync</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Runs the AutoML Image training job and returns a model.</span>

<span class="sd">        Data fraction splits:</span>
<span class="sd">        ``training_fraction_split``, and ``test_fraction_split`` may optionally</span>
<span class="sd">        be provided, they must sum to up to 1. If none of the fractions are set,</span>
<span class="sd">        by default roughly 80% of data will be used for training, and 20% for test.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (datasets.VideoDataset):</span>
<span class="sd">                Required. The dataset within the same Project from which data will be used to train the Model. The</span>
<span class="sd">                Dataset must use schema compatible with Model being trained,</span>
<span class="sd">                and what is compatible should be described in the used</span>
<span class="sd">                TrainingPipeline&#39;s [training_task_definition]</span>
<span class="sd">                [google.cloud.aiplatform.v1beta1.TrainingPipeline.training_task_definition].</span>
<span class="sd">                For tabular Datasets, all their data is exported to</span>
<span class="sd">                training, to pick and choose from.</span>
<span class="sd">            training_fraction_split: float = 0.8</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to train the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            test_fraction_split: float = 0.2</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to evaluate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            model_display_name (str):</span>
<span class="sd">                Optional. The display name of the managed Vertex AI Model. The name</span>
<span class="sd">                can be up to 128 characters long and can be consist of any UTF-8</span>
<span class="sd">                characters. If not provided upon creation, the job&#39;s display_name is used.</span>
<span class="sd">            sync: bool = True</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>
<span class="sd">        Returns:</span>
<span class="sd">            model: The trained Vertex AI Model resource or None if training did not</span>
<span class="sd">                produce an Vertex AI Model.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If Training job has already been run or is waiting to run.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_waiting_to_run</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AutoML Video Training is already scheduled to run.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_run</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AutoML Video Training has already run.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">training_fraction_split</span><span class="o">=</span><span class="n">training_fraction_split</span><span class="p">,</span>
            <span class="n">test_fraction_split</span><span class="o">=</span><span class="n">test_fraction_split</span><span class="p">,</span>
            <span class="n">model_display_name</span><span class="o">=</span><span class="n">model_display_name</span><span class="p">,</span>
            <span class="n">sync</span><span class="o">=</span><span class="n">sync</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@base</span><span class="o">.</span><span class="n">optional_sync</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">VideoDataset</span><span class="p">,</span>
        <span class="n">training_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">test_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">model_display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sync</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Runs the training job and returns a model.</span>

<span class="sd">        Data fraction splits:</span>
<span class="sd">        Any of ``training_fraction_split``, and ``test_fraction_split`` may optionally</span>
<span class="sd">        be provided, they must sum to up to 1. If none of the fractions are set,</span>
<span class="sd">        by default roughly 80% of data will be used for training, and 20% for test.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (datasets.VideoDataset):</span>
<span class="sd">                Required. The dataset within the same Project from which data will be used to train the Model. The</span>
<span class="sd">                Dataset must use schema compatible with Model being trained,</span>
<span class="sd">                and what is compatible should be described in the used</span>
<span class="sd">                TrainingPipeline&#39;s [training_task_definition]</span>
<span class="sd">                [google.cloud.aiplatform.v1beta1.TrainingPipeline.training_task_definition].</span>
<span class="sd">                For tabular Datasets, all their data is exported to</span>
<span class="sd">                training, to pick and choose from.</span>
<span class="sd">            training_fraction_split (float):</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to train the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            test_fraction_split (float):</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to evaluate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            model_display_name (str):</span>
<span class="sd">                Optional. The display name of the managed Vertex AI Model. The name</span>
<span class="sd">                can be up to 128 characters long and can be consist of any UTF-8</span>
<span class="sd">                characters. If a `base_model` was provided, the display_name in the</span>
<span class="sd">                base_model will be overritten with this value. If not provided upon</span>
<span class="sd">                creation, the job&#39;s display_name is used.</span>
<span class="sd">            sync (bool):</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model: The trained Vertex AI Model resource or None if training did not</span>
<span class="sd">                produce an Vertex AI Model.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Retrieve the objective-specific training task schema based on prediction_type</span>
        <span class="n">training_task_definition</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;automl_video_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_prediction_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">training_task_inputs_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;modelType&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># gca Model to be trained</span>
        <span class="n">model_tbt</span> <span class="o">=</span> <span class="n">gca_model</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">encryption_spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_encryption_spec</span><span class="p">)</span>
        <span class="n">model_tbt</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">model_display_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_name</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span>
            <span class="n">training_task_definition</span><span class="o">=</span><span class="n">training_task_definition</span><span class="p">,</span>
            <span class="n">training_task_inputs</span><span class="o">=</span><span class="n">training_task_inputs_dict</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">training_fraction_split</span><span class="o">=</span><span class="n">training_fraction_split</span><span class="p">,</span>
            <span class="n">validation_fraction_split</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">test_fraction_split</span><span class="o">=</span><span class="n">test_fraction_split</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model_tbt</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_model_upload_fail_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Helper property for model upload failure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;AutoML Video Training Pipeline </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_name</span><span class="si">}</span><span class="s2"> is not &quot;</span>
            <span class="s2">&quot;configured to upload a Model.&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AutoMLTextTrainingJob"><a class="viewcode-back" href="../../../../aiplatform.html#google.cloud.aiplatform.AutoMLTextTrainingJob">[docs]</a><span class="k">class</span> <span class="nc">AutoMLTextTrainingJob</span><span class="p">(</span><span class="n">_TrainingJob</span><span class="p">):</span>
    <span class="n">_supported_training_schemas</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">automl_text_classification</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">automl_text_extraction</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">automl_text_sentiment</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">display_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">prediction_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">multi_label</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">sentiment_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">project</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">location</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">auth_credentials</span><span class="o">.</span><span class="n">Credentials</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_encryption_spec_key_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs a AutoML Text Training Job.</span>

<span class="sd">        Args:</span>
<span class="sd">            display_name (str):</span>
<span class="sd">                Required. The user-defined name of this TrainingPipeline.</span>
<span class="sd">            prediction_type (str):</span>
<span class="sd">                The type of prediction the Model is to produce, one of:</span>
<span class="sd">                    &quot;classification&quot; - A classification model analyzes text data and</span>
<span class="sd">                        returns a list of categories that apply to the text found in the data.</span>
<span class="sd">                        Vertex AI offers both single-label and multi-label text classification models.</span>
<span class="sd">                    &quot;extraction&quot; - An entity extraction model inspects text data</span>
<span class="sd">                        for known entities referenced in the data and</span>
<span class="sd">                        labels those entities in the text.</span>
<span class="sd">                    &quot;sentiment&quot; - A sentiment analysis model inspects text data and identifies the</span>
<span class="sd">                        prevailing emotional opinion within it, especially to determine a writer&#39;s attitude</span>
<span class="sd">                        as positive, negative, or neutral.</span>
<span class="sd">            multi_label (bool):</span>
<span class="sd">                Required and only applicable for text classification task. If false, a single-label (multi-class) Model will be trained (i.e.</span>
<span class="sd">                assuming that for each text snippet just up to one annotation may be</span>
<span class="sd">                applicable). If true, a multi-label Model will be trained (i.e.</span>
<span class="sd">                assuming that for each text snippet multiple annotations may be</span>
<span class="sd">                applicable).</span>
<span class="sd">            sentiment_max (int):</span>
<span class="sd">                Required and only applicable for sentiment task. A sentiment is expressed as an integer</span>
<span class="sd">                ordinal, where higher value means a more</span>
<span class="sd">                positive sentiment. The range of sentiments that</span>
<span class="sd">                will be used is between 0 and sentimentMax</span>
<span class="sd">                (inclusive on both ends), and all the values in</span>
<span class="sd">                the range must be represented in the dataset</span>
<span class="sd">                before a model can be created.</span>
<span class="sd">                Only the Annotations with this sentimentMax will</span>
<span class="sd">                be used for training. sentimentMax value must be</span>
<span class="sd">                between 1 and 10 (inclusive).</span>
<span class="sd">            project (str):</span>
<span class="sd">                Optional. Project to run training in. Overrides project set in aiplatform.init.</span>
<span class="sd">            location (str):</span>
<span class="sd">                Optional. Location to run training in. Overrides location set in aiplatform.init.</span>
<span class="sd">            credentials (auth_credentials.Credentials):</span>
<span class="sd">                Optional. Custom credentials to use to run call training service. Overrides</span>
<span class="sd">                credentials set in aiplatform.init.</span>
<span class="sd">            training_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the training pipeline. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, this TrainingPipeline will be secured by this key.</span>

<span class="sd">                Note: Model trained by this TrainingPipeline is also secured</span>
<span class="sd">                by this key if ``model_to_upload`` is not set separately.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">            model_encryption_spec_key_name (Optional[str]):</span>
<span class="sd">                Optional. The Cloud KMS resource identifier of the customer</span>
<span class="sd">                managed encryption key used to protect the model. Has the</span>
<span class="sd">                form:</span>
<span class="sd">                ``projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key``.</span>
<span class="sd">                The key needs to be in the same region as where the compute</span>
<span class="sd">                resource is created.</span>

<span class="sd">                If set, the trained Model will be secured by this key.</span>

<span class="sd">                Overrides encryption_spec_key_name set in aiplatform.init.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span>
            <span class="n">training_encryption_spec_key_name</span><span class="o">=</span><span class="n">training_encryption_spec_key_name</span><span class="p">,</span>
            <span class="n">model_encryption_spec_key_name</span><span class="o">=</span><span class="n">model_encryption_spec_key_name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">training_task_definition</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">training_task_inputs_dict</span><span class="p">:</span> <span class="n">proto</span><span class="o">.</span><span class="n">Message</span>

        <span class="k">if</span> <span class="n">prediction_type</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span><span class="p">:</span>
            <span class="n">training_task_definition</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">automl_text_classification</span>
            <span class="p">)</span>

            <span class="n">training_task_inputs_dict</span> <span class="o">=</span> <span class="n">training_job_inputs</span><span class="o">.</span><span class="n">AutoMlTextClassificationInputs</span><span class="p">(</span>
                <span class="n">multi_label</span><span class="o">=</span><span class="n">multi_label</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">prediction_type</span> <span class="o">==</span> <span class="s2">&quot;extraction&quot;</span><span class="p">:</span>
            <span class="n">training_task_definition</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">automl_text_extraction</span>
            <span class="p">)</span>

            <span class="n">training_task_inputs_dict</span> <span class="o">=</span> <span class="n">training_job_inputs</span><span class="o">.</span><span class="n">AutoMlTextExtractionInputs</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">prediction_type</span> <span class="o">==</span> <span class="s2">&quot;sentiment&quot;</span><span class="p">:</span>
            <span class="n">training_task_definition</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">schema</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">automl_text_sentiment</span>
            <span class="p">)</span>

            <span class="n">training_task_inputs_dict</span> <span class="o">=</span> <span class="n">training_job_inputs</span><span class="o">.</span><span class="n">AutoMlTextSentimentInputs</span><span class="p">(</span>
                <span class="n">sentiment_max</span><span class="o">=</span><span class="n">sentiment_max</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Prediction type must be one of &#39;classification&#39;, &#39;extraction&#39;, or &#39;sentiment&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_training_task_definition</span> <span class="o">=</span> <span class="n">training_task_definition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_training_task_inputs_dict</span> <span class="o">=</span> <span class="n">training_task_inputs_dict</span>

<div class="viewcode-block" id="AutoMLTextTrainingJob.run"><a class="viewcode-back" href="../../../../aiplatform.html#google.cloud.aiplatform.AutoMLTextTrainingJob.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">TextDataset</span><span class="p">,</span>
        <span class="n">training_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">validation_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">test_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">model_display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sync</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Runs the training job and returns a model.</span>

<span class="sd">        Data fraction splits:</span>
<span class="sd">        Any of ``training_fraction_split``, ``validation_fraction_split`` and</span>
<span class="sd">        ``test_fraction_split`` may optionally be provided, they must sum to up to 1. If</span>
<span class="sd">        the provided ones sum to less than 1, the remainder is assigned to sets as</span>
<span class="sd">        decided by Vertex AI. If none of the fractions are set, by default roughly 80%</span>
<span class="sd">        of data will be used for training, 10% for validation, and 10% for test.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (datasets.TextDataset):</span>
<span class="sd">                Required. The dataset within the same Project from which data will be used to train the Model. The</span>
<span class="sd">                Dataset must use schema compatible with Model being trained,</span>
<span class="sd">                and what is compatible should be described in the used</span>
<span class="sd">                TrainingPipeline&#39;s [training_task_definition]</span>
<span class="sd">                [google.cloud.aiplatform.v1beta1.TrainingPipeline.training_task_definition].</span>
<span class="sd">            training_fraction_split: float = 0.8</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to train the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            validation_fraction_split: float = 0.1</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to validate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            test_fraction_split: float = 0.1</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to evaluate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            model_display_name (str):</span>
<span class="sd">                Optional. The display name of the managed Vertex AI Model.</span>
<span class="sd">                The name can be up to 128 characters long and can consist</span>
<span class="sd">                of any UTF-8 characters.</span>

<span class="sd">                If not provided upon creation, the job&#39;s display_name is used.</span>
<span class="sd">            sync (bool):</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>
<span class="sd">        Returns:</span>
<span class="sd">            model: The trained Vertex AI Model resource.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If Training job has already been run or is waiting to run.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_waiting_to_run</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AutoML Text Training is already scheduled to run.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_run</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AutoML Text Training has already run.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">training_fraction_split</span><span class="o">=</span><span class="n">training_fraction_split</span><span class="p">,</span>
            <span class="n">validation_fraction_split</span><span class="o">=</span><span class="n">validation_fraction_split</span><span class="p">,</span>
            <span class="n">test_fraction_split</span><span class="o">=</span><span class="n">test_fraction_split</span><span class="p">,</span>
            <span class="n">model_display_name</span><span class="o">=</span><span class="n">model_display_name</span><span class="p">,</span>
            <span class="n">sync</span><span class="o">=</span><span class="n">sync</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@base</span><span class="o">.</span><span class="n">optional_sync</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">TextDataset</span><span class="p">,</span>
        <span class="n">training_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">validation_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">test_fraction_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">model_display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sync</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Runs the training job and returns a model.</span>

<span class="sd">        Data fraction splits:</span>
<span class="sd">        Any of ``training_fraction_split``, ``validation_fraction_split`` and</span>
<span class="sd">        ``test_fraction_split`` may optionally be provided, they must sum to up to 1. If</span>
<span class="sd">        the provided ones sum to less than 1, the remainder is assigned to sets as</span>
<span class="sd">        decided by Vertex AI. If none of the fractions are set, by default roughly 80%</span>
<span class="sd">        of data will be used for training, 10% for validation, and 10% for test.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (datasets.TextDataset):</span>
<span class="sd">                Required. The dataset within the same Project from which data will be used to train the Model. The</span>
<span class="sd">                Dataset must use schema compatible with Model being trained,</span>
<span class="sd">                and what is compatible should be described in the used</span>
<span class="sd">                TrainingPipeline&#39;s [training_task_definition]</span>
<span class="sd">                [google.cloud.aiplatform.v1beta1.TrainingPipeline.training_task_definition].</span>
<span class="sd">                For Text Datasets, all their data is exported to</span>
<span class="sd">                training, to pick and choose from.</span>
<span class="sd">            training_fraction_split (float):</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to train the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            validation_fraction_split (float):</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to validate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            test_fraction_split (float):</span>
<span class="sd">                Required. The fraction of the input data that is to be</span>
<span class="sd">                used to evaluate the Model. This is ignored if Dataset is not provided.</span>
<span class="sd">            model_display_name (str):</span>
<span class="sd">                Optional. If the script produces a managed Vertex AI Model. The display name of</span>
<span class="sd">                the Model. The name can be up to 128 characters long and can be consist</span>
<span class="sd">                of any UTF-8 characters.</span>

<span class="sd">                If not provided upon creation, the job&#39;s display_name is used.</span>
<span class="sd">            sync (bool):</span>
<span class="sd">                Whether to execute this method synchronously. If False, this method</span>
<span class="sd">                will be executed in concurrent Future and any downstream object will</span>
<span class="sd">                be immediately returned and synced when the Future has completed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model: The trained Vertex AI Model resource or None if training did not</span>
<span class="sd">                produce an Vertex AI Model.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">model_display_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_display_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_name</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">gca_model</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
            <span class="n">display_name</span><span class="o">=</span><span class="n">model_display_name</span><span class="p">,</span>
            <span class="n">encryption_spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_encryption_spec</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span>
            <span class="n">training_task_definition</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_training_task_definition</span><span class="p">,</span>
            <span class="n">training_task_inputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_training_task_inputs_dict</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">training_fraction_split</span><span class="o">=</span><span class="n">training_fraction_split</span><span class="p">,</span>
            <span class="n">validation_fraction_split</span><span class="o">=</span><span class="n">validation_fraction_split</span><span class="p">,</span>
            <span class="n">test_fraction_split</span><span class="o">=</span><span class="n">test_fraction_split</span><span class="p">,</span>
            <span class="n">predefined_split_column_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_model_upload_fail_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Helper property for model upload failure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;AutoML Text Training Pipeline </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_name</span><span class="si">}</span><span class="s2"> is not &quot;</span>
            <span class="s2">&quot;configured to upload a Model.&quot;</span>
        <span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">google-cloud-aiplatform</a></h1>



<p class="blurb">Google Cloud Client Libraries for google-cloud-aiplatform</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=googleapis&repo=python-aiplatform&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../aiplatform.html">Google Cloud Aiplatform SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../aiplatform_v1/services.html">Services for Google Cloud Aiplatform v1 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../aiplatform_v1/types.html">Types for Google Cloud Aiplatform v1 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../aiplatform_v1beta1/services.html">Services for Google Cloud Aiplatform v1beta1 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../aiplatform_v1beta1/types.html">Types for Google Cloud Aiplatform v1beta1 API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog.html">Changelog</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Google.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/googleapis/python-aiplatform" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>